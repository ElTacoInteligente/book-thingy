<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Thingy - Desktop</title>
    <!-- Version: 2.1 - Fixed Auth Flow -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #22d3ee;
            --background: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --text: #f1f5f9;
            --text-dim: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.3);
        }

        /* Light theme variables */
:root.light-theme {
    --primary: #5b21b6;
    --primary-dark: #4c1d95;
    --secondary: #0891b2;
    --background: #f8fafc;
    --surface: #ffffff;
    --surface-light: #e2e8f0;
    --text: #1e293b;
    --text-dim: #64748b;
    --success: #059669;
    --warning: #d97706;
    --danger: #dc2626;
}

/* Light theme specific adjustments */
.light-theme .header {
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.98) 0%, 
        rgba(248, 250, 252, 0.95) 50%,
        rgba(241, 245, 249, 0.9) 100%);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.light-theme .bottom-nav {
    background: linear-gradient(180deg, 
        rgba(255, 255, 255, 0.95) 0%, 
        rgba(248, 250, 252, 0.98) 100%);
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
}

.light-theme .book-card {
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.light-theme .modal-content {
    background: white;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
}

.light-theme .book-status {
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.light-theme .toast {
    background: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* Light theme text fixes */
.light-theme .btn {
    color: white; /* Keep white text for primary buttons */
}

.light-theme .btn-secondary {
    color: var(--text); /* Dark text for secondary buttons */
    background: var(--surface-light);
}

.light-theme .form-label {
    color: var(--text);
}

.light-theme .form-input,
.light-theme .form-select,
.light-theme .form-textarea {
    color: var(--text);
    background: var(--surface-light);
    border-color: #cbd5e1;
}

.light-theme .modal-header {
    color: var(--text);
}

.light-theme .modal-title {
    color: var(--text);
}

.light-theme h3 {
    color: var(--primary);
}

.light-theme span,
.light-theme p,
.light-theme label {
    color: var(--text);
}

.light-theme .empty-state .empty-text {
    color: var(--text-dim);
}

.light-theme .sort-chip {
    color: var(--text);
    background: var(--surface-light);
    border-color: #cbd5e1;
}

.light-theme .sort-chip.active {
    color: white; /* Keep white text on active purple chips */
}

.light-theme input[type="radio"],
.light-theme input[type="checkbox"] {
    accent-color: var(--primary);
}

/* Fix the specific buttons in settings modal */
.light-theme .btn[style*="background: var(--danger)"] {
    color: white !important;
}

/* Ensure header text is visible */
.light-theme #userEmail {
    color: var(--text-dim) !important;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--background);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -webkit-user-select: none;
    user-select: none;
    line-height: 1.6;
}

        /* App Container */
        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 70px;
        }

        /* Header */
        .header {
            background: var(--surface);
            padding: 1rem;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            -webkit-app-region: drag;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

.logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: -0.02em;
}

.logo span:last-child {
    color: var(--text);
    text-shadow: 0 2px 10px rgba(167, 139, 250, 0.3);
}

.logo span:first-child {
    font-size: 1.75rem;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
}

        .storage-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-dim);
            -webkit-app-region: no-drag;
        }

        .storage-badge {
            background: var(--surface-light);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* Views */
        .view {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view.active {
            display: block;
        }

        /* Disable animation for notebook view to prevent positioning glitch */
        #notebookView {
            animation: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Search Bar */
        .search-section {
            margin-bottom: 1.5rem;
        }

        .search-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .search-input {
            flex: 1;
            background: var(--surface);
            border: 2px solid var(--surface-light);
            color: var(--text);
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            font-size: 1rem;
            transition: all 0.3s;
            -webkit-user-select: text;
            user-select: text;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
.search-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

/* Fix for modal search input */
#searchModal .search-input {
    position: relative;
    z-index: 1001;
}

#searchModal .modal-content {
    z-index: 1002;
}

/* Ensure modal inputs are always interactive */
.modal.active input,
.modal.active button,
.modal.active textarea {
    pointer-events: auto !important;
}
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--surface-light);
        }

        .btn-secondary:hover {
            background: var(--surface);
        }

        /* Sort Options */
        .sort-section {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            -webkit-overflow-scrolling: touch;
        }

        .sort-chip {
            background: var(--surface);
            color: var(--text-dim);
            border: 2px solid var(--surface-light);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .sort-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Book Grid */
.book-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); /* Changed from 150px to 180px */
    gap: 1rem;
    margin-bottom: 2rem;
}

        .book-card {
            background: var(--surface);
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

.book-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.4);
}

.book-card:hover .book-cover {
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
}

.book-cover {
    width: 100%;
    aspect-ratio: 2/3;
    object-fit: cover;
    background: var(--surface-light);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.book-info {
    padding: 1rem; /* Increased from 0.75rem */
}

.book-title {
    font-size: 0.9375rem; /* Slightly larger from 0.875rem */
    font-weight: 600;
    margin-bottom: 0.25rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    line-height: 1.4;
}

.book-author {
    font-size: 0.8125rem; /* Slightly larger from 0.75rem */
    color: var(--text-dim);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-bottom: 0.25rem; /* Add margin */
}

.book-genre {
    font-size: 0.75rem;
    color: var(--primary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-bottom: 0.25rem;
}

        .book-status {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
            backdrop-filter: blur(10px);
        }

        .status-reading { background: rgba(34, 211, 238, 0.9); }
        .status-completed { background: rgba(16, 185, 129, 0.9); }
        .status-want-to-read { background: rgba(245, 158, 11, 0.9); }
        .status-abandoned { background: rgba(239, 68, 68, 0.9); }

        .rating-display {
            display: flex;
            gap: 0.25rem;
            font-size: 1rem;
        }

  /* Bulk Selection Styles */
.selection-mode .book-card {
    position: relative;
}

.book-checkbox {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    width: 24px;
    height: 24px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 4px;
    display: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.selection-mode .book-checkbox {
    display: flex;
}

.book-checkbox input {
    width: 18px;
    height: 18px;
    margin: 0;
    cursor: pointer;
}

.book-card.selected {
    outline: 3px solid var(--primary);
    outline-offset: -3px;
}

.bulk-actions-toolbar {
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}      

        /* Book Details Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 2rem 1rem;
        }

        .modal-content {
            background: var(--surface);
            border-radius: var(--radius);
            width: 100%;
            max-width: 600px;
            margin: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: 1px solid var(--surface-light);
        }

.modal-title {
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1.2;
}

        .modal-close {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .modal-close:hover {
            background: var(--surface-light);
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-dim);
        }

        .form-input, .form-select, .form-textarea {
        
            width: 100%;
            background: var(--background);
            border: 2px solid var(--surface-light);
            color: var(--text);
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            font-size: 1rem;
            transition: all 0.3s;
            -webkit-user-select: text;
            user-select: text;
        }

  /* Fix select dropdown arrow position */
.form-select {
    padding-right: 2.5rem; /* Increase right padding */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center; /* Move arrow 1rem from right edge */
    background-size: 12px;
    appearance: none; /* Remove default arrow */
    -webkit-appearance: none;
    -moz-appearance: none;
}

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Rating Stars */
        .rating {
            display: flex;
            gap: 0.25rem;
            font-size: 1.5rem;
        }

        .rating-star {
            cursor: pointer;
            color: var(--surface-light);
            transition: color 0.2s;
        }

        .rating-star.active {
            color: #fbbf24;
        }

        .rating-star:hover {
            color: #fbbf24;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: var(--radius);
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .stat-card.active {
            background: var(--primary);
            color: white;
        }

        .stat-card.active .stat-value {
            color: white;
        }

        .stat-card.active .stat-label {
            color: rgba(255, 255, 255, 0.9);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-dim);
            font-size: 0.875rem;
        }

        /* Book row cards */
        .book-row-container {
            margin-top: 2rem;
            display: none;
        }

        .book-row-container.active {
            display: block;
        }

        .book-row-card {
            display: flex;
            gap: 1.5rem;
            padding: 1rem;
            background: var(--surface);
            border-radius: var(--radius);
            margin-bottom: 1rem;
            transition: all 0.3s;
            cursor: pointer;
        }

        .book-row-card:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow);
        }

        .book-row-card.draggable {
            cursor: grab;
        }

        .book-row-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
            transform: rotate(2deg);
        }

        .book-row-card.drag-over {
            border-top: 3px solid var(--primary);
            margin-top: 1.5rem;
        }

        .drag-handle {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            color: var(--text-dim);
            cursor: grab;
            user-select: none;
        }

        .drag-handle:hover {
            color: var(--primary);
        }

        /* Notebook Layout */
        .notebook-container {
            display: flex;
            height: calc(100vh - 80px);
            background: var(--background);
            margin: 0;
            padding: 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100vw;
            z-index: 50;
            transition: opacity 0.2s ease-in-out;
        }

        .notebook-sidebar {
            width: 300px;
            background: var(--surface);
            border-right: 1px solid var(--surface-light);
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
            padding-top: 80px;
        }

        .notebook-sidebar.collapsed {
            width: 0;
            overflow: hidden;
        }

        .notebook-book-sidebar {
            width: 250px;
            background: var(--surface-light);
            border-right: 1px solid var(--surface-light);
            display: none;
            flex-direction: column;
            transition: all 0.3s;
            padding-top: 80px;
        }

        .notebook-book-sidebar.active {
            display: flex;
        }

        .notebook-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--background);
            padding-top: 80px;
        }

        .notebook-search {
            padding: 1rem;
            border-bottom: 1px solid var(--surface-light);
        }

        .notebook-search input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--surface-light);
            border-radius: 8px;
            background: var(--background);
            color: var(--text);
            font-size: 0.875rem;
        }

        .notebook-book-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .notebook-book-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--background);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .notebook-book-item:hover {
            background: var(--surface-light);
        }

        .notebook-book-item.active {
            background: var(--primary);
            color: white;
        }

        .notebook-book-cover {
            width: 40px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 0.75rem;
            background: var(--surface-light);
        }

        .notebook-book-info {
            flex: 1;
            min-width: 0;
        }

        .notebook-book-title {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .notebook-book-author {
            font-size: 0.75rem;
            color: var(--text-dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .notebook-book-item.active .notebook-book-author {
            color: rgba(255, 255, 255, 0.8);
        }

        .notebook-pages-header {
            padding: 1rem;
            border-bottom: 1px solid var(--surface-light);
            background: var(--surface);
        }

        .notebook-pages-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }

        .notebook-pages-subtitle {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-bottom: 1rem;
        }

        .notebook-add-page {
            width: 100%;
            padding: 0.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            z-index: 1000;
            pointer-events: auto;
        }

        .notebook-add-page:hover {
            background: var(--primary-dark);
        }

        .notebook-pages-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .notebook-page-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--background);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notebook-page-item:hover {
            background: var(--surface);
        }

        .notebook-page-item.active {
            background: var(--primary);
            color: white;
        }

        .notebook-page-name {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .notebook-page-actions {
            display: flex;
            gap: 0.25rem;
        }

        .notebook-page-action {
            padding: 0.25rem;
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            opacity: 0.7;
            transition: all 0.3s;
        }

        .notebook-page-action:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        .notebook-editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .notebook-editor-header {
            padding: 1rem;
            border-bottom: 1px solid var(--surface-light);
            background: var(--surface);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notebook-editor-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .notebook-editor {
            flex: 1;
            padding: 1.5rem;
            background: var(--background);
            overflow-y: auto;
        }

        .notebook-textarea {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            color: var(--text);
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 0.9375rem;
            line-height: 1.6;
            resize: none;
            outline: none;
        }

        .notebook-empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            padding: 2rem;
        }

        .notebook-empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        /* Rich text editor toolbar */
        .notebook-toolbar {
            padding: 0.75rem 1rem;
            background: var(--surface);
            border-bottom: 1px solid var(--surface-light);
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .notebook-toolbar-group {
            display: flex;
            gap: 0.25rem;
            padding-right: 0.75rem;
            border-right: 1px solid var(--surface-light);
        }

        .notebook-toolbar-group:last-child {
            border-right: none;
        }

        .notebook-toolbar-btn {
            padding: 0.5rem;
            background: transparent;
            border: 1px solid var(--surface-light);
            border-radius: 4px;
            color: var(--text);
            cursor: pointer;
            font-size: 0.875rem;
            min-width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .notebook-toolbar-btn:hover {
            background: var(--surface-light);
        }

        .notebook-toolbar-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .notebook-toolbar-select {
            padding: 0.5rem;
            background: var(--background);
            border: 1px solid var(--surface-light);
            border-radius: 4px;
            color: var(--text);
            font-size: 0.875rem;
            min-width: 120px;
        }

        .notebook-rich-editor {
            flex: 1;
            padding: 1.5rem;
            background: white;
            color: #000;
            overflow-y: auto;
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 14px;
            line-height: 1.6;
        }

        .notebook-rich-editor:focus {
            outline: none;
        }

        .notebook-rich-editor h1 {
            font-size: 2rem;
            font-weight: 700;
            margin: 1.5rem 0 1rem 0;
            color: #000;
        }

        .notebook-rich-editor h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 1.25rem 0 0.75rem 0;
            color: #000;
        }

        .notebook-rich-editor h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 1rem 0 0.5rem 0;
            color: #000;
        }

        .notebook-rich-editor p {
            margin: 0.5rem 0;
            color: #000;
        }

        .notebook-rich-editor ul, .notebook-rich-editor ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
            color: #000;
        }

        .notebook-rich-editor blockquote {
            border-left: 4px solid var(--primary);
            padding-left: 1rem;
            margin: 1rem 0;
            font-style: italic;
            color: #555;
        }

        .book-row-thumbnail {
            width: 120px;
            height: 180px;
            object-fit: cover;
            border-radius: 4px;
            flex-shrink: 0;
            background: var(--surface-light);
        }

        .book-row-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .book-row-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
        }

        .book-row-author {
            color: var(--text-dim);
            font-size: 1rem;
        }

        .book-row-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-dim);
        }

        .book-row-summary {
            margin-top: 0.5rem;
            color: var(--text-dim);
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Progress Bar */
        .progress-container {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: var(--radius);
            margin-bottom: 2rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .progress-bar {
            background: var(--surface-light);
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.5rem;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Lending List */
        .lending-list {
            background: var(--surface);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .lending-item {
            padding: 1rem;
            border-bottom: 1px solid var(--surface-light);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .lending-item:last-child {
            border-bottom: none;
        }

        .lending-book-cover {
            width: 50px;
            height: 75px;
            object-fit: cover;
            border-radius: 6px;
            background: var(--surface-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .lending-info {
            flex: 1;
        }

        .lending-borrower {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .lending-date {
            font-size: 0.875rem;
            color: var(--text-dim);
        }

        /* Make lending contact info selectable */
.lending-contact {
    -webkit-user-select: text !important;
    user-select: text !important;
    cursor: text;
}

.lending-borrower {
    -webkit-user-select: text !important;
    user-select: text !important;
    cursor: text;
}

/* Also make the lending info container selectable */
.lending-info {
    -webkit-user-select: text !important;
    user-select: text !important;
}

        .return-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .return-btn:hover {
            background: #059669;
        }

        /* Bottom Navigation */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(180deg, 
        rgba(30, 41, 59, 0.95) 0%, 
        rgba(30, 41, 59, 0.98) 100%);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255, 255, 255, 0.05);
    padding: 0.5rem 0;
    display: flex;
    justify-content: space-around;
    align-items: center;
    z-index: 99;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
}

.nav-item {
    flex: 1;
    text-align: center;
    padding: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.nav-item:hover {
    transform: translateY(-2px);
}

.nav-item.active {
    color: var(--primary);
}

.nav-item.active::before {
    content: '';
    position: absolute;
    top: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 3px;
    background: var(--primary);
    border-radius: 2px;
    box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
}

.nav-icon {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
    transition: all 0.3s ease;
}

.nav-item:hover .nav-icon {
    transform: scale(1.1);
}

.nav-item.active .nav-icon {
    filter: drop-shadow(0 2px 8px rgba(99, 102, 241, 0.4));
}

.nav-label {
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.02em;
}

        /* Floating Action Button */
.fab {
    position: fixed;
    bottom: 100px;
    right: 1.5rem;
            background: var(--primary);
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 99;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
        }

        /* Add Options Menu */
.add-options {
    position: fixed;
    bottom: 170px;
    right: 1.5rem;
            background: var(--surface);
            border-radius: var(--radius);
            padding: 0.5rem;
            box-shadow: var(--shadow);
            display: none;
            z-index: 98;
        }

        .add-options.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

/* Fix button styling for add-option buttons */
.add-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: var(--radius);
    cursor: pointer;
    transition: background 0.3s;
    white-space: nowrap;
    /* Add these to override button defaults */
    border: none;
    background: transparent;
    color: var(--text);
    font-family: inherit;
    font-size: inherit;
    width: 100%;
    text-align: left;
}

        .add-option:hover {
            background: var(--surface-light);
        }

        /* Search Results */
        .search-results {
            max-height: 400px;
            overflow-y: auto;
            background: var(--background);
            border-radius: var(--radius);
            margin-top: 1rem;
        }

        .search-result-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid var(--surface-light);
            cursor: pointer;
            transition: background 0.3s;
        }

        .search-result-item:hover {
            background: var(--surface);
        }

        .search-result-cover {
            width: 60px;
            height: 90px;
            object-fit: cover;
            border-radius: 6px;
            background: var(--surface-light);
        }

        .search-result-info {
            flex: 1;
        }

        .search-result-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .search-result-author {
            font-size: 0.875rem;
            color: var(--text-dim);
        }

/* Empty State */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    max-width: 400px;
    margin: 0 auto;
}

.empty-icon {
    font-size: 5rem;
    margin-bottom: 1.5rem;
    opacity: 0.3;
    filter: grayscale(0.5);
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.empty-text {
    color: var(--text-dim);
    margin-bottom: 1rem;
    font-size: 1.125rem;
    line-height: 1.6;
}

.empty-tips {
    margin-top: 2rem;
    padding: 1.5rem;
    background: var(--surface);
    border-radius: var(--radius);
    text-align: left;
    border: 1px solid var(--surface-light);
}

.empty-tips h4 {
    color: var(--primary);
    margin-bottom: 0.75rem;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.empty-tips ul {
    list-style: none;
    padding: 0;
}

.empty-tips li {
    padding: 0.5rem 0;
    padding-left: 1.5rem;
    position: relative;
    font-size: 0.875rem;
    color: var(--text-dim);
}

.empty-tips li:before {
    content: "→";
    position: absolute;
    left: 0;
    color: var(--primary);
}

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--surface-light);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        /* Loading Overlay */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(15, 23, 42, 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
}

.loading-overlay.active {
    display: flex;
}

.loading-content {
    text-align: center;
    background: var(--surface);
    padding: 2rem;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
}

.loading-spinner {
    border: 4px solid var(--surface-light);
    border-top: 4px solid var(--primary);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem auto;
}

.loading-text {
    color: var(--text);
    font-size: 1rem;
    margin: 0;
}

/* Toast Notifications */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10001;
    pointer-events: none;
}

.toast {
    background: var(--surface);
    border: 2px solid var(--surface-light);
    border-radius: var(--radius);
    padding: 1rem 1.5rem;
    margin-bottom: 0.5rem;
    box-shadow: var(--shadow);
    transform: translateX(400px);
    opacity: 0;
    transition: all 0.3s ease;
    max-width: 400px;
    pointer-events: auto;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.toast.show {
    transform: translateX(0);
    opacity: 1;
}

.toast-icon {
    font-size: 1.25rem;
    flex-shrink: 0;
}

.toast-content {
    flex: 1;
}

.toast-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.toast-message {
    font-size: 0.875rem;
    color: var(--text-dim);
}

.toast-success {
    border-color: var(--success);
}

.toast-success .toast-icon {
    color: var(--success);
}

.toast-error {
    border-color: var(--danger);
}

.toast-error .toast-icon {
    color: var(--danger);
}

.toast-warning {
    border-color: var(--warning);
}

.toast-warning .toast-icon {
    color: var(--warning);
}

.toast-close {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 1.25rem;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.2s;
    flex-shrink: 0;
}

.toast-close:hover {
    background: var(--surface-light);
}

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Save indicator */
.save-indicator {
    position: fixed;
    bottom: 120px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--success);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.875rem;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    z-index: 101;
}

        .save-indicator.show {
            opacity: 1;
        }

        /* Premium Effects */
.book-card {
    background: linear-gradient(145deg, var(--surface) 0%, rgba(30, 41, 59, 0.8) 100%);
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.stat-card {
    background: linear-gradient(145deg, var(--surface) 0%, rgba(30, 41, 59, 0.8) 100%);
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.modal-content {
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.btn {
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
}

.btn:hover {
    box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
}

/* Glassmorphism for modals */
.modal {
    backdrop-filter: blur(10px);
    background: rgba(0,0,0,0.85);
}

/* Better header */
.header {
    background: linear-gradient(135deg, 
        rgba(30, 41, 59, 0.98) 0%, 
        rgba(30, 41, 59, 0.95) 50%,
        rgba(51, 65, 85, 0.9) 100%);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    box-shadow: 0 2px 20px rgba(0, 0, 0, 0.4);
    position: sticky;
    top: 0;
    z-index: 100;
}

/* Loading spinner improvements */
.loading-content {
    background: linear-gradient(145deg, var(--surface) 0%, rgba(30, 41, 59, 0.95) 100%);
    border: 1px solid rgba(255, 255, 255, 0.05);
}

/* Add smooth transitions to all interactive elements */
* {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* Book info text improvements */
.book-info {
    padding: 1rem;
}

.book-title {
    color: var(--text);
}

.book-author {
    font-size: 0.8125rem;
    line-height: 1.4;
}

/* Better focus states */
.form-input:focus, .form-select:focus, .form-textarea:focus {
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
}

/* Subtle animation for book cards on page load */
.book-card {
    animation: fadeInUp 0.4s ease backwards;
}

.book-card:nth-child(n) {
    animation-delay: calc(0.05s * var(--index));
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Search result improvements */
.search-result-item {
    background: linear-gradient(145deg, var(--background) 0%, rgba(15, 23, 42, 0.8) 100%);
    border: 1px solid rgba(255, 255, 255, 0.03);
}

.search-result-item:hover {
    background: linear-gradient(145deg, var(--surface) 0%, rgba(30, 41, 59, 0.8) 100%);
    transform: translateX(4px);
}

.search-result-cover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

/* Better sort chips */
.sort-chip {
    font-weight: 500;
    letter-spacing: 0.02em;
}

.sort-chip:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

/* Enhanced FAB */
.fab {
    background: linear-gradient(145deg, var(--primary) 0%, var(--primary-dark) 100%);
    box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
}

/* Add options menu polish */
.add-options {
    background: linear-gradient(145deg, var(--surface) 0%, rgba(30, 41, 59, 0.95) 100%);
    border: 1px solid rgba(255, 255, 255, 0.05);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
}

/* Better progress bar */
.progress-fill {
    background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
}

/* Enhanced status badges */
.book-status {
    font-weight: 600;
    letter-spacing: 0.05em;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* Better lending book covers */
.lending-book-cover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

/* Premium scrollbar */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--background);
}

::-webkit-scrollbar-thumb {
    background: var(--surface-light);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--primary);
}

        /* Responsive */
        @media (min-width: 768px) {
            .book-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
<div class="header-content">
    <div class="logo" onclick="switchView('libraryView')" style="cursor: pointer;">
        <span>📚</span>
        <span>Book Thingy</span>
    </div>
<div class="user-info" id="userInfo" style="display: none;">
    <div style="display: flex; flex-direction: column; margin-right: 1rem;">
        <span id="userEmail" style="color: var(--text-dim); font-size: 0.875rem;"></span>
        <span id="subscriptionStatus" style="color: var(--accent); font-size: 0.7rem;"></span>
    </div>
    <button class="btn btn-secondary" onclick="showSettingsModal()" style="padding: 0.5rem 1rem; font-size: 0.875rem; margin-right: 0.5rem;">
        Settings
    </button>
    <button class="btn btn-secondary" onclick="showExportModal()" style="padding: 0.5rem 1rem; font-size: 0.875rem; margin-right: 0.5rem;">
        Export
    </button>
    <button class="btn btn-secondary" onclick="signOut()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
        Sign Out
    </button>
</div>
</div>
</header>

     <!-- Main Content -->
<main class="main-content">
    <!-- Library View -->
    <div class="view active" id="libraryView">
        <div class="search-section">
            <div class="search-bar">
                <input type="text" class="search-input" id="searchInput" placeholder="Search your library...">
                   <button class="btn btn-secondary" id="selectionModeBtn" onclick="toggleSelectionMode()">
                <span>✓</span>
                <span>Select</span>
            </button>
        </div>

 <!-- BULK ACTIONS TOOLBAR -->
    <div class="bulk-actions-toolbar" id="bulkActionsToolbar" style="display: none;">
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--surface); border-radius: var(--radius); margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span id="selectedCount">0</span> books selected
                <button class="btn btn-secondary" onclick="selectAll()" style="margin-left: 1rem; padding: 0.5rem 1rem; font-size: 0.875rem;">
                    Select All
                </button>
                <button class="btn btn-secondary" onclick="deselectAll()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                    Clear Selection
                </button>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary" onclick="bulkChangeStatus()" style="padding: 0.5rem 1rem;">
                    <span>📚</span>
                    <span>Change Status</span>
                </button>
                <button class="btn" onclick="bulkDelete()" style="background: var(--danger); padding: 0.5rem 1rem;">
                    <span>🗑️</span>
                    <span>Delete Selected</span>
                </button>
            </div>
        </div>
    </div>

            <div class="sort-section">
                <button class="sort-chip active" data-sort="recent">Recent</button>
                <button class="sort-chip" data-sort="title">Title</button>
                <button class="sort-chip" data-sort="author">Author</button>
                <button class="sort-chip" data-sort="status">Status</button>
                <button class="sort-chip" data-sort="rating">Rating</button>
                <button class="sort-chip" data-sort="genre">Genre</button>
            </div>
        </div>

        <div class="book-grid" id="bookGrid">
            <!-- Books will be rendered here -->
        </div>

        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-icon">📚</div>
            <p class="empty-text">Your library is waiting for its first book!</p>
            <p class="empty-text" style="font-size: 0.875rem; margin-top: 0.5rem;">Click the + button to add a book</p>
            <div class="empty-tips">
                <h4>Quick Tips</h4>
                <ul>
                    <li>Search for books by title, author, or ISBN</li>
                    <li>Track your reading progress and set goals</li>
                    <li>Your library syncs across all devices</li>
                </ul>
            </div>
        </div>
    </div> <!-- This closing div was missing! -->

    <!-- Stats View -->
    <div class="view" id="statsView">
        <h2 style="margin-bottom: 1.5rem;">Reading Statistics</h2>
        
        <div class="progress-container">
            <div class="progress-header">
                <h3>2025 Reading Goal</h3>
                <button class="btn btn-secondary" onclick="showGoalModal()">Set Goal</button>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="goalProgress" style="width: 0%">0%</div>
            </div>
            <p style="margin-top: 0.5rem; color: var(--text-dim);" id="goalText">No goal set</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card" onclick="handleStatClick('total')">
                <div class="stat-value" id="totalBooks">0</div>
                <div class="stat-label">Total Books</div>
            </div>
            <div class="stat-card" onclick="handleStatClick('reading')">
                <div class="stat-value" id="currentlyReading">0</div>
                <div class="stat-label">Currently Reading</div>
            </div>
            <div class="stat-card" onclick="handleStatClick('completed')">
                <div class="stat-value" id="completedBooks">0</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card" onclick="handleStatClick('rating')">
                <div class="stat-value" id="averageRating">0</div>
                <div class="stat-label">Average Rating</div>
            </div>
        </div>

        <div class="book-row-container" id="bookRowContainer">
            <!-- Book rows will be displayed here when a stat card is clicked -->
        </div>
    </div>

    <!-- Lending View -->
    <div class="view" id="lendingView">
        <h2 style="margin-bottom: 1.5rem;">Books On Loan</h2>
        
        <div class="lending-list" id="lendingList">
            <!-- Lending items will be rendered here -->
        </div>

        <div class="empty-state" id="lendingEmpty" style="display: none;">
            <div class="empty-icon">🤝</div>
            <p class="empty-text">No books currently on loan</p>
        </div>
    </div>

    <!-- Wishlist View -->
    <div class="view" id="wishlistView">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2>My Wishlist</h2>
            <button class="btn" onclick="switchView('browserView')" style="padding: 0.5rem 1rem;">
                🌐 Browse Books
            </button>
        </div>
        
        <div class="book-row-container active" id="wishlistContainer">
            <!-- Wishlist items will be rendered here -->
        </div>

        <div class="empty-state" id="wishlistEmpty" style="display: none;">
            <div class="empty-icon">⭐</div>
            <p class="empty-text">Your wishlist is empty</p>
            <p class="empty-text" style="font-size: 0.875rem; margin-top: 0.5rem;">Browse books to add them to your wishlist</p>
        </div>
    </div>

    <!-- Notebook View -->
    <div class="view" id="notebookView">
        <div class="notebook-container">
            <!-- Left Sidebar - Book List -->
            <div class="notebook-sidebar">
                <div class="notebook-search">
                    <input type="text" id="notebookSearchInput" placeholder="Search your library..." />
                </div>
                <div class="notebook-book-list" id="notebookBookList">
                    <!-- Books will be rendered here -->
                </div>
            </div>

            <!-- Second Sidebar - Pages for Selected Book -->
            <div class="notebook-book-sidebar" id="notebookBookSidebar">
                <div class="notebook-pages-header">
                    <div class="notebook-pages-title" id="notebookBookTitle">Select a book</div>
                    <div class="notebook-pages-subtitle">Notebook</div>
                    <button class="notebook-add-page" id="notebookAddPageBtn" style="display: none;">
                        ➕ Add Page
                    </button>
                </div>
                <div class="notebook-pages-list" id="notebookPagesList">
                    <!-- Pages will be rendered here -->
                </div>
            </div>

            <!-- Main Editor Area -->
            <div class="notebook-main">
                <div class="notebook-editor-container" id="notebookEditorContainer">
                    <div class="notebook-empty-state">
                        <div class="notebook-empty-icon">📝</div>
                        <h3>Reading Notebook</h3>
                        <p style="margin-top: 0.5rem;">Select a book from your library to start taking notes</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Browser View -->
    <div class="view" id="browserView">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0 1rem;">
            <button class="btn btn-secondary" onclick="switchView('wishlistView')" style="padding: 0.5rem 1rem;">
                ← Back to Wishlist
            </button>
            <h2 style="margin: 0;">Browse Books</h2>
            <button class="btn" id="addToWishlistBtn" onclick="addCurrentPageToWishlist()" style="padding: 0.5rem 1rem;">
                ⭐ Add to Wishlist
            </button>
        </div>
        
        <div class="browser-container">
            <webview id="bookBrowser" 
                     src="https://www.amazon.com/books" 
                     style="width: 100%; height: calc(100vh - 120px); border: none; border-radius: 8px;">
            </webview>
        </div>
    </div>

    <!-- Reading List View -->
    <div class="view" id="readingListView">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2>My Reading List</h2>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary" onclick="showAddToReadingListModal()" style="padding: 0.5rem 1rem;">
                    ➕ Add Book
                </button>
                <button class="btn btn-secondary" onclick="clearReadingList()" style="padding: 0.5rem 1rem; background: var(--danger);">
                    🗑️ Clear All
                </button>
            </div>
        </div>
        
        <div class="book-row-container active" id="readingListContainer">
            <!-- Reading list items will be rendered here -->
        </div>

        <div class="empty-state" id="readingListEmpty" style="display: none;">
            <div class="empty-icon">📋</div>
            <p class="empty-text">Your reading list is empty</p>
            <p class="empty-text" style="font-size: 0.875rem; margin-top: 0.5rem;">Add books from your library or wishlist to plan your reading</p>
        </div>
    </div>
</main>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchView('libraryView')">
        <div class="nav-icon">📚</div>
        <div class="nav-label">Library</div>
    </div>
    <div class="nav-item" onclick="switchView('statsView')">
        <div class="nav-icon">📊</div>
        <div class="nav-label">Stats</div>
    </div>
    <div class="nav-item" onclick="switchView('wishlistView')">
        <div class="nav-icon">⭐</div>
        <div class="nav-label">Wishlist</div>
    </div>
    <div class="nav-item" onclick="switchView('readingListView')">
        <div class="nav-icon">📋</div>
        <div class="nav-label">Reading List</div>
    </div>
    <div class="nav-item" onclick="switchView('notebookView')">
        <div class="nav-icon">📝</div>
        <div class="nav-label">Notebook</div>
    </div>
    <div class="nav-item" onclick="switchView('lendingView')">
        <div class="nav-icon">🤝</div>
        <div class="nav-label">Lending</div>
    </div>
    <div class="nav-item" onclick="showAddOptions()" style="margin-left: auto;">
        <div class="nav-icon">➕</div>
        <div class="nav-label">Add Book</div>
    </div>
</nav>


            <!-- Book Details Modal -->
        <div class="modal" id="bookModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="modalBookTitle">Book Details</h2>
                    <button class="modal-close" onclick="closeModal('bookModal')">×</button>
                </div>
                <div class="modal-body" id="bookModalBody">
                    <!-- Book details will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Add/Edit Book Modal -->
        <div class="modal" id="addBookModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="addBookTitle">Add Book</h2>
                    <button class="modal-close" onclick="closeModal('addBookModal')">×</button>
                </div>
                <div class="modal-body">
                    <form id="bookForm">
                        <input type="hidden" id="bookId">
                        
                        <div class="form-group">
                            <label class="form-label">Title *</label>
                            <input type="text" class="form-input" id="bookTitle" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Author *</label>
                            <input type="text" class="form-input" id="bookAuthor" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ISBN</label>
                            <input type="text" class="form-input" id="bookISBN">
                        </div>

                        <div class="form-group">
                           <label class="form-label">Location</label>
                           <input type="text" class="form-input" id="bookLocation" placeholder="e.g., Living room shelf, Bedroom, Library">
                       </div>

                        <div class="form-group">
                           <label class="form-label">Genre</label>
                           <input type="text" class="form-input" id="bookGenre" placeholder="e.g., Fiction, Mystery, Biography...">
                        </div>

                        <div class="form-group">
    <label class="form-label">Book Format (check all that apply)</label>
    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="bookFormat" value="hardcover" style="width: auto; margin: 0;">
            <span>Hardcover</span>
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="bookFormat" value="paperback" style="width: auto; margin: 0;">
            <span>Paperback</span>
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="bookFormat" value="ebook" style="width: auto; margin: 0;">
            <span>E-book</span>
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="bookFormat" value="audiobook" style="width: auto; margin: 0;">
            <span>Audiobook</span>
        </label>
        <!-- ADD THIS NEW CHECKBOX -->
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--surface-light);">
            <input type="checkbox" name="bookFormat" value="no-copy" style="width: auto; margin: 0;">
            <span>No Personal Copy</span>
        </label>
    </div>
</div>

<div class="form-group">
    <label class="form-label">Cover Image</label>
    <div style="display: flex; gap: 0.5rem; align-items: center;">
        <input type="url" class="form-input" id="bookCover" placeholder="Paste image URL..." style="flex: 1;">
        <span style="color: var(--text-dim); font-size: 0.875rem;">or</span>
        <label class="btn btn-secondary" style="margin: 0; cursor: pointer;">
            <span>📷</span>
            <span>Upload</span>
            <input type="file" id="bookCoverUpload" accept="image/*" style="display: none;" onchange="handleCoverUpload(event)">
        </label>
    </div>
    <div id="coverPreview" style="margin-top: 1rem; display: none;">
        <img id="coverPreviewImg" style="width: 100px; height: 150px; object-fit: cover; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
    </div>
</div>

                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="bookStatus">
                                <option value="want-to-read">Want to Read</option>
                                <option value="reading">Currently Reading</option>
                                <option value="completed">Completed</option>
                                <option value="abandoned">Abandoned</option>
                            </select>
                        </div>

<!-- ADD THIS NEW FIELD -->
<div class="form-group" id="pastReadGroup" style="display: none;">
    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
        <input type="checkbox" id="bookPastRead" style="width: auto; margin: 0;">
        <span>This is a past read (won't count toward current goals)</span>
    </label>
</div>

<div class="form-group">
                            <label class="form-label">Rating</label>
                            <div class="rating" id="bookRating">
                                <span class="rating-star" data-rating="1">☆</span>
                                <span class="rating-star" data-rating="2">☆</span>
                                <span class="rating-star" data-rating="3">☆</span>
                                <span class="rating-star" data-rating="4">☆</span>
                                <span class="rating-star" data-rating="5">☆</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Summary</label>
                            <textarea class="form-textarea" id="bookSummary" placeholder="What's this book about?"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-textarea" id="bookNotes" placeholder="Your thoughts..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Favorite Quotes</label>
                            <textarea class="form-textarea" id="bookQuotes" placeholder="Memorable quotes from the book..."></textarea>
                        </div>

                        <button type="submit" class="btn" style="width: 100%;">Save Book</button>
                    </form>
                </div>
            </div>
        </div>
</div>

        <!-- Internet Search Modal -->
        <div class="modal" id="searchModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Search Books</h2>
                    <button class="modal-close" onclick="closeModal('searchModal')">×</button>
                </div>
                <div class="modal-body">
                    <div class="search-bar">
                        <input type="text" class="search-input" id="internetSearchInput" placeholder="Search by title, author, or ISBN...">
                        <button class="btn" onclick="searchGoogleBooks()">Search</button>
                    </div>
                    <div id="searchResults"></div>
                </div>
            </div>
        </div>

        <!-- Lending Modal -->
        <div class="modal" id="lendingModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Lend Book</h2>
                    <button class="modal-close" onclick="closeModal('lendingModal')">×</button>
                </div>
                <div class="modal-body">
                    <form id="lendingForm">
                        <input type="hidden" id="lendBookId">
                        
                     <div class="form-group">
    <label class="form-label">Borrower's Name *</label>
    <input type="text" class="form-input" id="borrowerName" required>
</div>

<div class="form-group">
    <label class="form-label">Phone Number</label>
    <input type="tel" class="form-input" id="borrowerPhone" placeholder="(555) 123-4567">
</div>

<div class="form-group">
    <label class="form-label">Email Address</label>
    <input type="email" class="form-input" id="borrowerEmail" placeholder="email@example.com">
</div>

                        <button type="submit" class="btn" style="width: 100%;">Lend Book</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Goal Modal -->
        <div class="modal" id="goalModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Set Reading Goal</h2>
                    <button class="modal-close" onclick="closeModal('goalModal')">×</button>
                </div>
                <div class="modal-body">
                    <form id="goalForm">
                        <div class="form-group">
                            <label class="form-label">Books to read in 2025</label>
                            <input type="number" class="form-input" id="goalInput" min="1" max="365" placeholder="e.g., 24" required>
                        </div>
                        <button type="submit" class="btn" style="width: 100%;">Set Goal</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="modal" id="settingsModal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">Settings</h2>
                    <button class="modal-close" onclick="closeModal('settingsModal')">×</button>
                </div>
                <div class="modal-body">
<!-- Account Section -->
<div style="margin-bottom: 2rem;">
    <h3 style="margin-bottom: 1rem; color: var(--primary);">Account</h3>
    <div style="background: var(--surface); padding: 1.5rem; border-radius: var(--radius);">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <div id="userProfilePic" style="width: 60px; height: 60px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; overflow: hidden;">
                👤
            </div>
            <div>
                <div style="font-weight: 600;" id="settingsUserName">Loading...</div>
                <div style="font-size: 0.875rem; color: var(--text-dim);" id="settingsUserEmail">Loading...</div>
                <div style="font-size: 0.875rem; color: var(--text-dim);">Google Account</div>
            </div>
        </div>
    </div>
</div>
                    
<!-- Reading Preferences -->
<div style="margin-bottom: 2rem;">
    <h3 style="margin-bottom: 1rem; color: var(--primary);">Reading Preferences</h3>
    <div style="background: var(--surface); padding: 1.5rem; border-radius: var(--radius);">
        <!-- ADD THIS NEW THEME TOGGLE -->
        <div class="form-group">
            <label class="form-label">Theme</label>
            <div style="display: flex; gap: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="radio" name="theme" value="dark" id="themeDark" checked style="width: auto; margin: 0;">
                    <span>🌙 Dark Mode</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="radio" name="theme" value="light" id="themeLight" style="width: auto; margin: 0;">
                    <span>☀️ Light Mode</span>
                </label>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Default Book Status</label>
            <select class="form-select" id="defaultBookStatus">
                <option value="want-to-read">Want to Read</option>
                <option value="reading">Currently Reading</option>
                <option value="completed">Completed</option>
                <option value="abandoned">Abandoned</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Books Per Page</label>
            <select class="form-select" id="booksPerPage">
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="all">All</option>
            </select>
        </div>
        
        <!-- ADD READING GOAL SETTINGS -->
        <div class="form-group">
            <label class="form-label">Annual Reading Goal</label>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="number" class="form-input" id="annualGoal" min="0" max="365" style="width: 100px;">
                <span style="color: var(--text-dim);">books per year</span>
            </div>
            <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.5rem;">
                That's about <span id="monthlyGoalPreview">0</span> books per month
            </p>
        </div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="showReadingStreak" style="width: auto; margin: 0;">
                <span>Show reading streak on stats page</span>
            </label>
        </div>
    </div>
</div>

                    <!-- Data Management -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; color: var(--primary);">Data Management</h3>
                        <div style="background: var(--surface); padding: 1.5rem; border-radius: var(--radius);">
                            <div style="display: grid; gap: 1rem;">
                                <button class="btn btn-secondary" onclick="showExportModal(); closeModal('settingsModal');" style="justify-content: center;">
                                    <span>📤</span>
                                    <span>Export Library</span>
                                </button>
                                
<button class="btn btn-secondary" onclick="importLibrary()" style="justify-content: center;">
    <span>📥</span>
    <span>Import Library</span>
</button>
                                
                                <button class="btn" onclick="clearAllData()" style="background: var(--danger); justify-content: center;">
                                    <span>🗑️</span>
                                    <span>Clear All Data</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Save Settings Button -->
                    <button class="btn" onclick="saveSettings()" style="width: 100%; justify-content: center;">
                        Save Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Export Modal -->
        <div class="modal" id="exportModal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2 class="modal-title">Export Your Library</h2>
                    <button class="modal-close" onclick="closeModal('exportModal')">×</button>
                </div>
                <div class="modal-body">
                    <p style="color: var(--text-dim); margin-bottom: 2rem;">
                        Download your book library for backup or to use in other applications.
                    </p>
                    
                    <div style="display: grid; gap: 1rem;">
                        <button class="btn" onclick="exportAsCSV()" style="justify-content: center;">
                            <span>📄</span>
                            <span>Download as CSV</span>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="exportAsJSON()" style="justify-content: center;">
                            <span>📋</span>
                            <span>Download as JSON</span>
                        </button>
                    </div>
                    
                    <p style="font-size: 0.875rem; color: var(--text-dim); text-align: center; margin-top: 1.5rem;">
                        CSV works with Excel and Google Sheets<br>
                        JSON preserves all data including notes and quotes
                    </p>
                </div>
            </div>
        </div>

                <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <p class="loading-text" id="loadingText">Loading...</p>
            </div>
        </div>

          <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>

                <!-- ADD THE SIGN-IN MODAL HERE -->
        <!-- Sign In Modal -->
        <div class="modal" id="signInModal">
            <div class="modal-content" style="max-width: 450px;">
                <div class="modal-header">
                    <h2 class="modal-title">Welcome to Book Thingy</h2>
                </div>
                <div class="modal-body" style="text-align: center;">
                    <div style="margin-bottom: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">📚</div>
                        <p style="color: var(--text-dim); margin-bottom: 1rem; font-weight: 600;">Welcome to Book Thingy Web</p>
                        
                        <!-- Clear Requirements -->
                        <div style="background: var(--surface-light); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: left;">
                            <div style="margin-bottom: 1rem;">
                                <strong style="color: var(--primary); font-size: 1rem;">☁️ Web App Requires Cloud Sync</strong><br>
                                <span style="color: var(--text-dim); font-size: 0.875rem;">The web version works entirely through cloud sync</span>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 0.75rem; border-radius: 6px; font-size: 0.8rem;">
                                <div style="margin-bottom: 0.5rem;">✅ New users: <strong>6 months FREE</strong> cloud sync</div>
                                <div style="margin-bottom: 0.5rem;">✅ Desktop owners: Subscribe for <strong>$12/year</strong></div>
                                <div>✅ Then: <strong>$12/year</strong> (less than $1/month)</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Email Sign Up/In Form -->
                    <div id="emailAuthForm" style="margin-bottom: 1.5rem;">
                        <input type="email" id="emailInput" placeholder="Enter your email address" 
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; background: var(--bg-secondary); color: var(--text-primary);">
                        <button class="btn" id="emailSignInBtn" style="width: 100%; justify-content: center; margin-bottom: 1rem;">
                            <span>Create Account / Sign In</span>
                        </button>
                    </div>
                    
                    <!-- Divider -->
                    <div style="display: flex; align-items: center; margin: 1.5rem 0; color: var(--text-dim);">
                        <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                        <span style="padding: 0 1rem; font-size: 0.875rem;">or</span>
                        <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                    </div>
                    
                    <!-- Google Sign In -->
                    <button class="btn btn-secondary" id="googleSignInBtn" style="width: 100%; justify-content: center;">
                        <span>🔐 Sign in with Google</span>
                    </button>
                    
                    <!-- Test Account Option -->
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                        <button id="testAccountBtn" style="background: var(--accent); border: 1px solid var(--accent); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.875rem; width: 100%;">
                            🚗 Use Test Account (Demo with 20 Books)
                        </button>
                        <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.5rem; text-align: center;">
                            Pre-loaded with classic literature • Full functionality demo
                        </p>
                    </div>
                    
                    <!-- Desktop App Link -->
                    <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border-color); background: var(--surface); padding: 1rem; border-radius: 8px;">
                        <p style="font-size: 0.875rem; color: var(--primary); margin-bottom: 0.5rem; font-weight: 600;">💎 Want permanent storage?</p>
                        <p style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.5rem;">Get the desktop app for true offline storage that never expires</p>
                        <a href="download.html" style="color: var(--accent); text-decoration: none; font-size: 0.875rem; font-weight: 500;">Buy Book Thingy Desktop ($25.99) →</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Desktop User Cloud Sync Modal -->
        <div class="modal" id="desktopUserSyncModal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2 class="modal-title">Welcome Desktop User!</h2>
                </div>
                <div class="modal-body" style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">🖥️➡️☁️</div>
                    <h3 style="margin-bottom: 1rem;">Access Your Library Online</h3>
                    <p style="color: var(--text-dim); margin-bottom: 2rem;">
                        You own the desktop app! To view and sync your library on the web, subscribe to cloud sync.
                    </p>
                    
                    <div style="background: var(--surface-light); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; text-align: left;">
                        <h4 style="color: var(--accent); margin-bottom: 1rem;">☁️ Cloud Sync - $12/year</h4>
                        <ul style="margin-bottom: 1rem; padding-left: 1rem;">
                            <li>✅ Access your library on all devices</li>
                            <li>✅ Automatic backup & sync with desktop app</li>
                            <li>✅ Never lose your book data</li>
                            <li>✅ Read and update from anywhere</li>
                        </ul>
                        <p style="font-size: 0.875rem; color: var(--text-dim);">
                            <strong>Less than $1 per month!</strong>
                        </p>
                    </div>
                    
                    <button class="btn" onclick="subscribeDesktopUserToCloudSync()" style="width: 100%; justify-content: center; margin-bottom: 1rem;">
                        <span>Subscribe to Cloud Sync - $12/year</span>
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal('desktopUserSyncModal'); location.href='/';" style="width: 100%; justify-content: center;">
                        <span>Maybe Later (Return to Homepage)</span>
                    </button>
                    
                    <p style="margin-top: 1rem; font-size: 0.75rem; color: var(--text-dim);">
                        <strong>Cloud sync is required</strong> to use the web app. Without it, please use the desktop app.
                    </p>
                </div>
            </div>
        </div>

        <!-- Subscription Expired Modal -->
        <div class="modal" id="subscriptionExpiredModal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2 class="modal-title">Cloud Sync Expired</h2>
                </div>
                <div class="modal-body" style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">☁️</div>
                    <h3 style="margin-bottom: 1rem;">Your cloud sync subscription has expired</h3>
                    <p style="color: var(--text-dim); margin-bottom: 2rem;">
                        Your books are still safe! They're now saved locally on this device only. 
                        Subscribe to cloud sync to access your library on all your devices.
                    </p>
                    
                    <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                        <h4 style="color: var(--accent); margin-bottom: 1rem;">🔄 Cloud Sync - $12/year</h4>
                        <ul style="text-align: left; margin-bottom: 1rem;">
                            <li>✅ Access your library on all devices</li>
                            <li>✅ Automatic backup & sync</li>
                            <li>✅ Web app access</li>
                            <li>✅ Never lose your books</li>
                        </ul>
                    </div>
                    
                    <button class="btn" onclick="subscribeToCloudSync()" style="width: 100%; justify-content: center; margin-bottom: 1rem;">
                        <span>Subscribe for $12/year</span>
                    </button>
                    <button class="btn btn-secondary" onclick="continueLocalOnly()" style="width: 100%; justify-content: center;">
                        <span>Continue with Local Storage Only</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Trial Expiring Warning Modal -->
        <div class="modal" id="trialExpiringModal">
            <div class="modal-content" style="max-width: 450px;">
                <div class="modal-header">
                    <h2 class="modal-title">Free Trial Ending Soon</h2>
                    <button class="modal-close" onclick="closeModal('trialExpiringModal')">×</button>
                </div>
                <div class="modal-body" style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">⏰</div>
                    <h3 id="trialDaysLeft" style="margin-bottom: 1rem;"></h3>
                    <p style="color: var(--text-dim); margin-bottom: 2rem;">
                        Subscribe now to keep your cloud sync active and access your library on all devices.
                    </p>
                    
                    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <h4 style="color: var(--accent); margin-bottom: 0.5rem;">Just $12/year</h4>
                        <p style="font-size: 0.875rem; color: var(--text-dim);">Less than $1 per month!</p>
                    </div>
                    
                    <button class="btn" onclick="subscribeToCloudSync()" style="width: 100%; justify-content: center; margin-bottom: 1rem;">
                        <span>Subscribe Now - $12/year</span>
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal('trialExpiringModal')" style="width: 100%; justify-content: center;">
                        <span>Remind Me Later</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Save Indicator -->
        <div class="save-indicator" id="saveIndicator">Saved!</div>
    </div>

    <script>
        // App State
        let library = {
            books: [],
            wishlist: [],
            readingList: [],
            notebooks: {},
            settings: {
                goal2025: null
            }
        };
        
        // Subscription tracking
        let subscriptionStatus = {
            hasCloudAccess: false,
            subscriptionType: 'none', // 'none', 'trial', 'paid'
            trialStartDate: null,
            trialEndDate: null,
            subscriptionEndDate: null,
            purchaseDate: null
        };
        let currentSort = 'recent';

        // Subscription Management Functions
        function initializeSubscription(user) {
            const now = new Date();
            
            // Check if user has existing subscription data
            if (!user.subscriptionStatus) {
                // New user - start 6-month free trial
                const trialEnd = new Date(now.getTime() + (6 * 30 * 24 * 60 * 60 * 1000)); // 6 months
                
                subscriptionStatus = {
                    hasCloudAccess: true,
                    subscriptionType: 'trial',
                    trialStartDate: now.toISOString(),
                    trialEndDate: trialEnd.toISOString(),
                    subscriptionEndDate: null,
                    purchaseDate: now.toISOString()
                };
                
                console.log('Started 6-month free trial for new user');
                showToast('Welcome!', '6 months of free cloud sync included! 🎉', 'success');
            } else {
                subscriptionStatus = user.subscriptionStatus;
                checkSubscriptionStatus();
            }
        }
        
        function checkSubscriptionStatus() {
            const now = new Date();
            
            if (subscriptionStatus.subscriptionType === 'trial') {
                const trialEnd = new Date(subscriptionStatus.trialEndDate);
                if (now > trialEnd) {
                    // Trial expired
                    subscriptionStatus.hasCloudAccess = false;
                    subscriptionStatus.subscriptionType = 'expired';
                    showSubscriptionExpiredModal();
                    return false;
                } else {
                    // Trial still active
                    const daysLeft = Math.ceil((trialEnd - now) / (24 * 60 * 60 * 1000));
                    if (daysLeft <= 30) {
                        showTrialExpiringWarning(daysLeft);
                    }
                    return true;
                }
            } else if (subscriptionStatus.subscriptionType === 'paid') {
                const subEnd = new Date(subscriptionStatus.subscriptionEndDate);
                if (now > subEnd) {
                    // Paid subscription expired
                    subscriptionStatus.hasCloudAccess = false;
                    subscriptionStatus.subscriptionType = 'expired';
                    showSubscriptionExpiredModal();
                    return false;
                } else {
                    // Paid subscription active
                    const daysLeft = Math.ceil((subEnd - now) / (24 * 60 * 60 * 1000));
                    if (daysLeft <= 7) {
                        showSubscriptionExpiringWarning(daysLeft);
                    }
                    return true;
                }
            }
            
            return false;
        }
        
        function hasCloudSyncAccess() {
            return subscriptionStatus.hasCloudAccess && 
                   (subscriptionStatus.subscriptionType === 'trial' || subscriptionStatus.subscriptionType === 'paid');
        }
        
        // Subscription UI Functions
        function showSubscriptionExpiredModal() {
            openModal('subscriptionExpiredModal');
        }
        
        function showTrialExpiringWarning(daysLeft) {
            document.getElementById('trialDaysLeft').textContent = 
                `Your free trial ends in ${daysLeft} day${daysLeft > 1 ? 's' : ''}!`;
            openModal('trialExpiringModal');
        }
        
        function showSubscriptionExpiringWarning(daysLeft) {
            showToast('Subscription Ending', `Your cloud sync expires in ${daysLeft} day${daysLeft > 1 ? 's' : ''}. Renew to keep syncing!`, 'warning');
        }
        
        function subscribeToCloudSync() {
            // In a real app, this would integrate with a payment processor like Stripe
            // For now, we'll simulate the subscription
            
            const confirmed = confirm(
                'This will open your payment processor to subscribe for $12/year.\n\n' +
                'For this demo, clicking OK will simulate a successful subscription.'
            );
            
            if (confirmed) {
                // Simulate successful subscription
                const now = new Date();
                const nextYear = new Date(now.getTime() + (365 * 24 * 60 * 60 * 1000)); // 1 year
                
                subscriptionStatus = {
                    hasCloudAccess: true,
                    subscriptionType: 'paid',
                    trialStartDate: subscriptionStatus.trialStartDate,
                    trialEndDate: subscriptionStatus.trialEndDate,
                    subscriptionEndDate: nextYear.toISOString(),
                    purchaseDate: now.toISOString()
                };
                
                // Save updated subscription status
                saveLibrary();
                
                // Close any open modals
                closeModal('subscriptionExpiredModal');
                closeModal('trialExpiringModal');
                
                showToast('Success!', 'Cloud sync activated! Your library will now sync across all devices.', 'success');
                
                console.log('Subscription activated until:', nextYear);
            }
        }
        
        function continueLocalOnly() {
            closeModal('subscriptionExpiredModal');
            subscriptionStatus.hasCloudAccess = false;
            subscriptionStatus.subscriptionType = 'local-only';
            
            showToast('Local Mode', 'Your library will be saved locally on this device only.', 'info');
            console.log('User chose to continue with local-only storage');
        }

        // Desktop user cloud sync functions
        function subscribeDesktopUserToCloudSync() {
            // Mark user as desktop app owner with cloud sync
            subscriptionStatus = {
                hasCloudAccess: true,
                subscriptionType: 'paid',
                userType: 'desktop',
                trialStartDate: null,
                trialEndDate: null,
                subscriptionEndDate: new Date(new Date().getTime() + (365 * 24 * 60 * 60 * 1000)).toISOString(), // 1 year
                purchaseDate: new Date().toISOString()
            };
            
            // Save to Firebase
            saveLibrary();
            
            closeModal('desktopUserSyncModal');
            showToast('Cloud Sync Activated!', 'Your library will now sync with the desktop app.', 'success');
            
            // Load library (will now have cloud access)
            loadLibrary().then(() => {
                renderLibrary();
                updateStats();
            });
        }


        function checkIfDesktopUser(user) {
            // Check if this is a desktop app user signing in for the first time on web
            return new Promise(async (resolve) => {
                try {
                    const doc = await db.collection('users').doc(user.uid).get();
                    if (!doc.exists) {
                        // New user - show a modal to ask if they own the desktop app
                        showDesktopAppQuestionModal(user, resolve);
                    } else {
                        const data = doc.data();
                        resolve(data.userType === 'desktop');
                    }
                } catch (error) {
                    console.error('Error checking user type:', error);
                    resolve(false);
                }
            });
        }

        function showDesktopAppQuestionModal(user, callback) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px;">
                    <div class="modal-header">
                        <h2 class="modal-title">Welcome!</h2>
                    </div>
                    <div class="modal-body" style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">🖥️❓</div>
                        <h3 style="margin-bottom: 1rem;">Do you own Book Thingy Desktop?</h3>
                        <p style="color: var(--text-dim); margin-bottom: 2rem;">
                            If you've purchased the desktop app, you can subscribe to cloud sync to access your library here.
                        </p>
                        
                        <button class="btn" onclick="handleDesktopOwner(true)" style="width: 100%; margin-bottom: 1rem;">
                            Yes, I own the desktop app
                        </button>
                        <button class="btn btn-secondary" onclick="handleDesktopOwner(false)" style="width: 100%;">
                            No, I'm new to Book Thingy
                        </button>
                    </div>
                </div>
            `;
            
            // Add callback to window for button handlers
            window.desktopUserCallback = callback;
            window.desktopUserModal = modal;
            
            document.body.appendChild(modal);
        }

        function handleDesktopOwner(isDesktopOwner) {
            const callback = window.desktopUserCallback;
            const modal = window.desktopUserModal;
            
            modal.remove();
            callback(isDesktopOwner);
            
            // Clean up
            delete window.desktopUserCallback;
            delete window.desktopUserModal;
        }
        
        function getSubscriptionStatusText() {
            if (subscriptionStatus.subscriptionType === 'trial') {
                const trialEnd = new Date(subscriptionStatus.trialEndDate);
                const daysLeft = Math.ceil((trialEnd - new Date()) / (24 * 60 * 60 * 1000));
                return `Free Trial (${daysLeft} days left)`;
            } else if (subscriptionStatus.subscriptionType === 'paid') {
                const subEnd = new Date(subscriptionStatus.subscriptionEndDate);
                const daysLeft = Math.ceil((subEnd - new Date()) / (24 * 60 * 60 * 1000));
                return `Cloud Sync Active (${daysLeft} days remaining)`;
            } else if (subscriptionStatus.subscriptionType === 'expired') {
                return 'Cloud Sync Expired';
            } else {
                return 'Local Storage Only';
            }
        }

        // Loading overlay functions
        function showLoading(message = 'Loading...') {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // Toast notification functions
        function showToast(title, message = '', type = 'success', duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.id = toastId;
            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    ${message ? `<div class="toast-message">${message}</div>` : ''}
                </div>
                <button class="toast-close" onclick="closeToast('${toastId}')">×</button>
            `;
            
            container.appendChild(toast);
            
            // Show toast with animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove after duration
            setTimeout(() => closeToast(toastId), duration);
        }

        function closeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }
        }
        let currentBookId = null;
        let selectedRating = 0;
        let selectionMode = false;
        let selectedBooks = new Set();

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
    setupEventListeners();
    
    // Initialize theme
    initializeTheme();
    
    // Theme radio buttons
    document.getElementById('themeDark').addEventListener('change', function() {
        if (this.checked) applyTheme('dark');
    });
    
    document.getElementById('themeLight').addEventListener('change', function() {
        if (this.checked) applyTheme('light');
    });
    
    // Annual goal preview
    document.getElementById('annualGoal').addEventListener('input', function() {
        const annual = parseInt(this.value) || 0;
        const monthly = Math.round(annual / 12);
        document.getElementById('monthlyGoalPreview').textContent = monthly;
    });
    

    // Direct button handlers (add after FAB handler)
    const barcodeBtn = document.getElementById('barcodeBtn');
    if (barcodeBtn) {
        barcodeBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('addOptions').classList.remove('active');
            showBarcodeScanner();
        });
    }

    const searchBtn = document.getElementById('searchBtn');
    if (searchBtn) {
        searchBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('addOptions').classList.remove('active');
            showInternetSearch();
        });
    }

    const manualBtn = document.getElementById('manualBtn');
    if (manualBtn) {
        manualBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('addOptions').classList.remove('active');
            showManualEntry();
        });
    }

    // Close FAB menu when clicking elsewhere
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#fab') && !e.target.closest('#addOptions')) {
            document.getElementById('addOptions').classList.remove('active');
        }
    });
});

// Theme Management Functions
function initializeTheme() {
    const savedTheme = localStorage.getItem('bookThingyTheme') || 'dark';
    applyTheme(savedTheme);
}

function applyTheme(theme) {
    if (theme === 'light') {
        document.documentElement.classList.add('light-theme');
        if (document.getElementById('themeLight')) {
            document.getElementById('themeLight').checked = true;
        }
    } else {
        document.documentElement.classList.remove('light-theme');
        if (document.getElementById('themeDark')) {
            document.getElementById('themeDark').checked = true;
        }
    }
    localStorage.setItem('bookThingyTheme', theme);
}

        // Event Listeners
        function setupEventListeners() {
 
            // Sort chips
            document.querySelectorAll('.sort-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.sort-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentSort = chip.dataset.sort;
                    renderLibrary();
                });
            });

            // Search
            document.getElementById('searchInput').addEventListener('input', renderLibrary);

            // Forms
            document.getElementById('bookForm').addEventListener('submit', saveBook);
            document.getElementById('lendingForm').addEventListener('submit', lendBook);
            document.getElementById('goalForm').addEventListener('submit', setGoal);

            // Rating stars
            document.querySelectorAll('.rating-star').forEach(star => {
                star.addEventListener('click', () => {
                    selectedRating = parseInt(star.dataset.rating);
                    updateRatingDisplay();
                });
            });

// Status change listener
document.getElementById('bookStatus').addEventListener('change', function() {
    const pastReadGroup = document.getElementById('pastReadGroup');
    if (this.value === 'completed') {
        pastReadGroup.style.display = 'block';
    } else {
        pastReadGroup.style.display = 'none';
        document.getElementById('bookPastRead').checked = false;
    }
});

// ADD THIS NEW EVENT LISTENER HERE
    // Handle format checkbox mutual exclusivity
    document.addEventListener('change', function(e) {
        if (e.target.name === 'bookFormat') {
            const noCopyCheckbox = document.querySelector('input[name="bookFormat"][value="no-copy"]');
            const otherCheckboxes = document.querySelectorAll('input[name="bookFormat"]:not([value="no-copy"])');
            
            if (e.target.value === 'no-copy' && e.target.checked) {
                // If "No Personal Copy" is checked, uncheck all others
                otherCheckboxes.forEach(cb => cb.checked = false);
            } else if (e.target.value !== 'no-copy' && e.target.checked) {
                // If any other format is checked, uncheck "No Personal Copy"
                noCopyCheckbox.checked = false;
            }
        }
    });

 // Export/Import listeners - only for Electron
if (window.electronAPI) {
    window.electronAPI.onExportLibrary((event, filePath) => {
        exportLibrary(filePath);
    });

    window.electronAPI.onImportLibrary((event, filePath) => {
        importLibrary(filePath);
    });
}
}

// View Management
function switchView(viewName) {
    console.log('=== SWITCHING VIEW ===');
    console.log('Target view name:', viewName);
    
    // Remove active from all views
    document.querySelectorAll('.view').forEach(view => {
        console.log('Removing active from:', view.id);
        view.classList.remove('active');
    });
    
    // Find and activate target view
    const targetView = document.getElementById(viewName);
    console.log('Target view element found:', targetView);
    console.log('Target view exists:', !!targetView);
    
    if (targetView) {
        targetView.classList.add('active');
        console.log('Added active class to:', viewName);
        console.log('View has active class:', targetView.classList.contains('active'));
    } else {
        console.error('ERROR: View not found:', viewName);
        return;
    }

    // Render appropriate content
    console.log('Rendering content for:', viewName);
    if (viewName === 'libraryView') {
        console.log('Calling renderLibrary()');
        renderLibrary();
    } else if (viewName === 'statsView') {
        console.log('Calling updateStats()');
        console.log('Current books in library:', library.books.length);
        updateStats();
        
        // Show total books by default
        setTimeout(() => {
            handleStatClick('total');
        }, 100);
    } else if (viewName === 'wishlistView') {
        console.log('Calling renderWishlist()');
        renderWishlist();
    } else if (viewName === 'readingListView') {
        console.log('Calling renderReadingList()');
        renderReadingList();
    } else if (viewName === 'notebookView') {
        console.log('Calling renderNotebook()');
        renderNotebook();
    } else if (viewName === 'lendingView') {
        console.log('Calling renderLending()');
        renderLending();
    } else if (viewName === 'browserView') {
        console.log('Showing browser view');
        // Browser view doesn't need special rendering
    }

    // Update active nav item
    console.log('Updating navigation indicators...');
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });

    // Find and activate the correct nav item
    const navItems = document.querySelectorAll('.nav-item');
    console.log('Number of nav items found:', navItems.length);
    
    if (viewName === 'libraryView' && navItems[0]) {
        navItems[0].classList.add('active');
        console.log('Activated nav item 0 (Library)');
    } else if (viewName === 'statsView' && navItems[1]) {
        navItems[1].classList.add('active');
        console.log('Activated nav item 1 (Stats)');
    } else if (viewName === 'wishlistView' && navItems[2]) {
        navItems[2].classList.add('active');
        console.log('Activated nav item 2 (Wishlist)');
    } else if (viewName === 'readingListView' && navItems[3]) {
        navItems[3].classList.add('active');
        console.log('Activated nav item 3 (Reading List)');
    } else if (viewName === 'notebookView' && navItems[4]) {
        navItems[4].classList.add('active');
        console.log('Activated nav item 4 (Notebook)');
    } else if (viewName === 'lendingView' && navItems[5]) {
        navItems[5].classList.add('active');
        console.log('Activated nav item 5 (Lending)');
    }
    
    console.log('=== VIEW SWITCH COMPLETE ===');
}

        // Data Management
async function loadLibrary() {
    try {
        // Check if user is authenticated and has cloud access
        if (currentUser && hasCloudSyncAccess()) {
            const doc = await db.collection('users').doc(currentUser.uid).get();
            if (doc.exists) {
                const data = doc.data();
                library = {
                    books: data.books || [],
                    wishlist: data.wishlist || [],
                    readingList: data.readingList || [],
                    notebooks: data.notebooks || {},
                    settings: data.settings || { goal2025: null }
                };
                
                // Load subscription status
                if (data.subscriptionStatus) {
                    subscriptionStatus = data.subscriptionStatus;
                    checkSubscriptionStatus(); // Verify it's still valid
                }
                
                console.log('Library loaded from Firebase with cloud sync');
            } else {
                // First time user - create default library and initialize subscription
                library = { books: [], wishlist: [], readingList: [], notebooks: {}, settings: { goal2025: null } };
                initializeSubscription(currentUser);
                await saveLibrary(); // Save the default structure with subscription
            }
        } else {
            // No cloud access or not signed in - use localStorage only
            const saved = localStorage.getItem('bookThingyLibrary');
            library = saved ? JSON.parse(saved) : { books: [], wishlist: [], readingList: [], notebooks: {}, settings: { goal2025: null } };
            
            if (currentUser && !hasCloudSyncAccess()) {
                console.log('Cloud sync not available - using local data only');
                // Check if we need to initialize subscription for signed-in user
                if (subscriptionStatus.subscriptionType === 'none') {
                    initializeSubscription(currentUser);
                }
            }
        }
        
        if (!library.books) library.books = [];
        if (!library.wishlist) library.wishlist = [];
        if (!library.readingList) library.readingList = [];
        if (!library.notebooks) library.notebooks = {};
        if (!library.notebooks) library.notebooks = {};
        if (!library.settings) library.settings = { goal2025: null };
    } catch (error) {
        console.error('Error loading library:', error);
        library = { books: [], wishlist: [], readingList: [], notebooks: {}, settings: { goal2025: null } };
    }
}

async function saveLibrary() {
    try {
        if (currentUser && hasCloudSyncAccess()) {
            // User has cloud sync access - save to Firebase
            const dataToSave = {
                ...library,
                subscriptionStatus: subscriptionStatus
            };
            await db.collection('users').doc(currentUser.uid).set(dataToSave);
            console.log('Data saved to Firebase for user:', currentUser.email);
        } else {
            // No cloud access or not signed in - save to localStorage only
            localStorage.setItem('bookThingyLibrary', JSON.stringify(library));
            
            if (currentUser && !hasCloudSyncAccess()) {
                // User is signed in but doesn't have cloud access
                console.log('Cloud sync not available - saving locally only');
                if (subscriptionStatus.subscriptionType === 'expired') {
                    showToast('Local Save', 'Cloud sync expired - data saved locally only', 'warning');
                }
            }
        }
        // Removed showSaveIndicator() to prevent duplicate notifications
} catch (error) {
        console.error('Error saving library:', error);
        showToast('Save Failed', 'Could not save your library. Please try again.', 'error');
    }
}

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 2000);
        }

        // ADD THE NEW FUNCTION HERE
function getFormatIcon(format) {
    const icons = {
        'hardcover': '📕',
        'paperback': '📗',
        'ebook': '📱',
        'audiobook': '🎧',
        'no-copy': '🚫'
    };
    return icons[format] || '';
}

// Book Management
async function saveBook(e) {
    e.preventDefault();
    
    // Check test drive limits for new books
    const isNewBook = !document.getElementById('bookId').value;
    if (isNewBook && !checkTestDriveLimit()) {
        hideLoading();
        return;
    }
    
    showLoading('Saving book...');
    
    function getCheckedFormats() {
    const checkboxes = document.querySelectorAll('input[name="bookFormat"]:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}
    try {
        const book = {
    id: document.getElementById('bookId').value || Date.now().toString(),
    title: document.getElementById('bookTitle').value,
    author: document.getElementById('bookAuthor').value,
    isbn: document.getElementById('bookISBN').value,
    location: document.getElementById('bookLocation').value,
    genre: document.getElementById('bookGenre').value,
    formats: getCheckedFormats(), // CHANGED from format to formats (plural)
    cover: document.getElementById('bookCover').value,
    status: document.getElementById('bookStatus').value,
    rating: selectedRating,
    summary: document.getElementById('bookSummary').value,
    notes: document.getElementById('bookNotes').value,
    quotes: document.getElementById('bookQuotes').value,
    pastRead: document.getElementById('bookPastRead').checked,
    dateAdded: new Date().toISOString(),
    dateModified: new Date().toISOString()
};

        const existingIndex = library.books.findIndex(b => b.id === book.id);
        if (existingIndex >= 0) {
            library.books[existingIndex] = { ...library.books[existingIndex], ...book };
        } else {
            library.books.push(book);
        }

        await saveLibrary();
        closeModal('addBookModal');
        renderLibrary();
        updateStats();
        showToast('Book Saved', 'Your book has been added to your library!', 'success');
    } catch (error) {
        console.error('Error saving book:', error);
        showToast('Save Failed', 'Could not save your book. Please try again.', 'error');
    } finally {
        hideLoading();
    }
}

async function deleteBook(bookId) {
    if (confirm('Are you sure you want to delete this book?')) {
        try {
            showLoading('Deleting book...');
            library.books = library.books.filter(b => b.id !== bookId);
            await saveLibrary();
            closeModal('bookModal');
            renderLibrary();
            updateStats();
            showToast('Book Deleted', 'The book has been removed from your library.', 'warning');
        } catch (error) {
            console.error('Error deleting book:', error);
            showToast('Delete Failed', 'Could not delete the book. Please try again.', 'error');
        } finally {
            hideLoading();
        }
    }
}

        // Rendering Functions
        function renderLibrary() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            let filteredBooks = library.books.filter(book => 
                book.title.toLowerCase().includes(searchTerm) ||
                book.author.toLowerCase().includes(searchTerm)
            );

            // Sort books
            filteredBooks.sort((a, b) => {
                switch (currentSort) {
                    case 'recent':
                        return new Date(b.dateAdded) - new Date(a.dateAdded);
                    case 'title':
                        return a.title.localeCompare(b.title);
                    case 'author':
                        return a.author.localeCompare(b.author);
                    case 'status':
                        return a.status.localeCompare(b.status);
                    case 'rating':
                        return (b.rating || 0) - (a.rating || 0);
                    case 'genre':  
                        return (a.genre || '').localeCompare(b.genre || '');
                    default:
                        return 0;
                }
            });

            const grid = document.getElementById('bookGrid');
            const emptyState = document.getElementById('emptyState');

            if (filteredBooks.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
grid.innerHTML = filteredBooks.map(book => `
    <div class="book-card ${selectedBooks.has(book.id) ? 'selected' : ''}" 
         data-book-id="${book.id}"
         onclick="${selectionMode ? `toggleBookSelection('${book.id}', event)` : `showBookDetails('${book.id}')`}">
        ${selectionMode ? `
            <div class="book-checkbox" onclick="toggleBookSelection('${book.id}', event)">
                <input type="checkbox" ${selectedBooks.has(book.id) ? 'checked' : ''}>
            </div>
        ` : ''}
        ${book.cover ? 
            `<img src="${book.cover}" alt="${book.title}" class="book-cover" onerror="this.outerHTML='<div class=\\'book-cover\\'>📖</div>'">` :
            `<div class="book-cover">📖</div>`
        }
        <div class="book-info">
            <div class="book-title">${book.title}</div>
            <div class="book-author">${book.author}</div>
            ${book.genre ? `<div class="book-genre">${book.genre}</div>` : ''}
            ${book.rating ? `<div class="rating-display">${'★'.repeat(book.rating)}${'☆'.repeat(5-book.rating)}</div>` : ''}
        </div>
        <div class="book-status status-${book.status}">${book.status.replace('-', ' ')}</div>
    </div>
`).join('');
            }
        }

// Bulk Selection Functions
function toggleSelectionMode() {
    selectionMode = !selectionMode;
    const libraryView = document.getElementById('libraryView');
    const btn = document.getElementById('selectionModeBtn');
    const toolbar = document.getElementById('bulkActionsToolbar');
    
    if (selectionMode) {
        libraryView.classList.add('selection-mode');
        btn.innerHTML = '<span>✕</span><span>Cancel</span>';
        btn.style.background = 'var(--danger)';
        toolbar.style.display = 'block';
        selectedBooks.clear();
        updateSelectedCount();
    } else {
        libraryView.classList.remove('selection-mode');
        btn.innerHTML = '<span>✓</span><span>Select</span>';
        btn.style.background = '';
        toolbar.style.display = 'none';
        selectedBooks.clear();
        // Remove selected class from all books
        document.querySelectorAll('.book-card').forEach(card => {
            card.classList.remove('selected');
        });
    }
    renderLibrary();
}

function toggleBookSelection(bookId, event) {
    if (event) {
        event.stopPropagation();
    }
    
    if (selectedBooks.has(bookId)) {
        selectedBooks.delete(bookId);
        document.querySelector(`[data-book-id="${bookId}"]`).classList.remove('selected');
    } else {
        selectedBooks.add(bookId);
        document.querySelector(`[data-book-id="${bookId}"]`).classList.add('selected');
    }
    
    updateSelectedCount();
}

function updateSelectedCount() {
    document.getElementById('selectedCount').textContent = selectedBooks.size;
}

function selectAll() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    let filteredBooks = library.books.filter(book => 
        book.title.toLowerCase().includes(searchTerm) ||
        book.author.toLowerCase().includes(searchTerm)
    );
    
    filteredBooks.forEach(book => {
        selectedBooks.add(book.id);
    });
    
    // Update UI
    document.querySelectorAll('.book-card').forEach(card => {
        card.classList.add('selected');
        const checkbox = card.querySelector('.book-checkbox input');
        if (checkbox) checkbox.checked = true;
    });
    
    updateSelectedCount();
}

function deselectAll() {
    selectedBooks.clear();
    document.querySelectorAll('.book-card').forEach(card => {
        card.classList.remove('selected');
        const checkbox = card.querySelector('.book-checkbox input');
        if (checkbox) checkbox.checked = false;
    });
    updateSelectedCount();
}

async function bulkDelete() {
    if (selectedBooks.size === 0) {
        showToast('No Selection', 'Please select books to delete', 'warning');
        return;
    }
    
    const confirmText = `Are you sure you want to delete ${selectedBooks.size} book${selectedBooks.size > 1 ? 's' : ''}? This cannot be undone.`;
    
    if (confirm(confirmText)) {
        try {
            showLoading('Deleting books...');
            
            // Remove selected books from library
            library.books = library.books.filter(book => !selectedBooks.has(book.id));
            
            await saveLibrary();
            
            // Exit selection mode
            toggleSelectionMode();
            
            renderLibrary();
            updateStats();
            
            showToast('Books Deleted', `Successfully deleted ${selectedBooks.size} book${selectedBooks.size > 1 ? 's' : ''}`, 'success');
        } catch (error) {
            console.error('Error deleting books:', error);
            showToast('Delete Failed', 'Could not delete books. Please try again.', 'error');
        } finally {
            hideLoading();
        }
    }
}

async function bulkChangeStatus() {
    if (selectedBooks.size === 0) {
        showToast('No Selection', 'Please select books to update', 'warning');
        return;
    }
    
    // Create a simple modal for status selection
    const newStatus = prompt(`Change status for ${selectedBooks.size} book${selectedBooks.size > 1 ? 's' : ''}:\n\n1 = Want to Read\n2 = Currently Reading\n3 = Completed\n4 = Abandoned\n\nEnter number (1-4):`);
    
    const statusMap = {
        '1': 'want-to-read',
        '2': 'reading',
        '3': 'completed',
        '4': 'abandoned'
    };
    
    if (newStatus && statusMap[newStatus]) {
        try {
            showLoading('Updating books...');
            
            // Update status for selected books
            library.books.forEach(book => {
                if (selectedBooks.has(book.id)) {
                    book.status = statusMap[newStatus];
                    book.dateModified = new Date().toISOString();
                }
            });
            
            await saveLibrary();
            
            // Exit selection mode
            toggleSelectionMode();
            
            renderLibrary();
            updateStats();
            
            showToast('Books Updated', `Changed status for ${selectedBooks.size} book${selectedBooks.size > 1 ? 's' : ''}`, 'success');
        } catch (error) {
            console.error('Error updating books:', error);
            showToast('Update Failed', 'Could not update books. Please try again.', 'error');
        } finally {
            hideLoading();
        }
    }
}

  function updateStats() {
    console.log('Updating stats, total books:', library.books.length);

    const total = library.books.length;
    const reading = library.books.filter(b => b.status === 'reading').length;
    
    // Only count completed books that aren't marked as past reads
    const completed = library.books.filter(b => b.status === 'completed' && !b.pastRead).length;
    
    const ratings = library.books.filter(b => b.rating > 0).map(b => b.rating);
    const avgRating = ratings.length > 0 ? 
        (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1) : 
        '0.0';

    // Rest of the function remains the same...

            document.getElementById('totalBooks').textContent = total;
            document.getElementById('currentlyReading').textContent = reading;
            document.getElementById('completedBooks').textContent = completed;
            document.getElementById('averageRating').textContent = avgRating;

            // Update goal progress
            const goal = library.settings.goal2025;
            if (goal) {
                const goalNum = parseInt(goal);
                const progress = Math.min((completed / goalNum) * 100, 100);
                document.getElementById('goalProgress').style.width = progress + '%';
                document.getElementById('goalProgress').textContent = Math.round(progress) + '%';
                document.getElementById('goalText').textContent = `${completed} of ${goalNum} books (${Math.round(goalNum/12)} per month)`;
            }
        }

  function renderWishlist() {
    const wishlistItems = library.wishlist || [];
    const container = document.getElementById('wishlistContainer');
    const empty = document.getElementById('wishlistEmpty');

    if (wishlistItems.length === 0) {
        container.innerHTML = '';
        empty.style.display = 'block';
    } else {
        empty.style.display = 'none';
        container.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0;">Books I Want to Read</h3>
                <button class="btn btn-secondary" onclick="exportWishlist()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                    📤 Export & Share
                </button>
            </div>
            ${wishlistItems.map((item, index) => `
                <div class="book-row-card draggable" draggable="true" data-wishlist-id="${item.id}" data-index="${index}">
                    <div class="drag-handle">⋮⋮</div>
                    ${item.cover ? 
                        `<img src="${item.cover}" alt="${item.title}" class="book-row-thumbnail" onerror="this.outerHTML='<div class=\\'book-row-thumbnail\\' style=\\'display: flex; align-items: center; justify-content: center; font-size: 3rem;\\'>📖</div>'">` :
                        `<div class="book-row-thumbnail" style="display: flex; align-items: center; justify-content: center; font-size: 3rem;">📖</div>`
                    }
                    <div class="book-row-info">
                        <div class="book-row-title">${item.title}</div>
                        <div class="book-row-author">by ${item.author}</div>
                        <div class="book-row-meta">
                            <span>⭐ Wishlist #${index + 1}</span>
                            ${item.price ? `<span>💰 ${item.price}</span>` : ''}
                            ${item.source ? `<span>🔗 ${item.source}</span>` : ''}
                        </div>
                        ${item.description ? `<div class="book-row-summary">${item.description}</div>` : ''}
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="moveToLibrary('${item.id}')" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">
                                📚 Add to Library
                            </button>
                            <button class="btn btn-secondary" onclick="addToReadingList('${item.id}', 'wishlist')" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">
                                📋 Add to Reading List
                            </button>
                            <button class="btn btn-secondary" onclick="removeFromWishlist('${item.id}')" style="padding: 0.25rem 0.75rem; font-size: 0.875rem; background: var(--danger);">
                                🗑️ Remove
                            </button>
                            ${item.url ? `<button class="btn btn-secondary" onclick="window.open('${item.url}', '_blank')" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">🔗 View Online</button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('')}
        `;
        
        // Initialize drag and drop
        initializeWishlistDragDrop();
    }
}

// Drag and drop functionality for wishlist
function initializeWishlistDragDrop() {
    const container = document.getElementById('wishlistContainer');
    const draggableItems = container.querySelectorAll('.book-row-card.draggable');
    
    draggableItems.forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragover', handleDragOver);
        item.addEventListener('drop', handleDrop);
        item.addEventListener('dragend', handleDragEnd);
    });
}

let draggedElement = null;

function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.outerHTML);
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    
    e.dataTransfer.dropEffect = 'move';
    
    // Add visual indicator
    const allCards = document.querySelectorAll('.book-row-card.draggable');
    allCards.forEach(card => card.classList.remove('drag-over'));
    
    if (this !== draggedElement) {
        this.classList.add('drag-over');
    }
    
    return false;
}

function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    
    if (draggedElement !== this) {
        const draggedId = draggedElement.dataset.wishlistId;
        const targetId = this.dataset.wishlistId;
        
        reorderWishlist(draggedId, targetId);
    }
    
    return false;
}

function handleDragEnd(e) {
    const allCards = document.querySelectorAll('.book-row-card.draggable');
    allCards.forEach(card => {
        card.classList.remove('dragging', 'drag-over');
    });
    draggedElement = null;
}

async function reorderWishlist(draggedId, targetId) {
    try {
        const draggedIndex = library.wishlist.findIndex(item => item.id === draggedId);
        const targetIndex = library.wishlist.findIndex(item => item.id === targetId);
        
        if (draggedIndex === -1 || targetIndex === -1) return;
        
        // Remove the dragged item and insert it at the target position
        const draggedItem = library.wishlist.splice(draggedIndex, 1)[0];
        library.wishlist.splice(targetIndex, 0, draggedItem);
        
        await saveLibrary();
        renderWishlist();
        
    } catch (error) {
        console.error('Error reordering wishlist:', error);
        showToast('Error', 'Could not reorder wishlist items', 'error');
    }
}

// Export wishlist functionality
function exportWishlist() {
    if (library.wishlist.length === 0) {
        showToast('Empty Wishlist', 'Your wishlist is empty. Add some books first!', 'warning');
        return;
    }
    
    const wishlistText = generateWishlistText();
    
    // Create a modal to show export options
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Export & Share Wishlist</h3>
                <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--text-dim);">Share your wishlist with friends and family! Books are ordered by priority (most wanted first).</p>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Formatted Text:</label>
                    <textarea readonly style="width: 100%; height: 200px; padding: 1rem; background: var(--surface-light); border: 1px solid var(--surface-light); border-radius: 8px; color: var(--text); font-family: monospace; font-size: 0.875rem;">${wishlistText}</textarea>
                </div>
                
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn" onclick="copyToClipboard(\`${wishlistText.replace(/`/g, '\\`')}\`)">
                        📋 Copy to Clipboard
                    </button>
                    <button class="btn btn-secondary" onclick="downloadWishlist()">
                        💾 Download as File
                    </button>
                    <button class="btn btn-secondary" onclick="shareViaEmail()">
                        📧 Share via Email
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function generateWishlistText() {
    const currentDate = new Date().toLocaleDateString();
    let text = `📚 My Book Wishlist - ${currentDate}\n`;
    text += `═══════════════════════════════════════\n\n`;
    
    library.wishlist.forEach((item, index) => {
        text += `${index + 1}. ${item.title}\n`;
        text += `   by ${item.author}\n`;
        if (item.price) text += `   💰 ${item.price}\n`;
        if (item.url) text += `   🔗 ${item.url}\n`;
        if (item.description) {
            const shortDesc = item.description.length > 100 ? 
                item.description.substring(0, 100) + '...' : 
                item.description;
            text += `   📖 ${shortDesc}\n`;
        }
        text += `\n`;
    });
    
    text += `\n📱 Generated by Book Thingy`;
    return text;
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Copied!', 'Wishlist copied to clipboard', 'success');
    }).catch(() => {
        showToast('Error', 'Could not copy to clipboard', 'error');
    });
}

function downloadWishlist() {
    const text = generateWishlistText();
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `my-book-wishlist-${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('Downloaded!', 'Wishlist saved as file', 'success');
}

function shareViaEmail() {
    const text = generateWishlistText();
    const subject = encodeURIComponent('My Book Wishlist');
    const body = encodeURIComponent(text);
    const mailtoLink = `mailto:?subject=${subject}&body=${body}`;
    window.open(mailtoLink);
}

// Wishlist management functions
async function addCurrentPageToWishlist() {
    const browser = document.getElementById('bookBrowser');
    
    try {
        showLoading('Adding to wishlist...');
        
        // Get page information from the webview
        const title = await browser.executeJavaScript(`document.title`);
        const url = await browser.executeJavaScript(`window.location.href`);
        
        // Try to extract book information from the page
        let bookTitle = '';
        let author = '';
        let cover = '';
        let price = '';
        let description = '';
        
        // Amazon book page detection
        if (url.includes('amazon.com') && url.includes('/dp/')) {
            try {
                bookTitle = await browser.executeJavaScript(`
                    document.querySelector('#productTitle')?.textContent?.trim() || 
                    document.querySelector('h1 span')?.textContent?.trim() || 
                    'Unknown Title'
                `);
                
                author = await browser.executeJavaScript(`
                    document.querySelector('.author .a-link-normal')?.textContent?.trim() || 
                    document.querySelector('span.author')?.textContent?.trim() || 
                    'Unknown Author'
                `);
                
                cover = await browser.executeJavaScript(`
                    document.querySelector('#landingImage')?.src || 
                    document.querySelector('.a-dynamic-image')?.src || 
                    ''
                `);
                
                price = await browser.executeJavaScript(`
                    document.querySelector('.a-price-whole')?.textContent?.trim() || 
                    document.querySelector('.a-price')?.textContent?.trim() || 
                    ''
                `);
                
                description = await browser.executeJavaScript(`
                    document.querySelector('#feature-bullets ul')?.textContent?.trim()?.substring(0, 300) || 
                    ''
                `);
            } catch (e) {
                console.log('Could not extract Amazon book details');
            }
        }
        
        // Fallback to manual input if we couldn't extract details
        if (!bookTitle || bookTitle === 'Unknown Title' || bookTitle === title) {
            bookTitle = prompt('Book Title:', bookTitle || '');
            if (!bookTitle) {
                hideLoading();
                return;
            }
            
            author = prompt('Author:', author || '');
            if (!author) author = 'Unknown Author';
        }
        
        const wishlistItem = {
            id: Date.now().toString(),
            title: bookTitle,
            author: author,
            cover: cover,
            price: price,
            description: description,
            url: url,
            source: new URL(url).hostname,
            dateAdded: new Date().toISOString()
        };
        
        // Check if already in wishlist
        const exists = library.wishlist.find(item => 
            item.title.toLowerCase() === bookTitle.toLowerCase() && 
            item.author.toLowerCase() === author.toLowerCase()
        );
        
        if (exists) {
            showToast('Already in Wishlist', 'This book is already in your wishlist!', 'warning');
            hideLoading();
            return;
        }
        
        library.wishlist.push(wishlistItem);
        await saveLibrary();
        
        showToast('Added to Wishlist', `"${bookTitle}" has been added to your wishlist!`, 'success');
        hideLoading();
        
    } catch (error) {
        console.error('Error adding to wishlist:', error);
        showToast('Error', 'Could not add book to wishlist. Please try again.', 'error');
        hideLoading();
    }
}

// Reading List functionality
function renderReadingList() {
    const readingListItems = library.readingList || [];
    const container = document.getElementById('readingListContainer');
    const empty = document.getElementById('readingListEmpty');

    if (readingListItems.length === 0) {
        container.innerHTML = '';
        empty.style.display = 'block';
    } else {
        empty.style.display = 'none';
        container.innerHTML = `
            <div style="margin-bottom: 1rem;">
                <h3 style="margin: 0 0 0.5rem 0;">My Reading Playlist (${readingListItems.length} books)</h3>
                <p style="color: var(--text-dim); font-size: 0.875rem;">Books are shown in reading order - drag to reorder</p>
            </div>
            ${readingListItems.map((item, index) => {
                const sourceBook = item.source === 'library' ? 
                    library.books.find(b => b.id === item.bookId) :
                    library.wishlist.find(w => w.id === item.bookId);
                
                if (!sourceBook) return ''; // Book no longer exists
                
                const sourceIcon = item.source === 'library' ? '📚' : '⭐';
                const sourceLabel = item.source === 'library' ? 'Library' : 'Wishlist';
                
                return `
                    <div class="book-row-card draggable" draggable="true" data-reading-id="${item.id}" data-index="${index}">
                        <div class="drag-handle">⋮⋮</div>
                        ${sourceBook.cover ? 
                            `<img src="${sourceBook.cover}" alt="${sourceBook.title}" class="book-row-thumbnail" onerror="this.outerHTML='<div class=\\'book-row-thumbnail\\' style=\\'display: flex; align-items: center; justify-content: center; font-size: 3rem;\\'>📖</div>'">` :
                            `<div class="book-row-thumbnail" style="display: flex; align-items: center; justify-content: center; font-size: 3rem;">📖</div>`
                        }
                        <div class="book-row-info">
                            <div class="book-row-title">${sourceBook.title}</div>
                            <div class="book-row-author">by ${sourceBook.author}</div>
                            <div class="book-row-meta">
                                <span>📋 Reading List #${index + 1}</span>
                                <span style="background: var(--primary); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${sourceIcon} ${sourceLabel}</span>
                                ${item.source === 'library' && sourceBook.status ? `<span>📖 ${sourceBook.status}</span>` : ''}
                                ${sourceBook.rating ? `<span>${'⭐'.repeat(sourceBook.rating)}</span>` : ''}
                            </div>
                            ${item.notes ? `<div class="book-row-summary" style="background: var(--surface-light); padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;"><strong>Reading Notes:</strong> ${item.notes}</div>` : ''}
                            ${sourceBook.summary || sourceBook.description ? `<div class="book-row-summary">${sourceBook.summary || sourceBook.description}</div>` : ''}
                            <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                ${item.source === 'library' ? 
                                    `<button class="btn btn-secondary" onclick="showBookDetails('${sourceBook.id}')" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">📖 View Details</button>` :
                                    `<button class="btn btn-secondary" onclick="moveToLibrary('${sourceBook.id}')" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">📚 Add to Library</button>`
                                }
                                <button class="btn btn-secondary" onclick="removeFromReadingList('${item.id}')" style="padding: 0.25rem 0.75rem; font-size: 0.875rem; background: var(--danger);">🗑️ Remove</button>
                            </div>
                        </div>
                    </div>
                `;
            }).filter(html => html).join('')}
        `;
        
        // Initialize drag and drop for reading list
        initializeReadingListDragDrop();
    }
}

function initializeReadingListDragDrop() {
    const container = document.getElementById('readingListContainer');
    const draggableItems = container.querySelectorAll('.book-row-card.draggable');
    
    draggableItems.forEach(item => {
        item.addEventListener('dragstart', handleReadingListDragStart);
        item.addEventListener('dragover', handleReadingListDragOver);
        item.addEventListener('drop', handleReadingListDrop);
        item.addEventListener('dragend', handleReadingListDragEnd);
    });
}

let draggedReadingElement = null;

function handleReadingListDragStart(e) {
    draggedReadingElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
}

function handleReadingListDragOver(e) {
    if (e.preventDefault) e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    
    const allCards = document.querySelectorAll('#readingListContainer .book-row-card.draggable');
    allCards.forEach(card => card.classList.remove('drag-over'));
    
    if (this !== draggedReadingElement) {
        this.classList.add('drag-over');
    }
    return false;
}

function handleReadingListDrop(e) {
    if (e.stopPropagation) e.stopPropagation();
    
    if (draggedReadingElement !== this) {
        const draggedId = draggedReadingElement.dataset.readingId;
        const targetId = this.dataset.readingId;
        reorderReadingList(draggedId, targetId);
    }
    return false;
}

function handleReadingListDragEnd(e) {
    const allCards = document.querySelectorAll('#readingListContainer .book-row-card.draggable');
    allCards.forEach(card => card.classList.remove('dragging', 'drag-over'));
    draggedReadingElement = null;
}

async function reorderReadingList(draggedId, targetId) {
    try {
        // Ensure readingList exists
        if (!library.readingList) {
            library.readingList = [];
            return;
        }
        
        const draggedIndex = library.readingList.findIndex(item => item.id === draggedId);
        const targetIndex = library.readingList.findIndex(item => item.id === targetId);
        
        if (draggedIndex === -1 || targetIndex === -1) return;
        
        const draggedItem = library.readingList.splice(draggedIndex, 1)[0];
        library.readingList.splice(targetIndex, 0, draggedItem);
        
        await saveLibrary();
        renderReadingList();
        
    } catch (error) {
        console.error('Error reordering reading list:', error);
        showToast('Error', 'Could not reorder reading list', 'error');
    }
}

async function addToReadingList(bookId, source) {
    try {
        showLoading('Adding to reading list...');
        
        // Ensure readingList exists
        if (!library.readingList) {
            library.readingList = [];
        }
        
        // Check if already in reading list
        const exists = library.readingList.find(item => item.bookId === bookId && item.source === source);
        if (exists) {
            showToast('Already Added', 'This book is already in your reading list!', 'warning');
            hideLoading();
            return;
        }
        
        const readingItem = {
            id: Date.now().toString(),
            bookId: bookId,
            source: source, // 'library' or 'wishlist'
            dateAdded: new Date().toISOString(),
            notes: ''
        };
        
        library.readingList.push(readingItem);
        await saveLibrary();
        
        // Re-render the reading list if we're currently viewing it
        const activeView = document.querySelector('.view.active')?.id;
        if (activeView === 'readingListView') {
            renderReadingList();
        }
        
        const sourceBook = source === 'library' ? 
            library.books.find(b => b.id === bookId) :
            library.wishlist.find(w => w.id === bookId);
            
        showToast('Added to Reading List', `"${sourceBook?.title}" has been added to your reading list!`, 'success');
        hideLoading();
        
    } catch (error) {
        console.error('Error adding to reading list:', error);
        showToast('Error', 'Could not add book to reading list', 'error');
        hideLoading();
    }
}

async function removeFromWishlist(itemId) {
    if (confirm('Remove this book from your wishlist?')) {
        try {
            showLoading('Removing from wishlist...');
            library.wishlist = library.wishlist.filter(item => item.id !== itemId);
            await saveLibrary();
            renderWishlist();
            showToast('Removed', 'Book removed from wishlist', 'success');
            hideLoading();
        } catch (error) {
            console.error('Error removing from wishlist:', error);
            showToast('Error', 'Could not remove book. Please try again.', 'error');
            hideLoading();
        }
    }
}

async function moveToLibrary(itemId) {
    const wishlistItem = library.wishlist.find(item => item.id === itemId);
    if (!wishlistItem) return;
    
    try {
        showLoading('Moving to library...');
        
        // Create a new book entry
        const book = {
            id: Date.now().toString(),
            title: wishlistItem.title,
            author: wishlistItem.author,
            isbn: '',
            location: '',
            genre: '',
            formats: ['hardcover'], // Default format
            cover: wishlistItem.cover,
            status: 'want-to-read',
            rating: 0,
            summary: wishlistItem.description || '',
            notes: `Added from wishlist. Original source: ${wishlistItem.source}`,
            quotes: '',
            pastRead: false,
            dateAdded: new Date().toISOString(),
            dateModified: new Date().toISOString()
        };
        
        library.books.push(book);
        library.wishlist = library.wishlist.filter(item => item.id !== itemId);
        
        await saveLibrary();
        renderWishlist();
        
        showToast('Moved to Library', `"${book.title}" has been added to your library!`, 'success');
        hideLoading();
        
    } catch (error) {
        console.error('Error moving to library:', error);
        showToast('Error', 'Could not move book to library. Please try again.', 'error');
        hideLoading();
    }
}

// Additional reading list functions
async function removeFromReadingList(itemId) {
    if (confirm('Remove this book from your reading list?')) {
        try {
            showLoading('Removing from reading list...');
            
            // Ensure readingList exists
            if (!library.readingList) {
                library.readingList = [];
                return;
            }
            
            library.readingList = library.readingList.filter(item => item.id !== itemId);
            await saveLibrary();
            renderReadingList();
            showToast('Removed', 'Book removed from reading list', 'success');
            hideLoading();
        } catch (error) {
            console.error('Error removing from reading list:', error);
            showToast('Error', 'Could not remove book', 'error');
            hideLoading();
        }
    }
}

async function addNotesToReadingItem(itemId) {
    // Ensure readingList exists
    if (!library.readingList) {
        library.readingList = [];
        return;
    }
    
    const item = library.readingList.find(r => r.id === itemId);
    if (!item) return;
    
    // Create custom modal for notes input since prompt doesn't work in Electron
    showNotesModal(item.notes || '', async (notes) => {
        if (notes !== null) {
            try {
                showLoading('Saving notes...');
                item.notes = notes;
                await saveLibrary();
                renderReadingList();
                showToast('Notes Saved', 'Reading notes have been updated', 'success');
                hideLoading();
            } catch (error) {
                console.error('Error saving notes:', error);
                showToast('Error', 'Could not save notes', 'error');
                hideLoading();
            }
        }
    });
}

async function clearReadingList() {
    if (confirm('Clear all books from your reading list? This cannot be undone.')) {
        try {
            showLoading('Clearing reading list...');
            library.readingList = [];
            await saveLibrary();
            renderReadingList();
            showToast('Cleared', 'Reading list has been cleared', 'success');
            hideLoading();
        } catch (error) {
            console.error('Error clearing reading list:', error);
            showToast('Error', 'Could not clear reading list', 'error');
            hideLoading();
        }
    }
}

function showAddToReadingListModal() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Add Book to Reading List</h3>
                <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem;">From Your Library</h4>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--surface-light); border-radius: 8px;">
                        ${library.books.length === 0 ? 
                            '<p style="padding: 1rem; text-align: center; color: var(--text-dim);">No books in library</p>' :
                            library.books.map(book => `
                                <div style="display: flex; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--surface-light); cursor: pointer;" 
                                     onclick="addToReadingList('${book.id}', 'library'); this.closest('.modal').remove();">
                                    ${book.cover ? 
                                        `<img src="${book.cover}" style="width: 40px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 1rem;">` :
                                        `<div style="width: 40px; height: 60px; background: var(--surface-light); border-radius: 4px; margin-right: 1rem; display: flex; align-items: center; justify-content: center;">📖</div>`
                                    }
                                    <div>
                                        <div style="font-weight: 600;">${book.title}</div>
                                        <div style="color: var(--text-dim); font-size: 0.875rem;">by ${book.author}</div>
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
                
                <div>
                    <h4 style="margin-bottom: 1rem;">From Your Wishlist</h4>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--surface-light); border-radius: 8px;">
                        ${library.wishlist.length === 0 ? 
                            '<p style="padding: 1rem; text-align: center; color: var(--text-dim);">No books in wishlist</p>' :
                            library.wishlist.map(item => `
                                <div style="display: flex; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--surface-light); cursor: pointer;" 
                                     onclick="addToReadingList('${item.id}', 'wishlist'); this.closest('.modal').remove();">
                                    ${item.cover ? 
                                        `<img src="${item.cover}" style="width: 40px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 1rem;">` :
                                        `<div style="width: 40px; height: 60px; background: var(--surface-light); border-radius: 4px; margin-right: 1rem; display: flex; align-items: center; justify-content: center;">📖</div>`
                                    }
                                    <div>
                                        <div style="font-weight: 600;">${item.title}</div>
                                        <div style="color: var(--text-dim); font-size: 0.875rem;">by ${item.author}</div>
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Notebook functionality
let currentNotebookBook = null;
let currentNotebookPage = null;

// Make variables globally accessible
window.currentNotebookBook = currentNotebookBook;
window.currentNotebookPage = currentNotebookPage;

function renderNotebook() {
    // Reset state
    currentNotebookBook = null;
    currentNotebookPage = null;
    
    // Hide book sidebar initially
    document.getElementById('notebookBookSidebar').classList.remove('active');
    
    renderNotebookBookList();
    showNotebookEmptyState();
    
    // Add search functionality (remove any existing listeners first)
    const searchInput = document.getElementById('notebookSearchInput');
    searchInput.removeEventListener('input', handleNotebookSearch);
    searchInput.addEventListener('input', handleNotebookSearch);
}

function handleNotebookSearch(event) {
    renderNotebookBookList(event.target.value);
}

function renderNotebookBookList(searchTerm = '') {
    const container = document.getElementById('notebookBookList');
    const books = library.books.filter(book => {
        if (!searchTerm) return true;
        return book.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
               book.author.toLowerCase().includes(searchTerm.toLowerCase());
    });
    
    if (books.length === 0) {
        container.innerHTML = `
            <div style="padding: 2rem; text-align: center; color: var(--text-dim);">
                <div style="font-size: 2rem; margin-bottom: 1rem;">📚</div>
                <p>${searchTerm ? 'No books found matching your search' : 'No books in your library yet'}</p>
                <p style="font-size: 0.875rem; margin-top: 0.5rem;">Add books to your library to start taking notes</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = books.map(book => `
        <div class="notebook-book-item ${currentNotebookBook?.id === book.id ? 'active' : ''}" 
             onclick="selectNotebookBook('${book.id}')">
            ${book.cover ? 
                `<img src="${book.cover}" alt="${book.title}" class="notebook-book-cover" onerror="this.outerHTML='<div class=\\'notebook-book-cover\\' style=\\'display: flex; align-items: center; justify-content: center; font-size: 1.5rem;\\'>📖</div>'">` :
                `<div class="notebook-book-cover" style="display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">📖</div>`
            }
            <div class="notebook-book-info">
                <div class="notebook-book-title">${book.title}</div>
                <div class="notebook-book-author">by ${book.author}</div>
            </div>
        </div>
    `).join('');
}

function selectNotebookBook(bookId) {
    const book = library.books.find(b => b.id === bookId);
    if (!book) return;
    
    currentNotebookBook = book;
    currentNotebookPage = null;
    
    // Update global variables
    window.currentNotebookBook = currentNotebookBook;
    window.currentNotebookPage = currentNotebookPage;
    
    // Update UI
    renderNotebookBookList();
    
    // Show book sidebar
    const sidebar = document.getElementById('notebookBookSidebar');
    sidebar.classList.add('active');
    
    // Update book title
    document.getElementById('notebookBookTitle').textContent = book.title;
    const addPageBtn = document.getElementById('notebookAddPageBtn');
    addPageBtn.style.display = 'block';
    
    // Remove existing event listeners and add new one
    addPageBtn.removeEventListener('click', addNotebookPage);
    addPageBtn.addEventListener('click', function() {
        console.log('=== BUTTON CLICKED VIA EVENT LISTENER ===');
        console.log('currentNotebookBook:', currentNotebookBook);
        addNotebookPage();
    });
    
    // Ensure notebooks object exists
    if (!library.notebooks) {
        library.notebooks = {};
    }
    
    // Initialize notebook for this book if it doesn't exist
    if (!library.notebooks[bookId]) {
        library.notebooks[bookId] = {
            bookId: bookId,
            pages: []
        };
    }
    
    renderNotebookPages();
    showNotebookEmptyState();
}

function renderNotebookPages() {
    const container = document.getElementById('notebookPagesList');
    const notebook = library.notebooks[currentNotebookBook.id];
    
    if (!notebook || notebook.pages.length === 0) {
        container.innerHTML = `
            <div style="padding: 2rem; text-align: center; color: var(--text-dim);">
                <div style="font-size: 2rem; margin-bottom: 1rem;">📄</div>
                <p>No pages yet</p>
                <p style="font-size: 0.875rem; margin-top: 0.5rem;">Click "Add Page" to start taking notes</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = notebook.pages.map((page, index) => `
        <div class="notebook-page-item ${currentNotebookPage?.id === page.id ? 'active' : ''}" 
             onclick="selectNotebookPage('${page.id}')">
            <div class="notebook-page-name">${page.name}</div>
            <div class="notebook-page-actions">
                <button class="notebook-page-action" onclick="event.stopPropagation(); renameNotebookPage('${page.id}')" title="Rename">✏️</button>
                <button class="notebook-page-action" onclick="event.stopPropagation(); deleteNotebookPage('${page.id}')" title="Delete">🗑️</button>
            </div>
        </div>
    `).join('');
}

function addNotebookPage() {
    console.log('=== ADD NOTEBOOK PAGE CALLED ===');
    console.log('currentNotebookBook:', currentNotebookBook);
    
    if (!currentNotebookBook) {
        console.error('No book selected');
        alert('Please select a book first');
        return;
    }
    
    // Create custom input modal since prompt() doesn't work in Electron
    showPageNameModal((pageName) => {
        console.log('User entered page name:', pageName);
        if (!pageName || pageName.trim() === '') {
            console.log('Page name was empty, returning');
            return;
        }
        createNotebookPage(pageName.trim());
    });
}

function showPageNameModal(callback) {
    console.log('=== SHOW PAGE NAME MODAL CALLED ===');
    window.pageNameCallback = callback;
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(10px);
    `;
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Add New Page</h2>
            </div>
            <div class="modal-body">
                <label class="form-label">Page Name:</label>
                <input type="text" id="pageNameInput" class="form-input" value="New Page" style="margin-bottom: 1rem;">
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between; padding: 1rem;">
                <button class="btn btn-primary" onclick="submitPageName()">Create Page</button>
                <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
            </div>
        </div>
    `;
    
    console.log('Modal created, appending to body...');
    document.body.appendChild(modal);
    console.log('Modal appended successfully');
    
    // Focus and select the input
    setTimeout(() => {
        const input = document.getElementById('pageNameInput');
        if (input) {
            input.focus();
            input.select();
            console.log('Input focused');
        } else {
            console.log('Input not found!');
        }
    }, 100);
}

function submitPageName() {
    const name = document.getElementById('pageNameInput').value;
    document.querySelector('.modal-overlay').remove();
    if (window.pageNameCallback) {
        window.pageNameCallback(name);
    }
}

function createNotebookPage(pageName) {
    try {
        console.log('Creating page for book:', currentNotebookBook.id);
        
        // Ensure notebooks object exists
        if (!library.notebooks) {
            library.notebooks = {};
            console.log('Created notebooks object');
        }
        
        // Ensure notebook exists for this book
        if (!library.notebooks[currentNotebookBook.id]) {
            library.notebooks[currentNotebookBook.id] = {
                bookId: currentNotebookBook.id,
                pages: []
            };
        }
        
        const page = {
            id: Date.now().toString(),
            name: pageName.trim(),
            content: '<p>Start writing your notes...</p>',
            dateCreated: new Date().toISOString(),
            dateModified: new Date().toISOString()
        };
        
        library.notebooks[currentNotebookBook.id].pages.push(page);
        
        console.log('Page created:', page);
        console.log('Total pages now:', library.notebooks[currentNotebookBook.id].pages.length);
        
        saveLibrary();
        renderNotebookPages();
        selectNotebookPage(page.id);
        
        console.log(`Page "${pageName}" has been created successfully!`);
    } catch (error) {
        console.error('Error adding notebook page:', error);
        alert('Error creating page. Check console for details.');
    }
}

// Make functions globally accessible
window.addNotebookPage = addNotebookPage;
window.selectNotebookBook = selectNotebookBook;
window.selectNotebookPage = selectNotebookPage;
window.renameNotebookPage = renameNotebookPage;
window.deleteNotebookPage = deleteNotebookPage;
window.formatText = formatText;
window.insertQuote = insertQuote;
window.handlePaste = handlePaste;
window.submitPageName = submitPageName;
window.showColorPicker = showColorPicker;
window.insertLink = insertLink;
window.clearFormatting = clearFormatting;

function selectNotebookPage(pageId) {
    console.log('=== SELECT NOTEBOOK PAGE CALLED ===');
    console.log('pageId:', pageId);
    console.log('currentNotebookBook:', currentNotebookBook);
    
    const notebook = library.notebooks[currentNotebookBook.id];
    console.log('notebook:', notebook);
    
    const page = notebook.pages.find(p => p.id === pageId);
    console.log('found page:', page);
    
    if (!page) {
        console.log('Page not found, returning');
        return;
    }
    
    currentNotebookPage = page;
    window.currentNotebookPage = currentNotebookPage;
    
    console.log('Selected page:', currentNotebookPage);
    renderNotebookPages();
    showNotebookEditor();
}

function showNotebookEditor() {
    console.log('=== SHOW NOTEBOOK EDITOR CALLED ===');
    console.log('currentNotebookPage:', currentNotebookPage);
    if (!currentNotebookPage) {
        console.log('No current page, returning');
        return;
    }
    
    const container = document.getElementById('notebookEditorContainer');
    container.innerHTML = `
        <div class="notebook-editor-header">
            <div class="notebook-editor-title">${currentNotebookPage.name}</div>
            <div style="font-size: 0.875rem; color: var(--text-dim);">
                Last modified: ${new Date(currentNotebookPage.dateModified).toLocaleDateString()}
            </div>
        </div>
        <div class="notebook-toolbar">
            <div class="notebook-toolbar-group">
                <select class="notebook-toolbar-select" onchange="formatText('formatBlock', this.value)">
                    <option value="div">Normal</option>
                    <option value="h1">Heading 1</option>
                    <option value="h2">Heading 2</option>
                    <option value="h3">Heading 3</option>
                    <option value="h4">Heading 4</option>
                    <option value="p">Paragraph</option>
                    <option value="pre">Code Block</option>
                </select>
            </div>
            <div class="notebook-toolbar-group">
                <select class="notebook-toolbar-select" style="min-width: 80px;" onchange="formatText('fontName', this.value)">
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times</option>
                    <option value="Courier New">Courier</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Verdana">Verdana</option>
                    <option value="Comic Sans MS">Comic Sans</option>
                </select>
                <select class="notebook-toolbar-select" style="min-width: 60px;" onchange="formatText('fontSize', this.value)">
                    <option value="1">8pt</option>
                    <option value="2">10pt</option>
                    <option value="3" selected>12pt</option>
                    <option value="4">14pt</option>
                    <option value="5">18pt</option>
                    <option value="6">24pt</option>
                    <option value="7">36pt</option>
                </select>
            </div>
            <div class="notebook-toolbar-group">
                <button class="notebook-toolbar-btn" onclick="formatText('bold')" title="Bold (Ctrl+B)"><b>B</b></button>
                <button class="notebook-toolbar-btn" onclick="formatText('italic')" title="Italic (Ctrl+I)"><i>I</i></button>
                <button class="notebook-toolbar-btn" onclick="formatText('underline')" title="Underline (Ctrl+U)"><u>U</u></button>
                <button class="notebook-toolbar-btn" onclick="formatText('strikeThrough')" title="Strikethrough"><s>S</s></button>
                <button class="notebook-toolbar-btn" onclick="showColorPicker('foreColor')" title="Text Color">🎨</button>
                <button class="notebook-toolbar-btn" onclick="showColorPicker('hiliteColor')" title="Highlight">🖍️</button>
            </div>
            <div class="notebook-toolbar-group">
                <button class="notebook-toolbar-btn" onclick="formatText('justifyLeft')" title="Align Left">⬅</button>
                <button class="notebook-toolbar-btn" onclick="formatText('justifyCenter')" title="Center">⬌</button>
                <button class="notebook-toolbar-btn" onclick="formatText('justifyRight')" title="Align Right">➡</button>
                <button class="notebook-toolbar-btn" onclick="formatText('justifyFull')" title="Justify">☰</button>
            </div>
            <div class="notebook-toolbar-group">
                <button class="notebook-toolbar-btn" onclick="formatText('insertUnorderedList')" title="Bullet List">•</button>
                <button class="notebook-toolbar-btn" onclick="formatText('insertOrderedList')" title="Numbered List">1.</button>
                <button class="notebook-toolbar-btn" onclick="formatText('indent')" title="Indent">→|</button>
                <button class="notebook-toolbar-btn" onclick="formatText('outdent')" title="Outdent">|←</button>
            </div>
            <div class="notebook-toolbar-group">
                <button class="notebook-toolbar-btn" onclick="insertLink()" title="Insert Link">🔗</button>
                <button class="notebook-toolbar-btn" onclick="insertQuote()" title="Quote">❝</button>
                <button class="notebook-toolbar-btn" onclick="formatText('insertHorizontalRule')" title="Horizontal Line">—</button>
                <button class="notebook-toolbar-btn" onclick="clearFormatting()" title="Clear Formatting">✕</button>
            </div>
            <div class="notebook-toolbar-group">
                <button class="notebook-toolbar-btn" onclick="formatText('undo')" title="Undo (Ctrl+Z)">↶</button>
                <button class="notebook-toolbar-btn" onclick="formatText('redo')" title="Redo (Ctrl+Y)">↷</button>
            </div>
        </div>
        <div class="notebook-rich-editor" 
             contenteditable="true" 
             id="notebookRichEditor"
             oninput="saveNotebookContent()"
             onpaste="handlePaste(event)"
             placeholder="Start writing your notes...">${currentNotebookPage.content || '<p>Start writing your notes...</p>'}</div>
    `;
    
    // Set up the editor
    const editor = document.getElementById('notebookRichEditor');
    editor.focus();
}

function showNotebookEmptyState() {
    if (currentNotebookPage) return;
    
    const container = document.getElementById('notebookEditorContainer');
    container.innerHTML = `
        <div class="notebook-empty-state">
            <div class="notebook-empty-icon">📝</div>
            <h3>${currentNotebookBook ? currentNotebookBook.title : 'Reading Notebook'}</h3>
            <p style="margin-top: 0.5rem;">
                ${currentNotebookBook ? 'Select a page or add a new one to start taking notes' : 'Select a book from your library to start taking notes'}
            </p>
        </div>
    `;
}

let saveTimeout = null;

function saveNotebookContent() {
    if (!currentNotebookPage) return;
    
    const editor = document.getElementById('notebookRichEditor');
    if (editor) {
        currentNotebookPage.content = editor.innerHTML;
        currentNotebookPage.dateModified = new Date().toISOString();
        
        // Debounce saving
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            saveLibrary();
        }, 1000);
    }
}

// Rich text editor functions
function formatText(command, value = null) {
    document.execCommand(command, false, value);
    document.getElementById('notebookRichEditor').focus();
    saveNotebookContent();
}

function insertQuote() {
    const selection = window.getSelection();
    if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const selectedText = range.toString();
        
        if (selectedText) {
            const blockquote = document.createElement('blockquote');
            blockquote.innerHTML = selectedText;
            range.deleteContents();
            range.insertNode(blockquote);
        } else {
            formatText('formatBlock', 'blockquote');
        }
    }
    saveNotebookContent();
}

function handlePaste(event) {
    event.preventDefault();
    const text = (event.clipboardData || window.clipboardData).getData('text/plain');
    document.execCommand('insertText', false, text);
    saveNotebookContent();
}

function showColorPicker(command) {
    // Create a color input dynamically
    const colorInput = document.createElement('input');
    colorInput.type = 'color';
    colorInput.value = command === 'foreColor' ? '#000000' : '#FFFF00';
    
    colorInput.addEventListener('change', (e) => {
        formatText(command, e.target.value);
        colorInput.remove();
    });
    
    colorInput.click();
}

function insertLink() {
    // Create custom modal for link input since prompt doesn't work in Electron
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(10px);
    `;
    
    const selectedText = window.getSelection().toString();
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Insert Link</h2>
            </div>
            <div class="modal-body">
                <label class="form-label">URL:</label>
                <input type="url" id="linkUrlInput" class="form-input" placeholder="https://example.com" style="margin-bottom: 1rem;">
                <label class="form-label">Link Text:</label>
                <input type="text" id="linkTextInput" class="form-input" value="${selectedText}" placeholder="Link text" style="margin-bottom: 1rem;">
            </div>
            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                <button class="btn btn-primary" onclick="insertLinkFromModal()">Insert Link</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    document.getElementById('linkUrlInput').focus();
}

function insertLinkFromModal() {
    const url = document.getElementById('linkUrlInput').value;
    const text = document.getElementById('linkTextInput').value || url;
    
    if (url) {
        document.execCommand('insertHTML', false, `<a href="${url}" target="_blank">${text}</a>`);
    }
    
    document.querySelector('.modal-overlay').remove();
}

window.insertLinkFromModal = insertLinkFromModal;

function clearFormatting() {
    document.execCommand('removeFormat', false, null);
    document.execCommand('formatBlock', false, 'div');
}

function renameNotebookPage(pageId) {
    const notebook = library.notebooks[currentNotebookBook.id];
    const page = notebook.pages.find(p => p.id === pageId);
    if (!page) return;
    
    const newName = prompt('Enter new page name:', page.name);
    if (!newName || newName === page.name) return;
    
    page.name = newName;
    page.dateModified = new Date().toISOString();
    saveLibrary();
    renderNotebookPages();
    
    if (currentNotebookPage?.id === pageId) {
        showNotebookEditor();
    }
}

function deleteNotebookPage(pageId) {
    if (!confirm('Delete this page? This cannot be undone.')) return;
    
    const notebook = library.notebooks[currentNotebookBook.id];
    notebook.pages = notebook.pages.filter(p => p.id !== pageId);
    
    if (currentNotebookPage?.id === pageId) {
        currentNotebookPage = null;
        showNotebookEmptyState();
    }
    
    saveLibrary();
    renderNotebookPages();
}

function renderLending() {
    const lentBooks = library.books.filter(b => b.lentTo);
    const list = document.getElementById('lendingList');
    const empty = document.getElementById('lendingEmpty');

    if (lentBooks.length === 0) {
        list.innerHTML = '';
        empty.style.display = 'block';
    } else {
        empty.style.display = 'none';
        list.innerHTML = lentBooks.map(book => {
            const daysSince = Math.floor((new Date() - new Date(book.lentDate)) / (1000 * 60 * 60 * 24));
            return `
                <div class="lending-item" onclick="showBookDetails('${book.id}')" style="cursor: pointer;">
                    ${book.cover ? 
                        `<img src="${book.cover}" alt="${book.title}" class="lending-book-cover">` :
                        `<div class="lending-book-cover">📖</div>`
                    }
                    <div class="lending-info">
                        <div class="lending-borrower">${book.lentTo}</div>
                        <div class="lending-date">${book.title} • ${daysSince} days ago</div>
                        ${book.lentPhone ? `<div class="lending-contact" style="font-size: 0.8125rem; color: var(--text-dim); margin-top: 0.25rem;">📱 ${book.lentPhone}</div>` : ''}
                        ${book.lentEmail ? `<div class="lending-contact" style="font-size: 0.8125rem; color: var(--text-dim); margin-top: 0.125rem;">📧 ${book.lentEmail}</div>` : ''}
                    </div>
                    <button class="return-btn" onclick="event.stopPropagation(); returnBook('${book.id}')">Return</button>
                </div>
            `;
        }).join('');
        
        // Add event listeners after rendering
        list.querySelectorAll('.lending-item').forEach(item => {
            item.addEventListener('click', function(e) {
                if (!e.target.classList.contains('return-btn')) {
                    const bookId = this.getAttribute('data-book-id');
                    showBookDetails(bookId);
                }
            });
        });
        
        list.querySelectorAll('.return-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const bookId = this.getAttribute('data-book-id');
                returnBook(bookId);
            });
        });
    }
}

        // Stat card click handler
        let activeStatType = null;

        function handleStatClick(type) {
            // If clicking the same stat card, toggle it off
            if (activeStatType === type) {
                document.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));
                document.getElementById('bookRowContainer').classList.remove('active');
                activeStatType = null;
                return;
            }
            
            // Remove active class from all stat cards
            document.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));
            
            // Get the clicked card and add active class
            const clickedCard = event.currentTarget;
            clickedCard.classList.add('active');
            
            // Set active stat type
            activeStatType = type;
            
            // Get filtered books based on ownership
            let filteredBooks = library.books.filter(book => {
                // Handle both old format (single string) and new formats (array)
                if (book.formats && Array.isArray(book.formats)) {
                    // New format: array of formats
                    return book.formats.length > 0 && !book.formats.includes('no-copy');
                } else if (book.format && typeof book.format === 'string') {
                    // Old format: single string
                    return book.format !== 'no-copy';
                } else {
                    // No format specified - assume they have a copy for backwards compatibility
                    return true;
                }
            });
            
            // Further filter based on the clicked stat
            switch(type) {
                case 'total':
                    // Already filtered for ownership
                    break;
                case 'reading':
                    filteredBooks = filteredBooks.filter(b => b.status === 'reading');
                    break;
                case 'completed':
                    filteredBooks = filteredBooks.filter(b => b.status === 'completed' && !b.pastRead);
                    break;
                case 'rating':
                    filteredBooks = filteredBooks.filter(b => b.rating >= 4).sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    break;
            }
            
            // Show/hide the book row container
            const container = document.getElementById('bookRowContainer');
            if (filteredBooks.length > 0) {
                container.classList.add('active');
                renderBookRows(filteredBooks, type);
            } else {
                container.classList.add('active');
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-dim);">
                        <p style="font-size: 1.125rem;">No books found in this category that you own.</p>
                        <p style="margin-top: 0.5rem;">Books marked as "No Personal Copy" are not included.</p>
                    </div>
                `;
            }
        }

        function renderBookRows(books, type) {
            const container = document.getElementById('bookRowContainer');
            let title = '';
            
            switch(type) {
                case 'total':
                    title = 'All Books You Own';
                    break;
                case 'reading':
                    title = 'Currently Reading';
                    break;
                case 'completed':
                    title = 'Completed Books';
                    break;
                case 'rating':
                    title = 'Highly Rated Books (4+ stars)';
                    break;
            }
            
            container.innerHTML = `
                <h3 style="margin-bottom: 1rem;">${title}</h3>
                ${books.map(book => `
                    <div class="book-row-card" onclick="showBookDetails('${book.id}')">
                        ${book.cover ? 
                            `<img src="${book.cover}" alt="${book.title}" class="book-row-thumbnail" onerror="this.outerHTML='<div class=\\'book-row-thumbnail\\' style=\\'display: flex; align-items: center; justify-content: center; font-size: 3rem;\\'>📖</div>'">` :
                            `<div class="book-row-thumbnail" style="display: flex; align-items: center; justify-content: center; font-size: 3rem;">📖</div>`
                        }
                        <div class="book-row-info">
                            <div class="book-row-title">${book.title}</div>
                            <div class="book-row-author">by ${book.author}</div>
                            <div class="book-row-meta">
                                <span>${book.status === 'reading' ? '📖 Reading' : book.status === 'completed' ? '✅ Completed' : book.status === 'want-to-read' ? '📚 Want to Read' : '⏸️ Abandoned'}</span>
                                ${book.rating ? `<span>${'⭐'.repeat(book.rating)}</span>` : ''}
                                ${book.genre ? `<span>📂 ${book.genre}</span>` : ''}
                            </div>
                            ${book.summary ? `<div class="book-row-summary">${book.summary}</div>` : ''}
                            <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                <button class="btn btn-secondary" onclick="event.stopPropagation(); addToReadingList('${book.id}', 'library')" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">
                                    📋 Add to Reading List
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // Modal Functions
        function showBookDetails(bookId) {
            const book = library.books.find(b => b.id === bookId);
            if (!book) return;

            currentBookId = bookId;
            document.getElementById('modalBookTitle').textContent = book.title;
            
            document.getElementById('bookModalBody').innerHTML = `
                <div style="display: flex; gap: 1.5rem; margin-bottom: 1.5rem;">
                    ${book.cover ? 
                        `<img src="${book.cover}" alt="${book.title}" style="width: 120px; height: 180px; object-fit: cover; border-radius: var(--radius);" onerror="this.outerHTML='<div style=\\'width: 120px; height: 180px; background: var(--surface-light); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; font-size: 3rem;\\'>📖</div>'">` :
                        `<div style="width: 120px; height: 180px; background: var(--surface-light); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; font-size: 3rem;">📖</div>`
                    }
<div style="flex: 1;">
    <p style="margin-bottom: 0.5rem;"><strong>Author:</strong> ${book.author}</p>
    ${book.isbn ? `<p style="margin-bottom: 0.5rem;"><strong>ISBN:</strong> ${book.isbn}</p>` : ''}
    ${book.location ? `<p style="margin-bottom: 0.5rem;"><strong>Location:</strong> ${book.location}</p>` : ''}
    <p style="margin-bottom: 0.5rem;"><strong>Status:</strong> <span class="book-status status-${book.status}" style="position: static; font-size: 0.75rem;">${book.status.replace('-', ' ')}</span></p>
    ${book.rating ? `<p style="margin-bottom: 0.5rem;"><strong>Rating:</strong> ${'★'.repeat(book.rating)}${'☆'.repeat(5-book.rating)}</p>` : ''}
   ${book.formats && book.formats.length > 0 ? 
    book.formats.includes('no-copy') ? 
        `<p style="margin-bottom: 0.5rem;"><strong>Format:</strong> <span style="color: var(--text-dim);">No Personal Copy</span></p>` :
        `<p style="margin-bottom: 0.5rem;"><strong>Formats:</strong> ${book.formats.map(f => f.charAt(0).toUpperCase() + f.slice(1)).join(', ')}</p>` : 
    book.format ? `<p style="margin-bottom: 0.5rem;"><strong>Format:</strong> ${book.format.charAt(0).toUpperCase() + book.format.slice(1)}</p>` : ''
}
</div>
                </div>

                ${book.summary ? `
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 0.5rem;">Summary</h3>
                        <p style="color: var(--text-dim);">${book.summary}</p>
                    </div>
                ` : ''}

                ${book.notes ? `
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 0.5rem;">Notes</h3>
                        <p style="color: var(--text-dim);">${book.notes}</p>
                    </div>
                ` : ''}

                ${book.quotes ? `
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 0.5rem;">Favorite Quotes</h3>
                        <p style="color: var(--text-dim); white-space: pre-wrap;">${book.quotes}</p>
                    </div>
                ` : ''}

                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn" onclick="editBook('${book.id}')">Edit</button>
                    ${!book.lentTo ? 
                        `<button class="btn btn-secondary" onclick="showLendingModal('${book.id}')">Lend</button>` : 
                        ''
                    }
                    <button class="btn btn-secondary" style="background: var(--danger);" onclick="deleteBook('${book.id}')">Delete</button>
                </div>
            `;

            openModal('bookModal');
        }


function showManualEntry() {
    console.log('showManualEntry called');
    currentBookId = null;
    selectedRating = 0;
    document.getElementById('addBookTitle').textContent = 'Add Book';
    document.getElementById('bookForm').reset();
    updateRatingDisplay();
    document.getElementById('coverPreview').style.display = 'none';
    openModal('addBookModal');
    document.getElementById('addOptions').classList.remove('active');
}

function showAddOptions() {
    // Create a modal for add options
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(10px);
    `;
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Add Book</h2>
            </div>
            <div class="modal-body">
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;" onclick="this.closest('.modal-overlay').remove(); showBarcodeScanner();">
                    <span>📷</span>
                    <span>Scan Barcode</span>
                </button>
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;" onclick="this.closest('.modal-overlay').remove(); showInternetSearch();">
                    <span>🔍</span>
                    <span>Search Internet</span>
                </button>
                <button class="btn btn-primary" style="width: 100%; display: flex; align-items: center; gap: 0.5rem;" onclick="this.closest('.modal-overlay').remove(); showManualEntry();">
                    <span>✏️</span>
                    <span>Manual Entry</span>
                </button>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: center; padding: 1rem;">
                <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function editBook(bookId) {
    const book = library.books.find(b => b.id === bookId);
    if (!book) return;

    currentBookId = bookId;
    selectedRating = book.rating || 0;
    
    document.getElementById('addBookTitle').textContent = 'Edit Book';
    document.getElementById('bookId').value = book.id;
    document.getElementById('bookTitle').value = book.title;
    document.getElementById('bookAuthor').value = book.author;
    document.getElementById('bookISBN').value = book.isbn || '';
    document.getElementById('bookLocation').value = book.location || '';
    document.getElementById('bookCover').value = book.cover || '';
    document.getElementById('bookStatus').value = book.status;
    document.getElementById('bookSummary').value = book.summary || '';
    document.getElementById('bookNotes').value = book.notes || '';
    document.getElementById('bookQuotes').value = book.quotes || '';
    
    // Safe check for genre field
    if (document.getElementById('bookGenre')) {
        document.getElementById('bookGenre').value = book.genre || '';
    }
    
    // Handle format checkboxes
    // First, uncheck all format checkboxes
    document.querySelectorAll('input[name="bookFormat"]').forEach(cb => cb.checked = false);
    
    // Then check the ones that match the book's formats
    if (book.formats && Array.isArray(book.formats)) {
        book.formats.forEach(format => {
            const checkbox = document.querySelector(`input[name="bookFormat"][value="${format}"]`);
            if (checkbox) checkbox.checked = true;
        });
    } else if (book.format) {
        // Handle old single format data
        const checkbox = document.querySelector(`input[name="bookFormat"][value="${book.format}"]`);
        if (checkbox) checkbox.checked = true;
    }
    
    // Handle past read checkbox
    if (book.status === 'completed') {
        document.getElementById('pastReadGroup').style.display = 'block';
        document.getElementById('bookPastRead').checked = book.pastRead || false;
    } else {
        document.getElementById('pastReadGroup').style.display = 'none';
        document.getElementById('bookPastRead').checked = false;
    }
    
    updateRatingDisplay();
    closeModal('bookModal');
    openModal('addBookModal');
}

function showBarcodeScanner() {
    console.log('showBarcodeScanner called');
    showToast('Coming Soon', 'Barcode scanner feature will be available in a future update!', 'info');
    document.getElementById('addOptions').classList.remove('active');
}

function showInternetSearch() {
    console.log('showInternetSearch called');
    openModal('searchModal');
    document.getElementById('addOptions').classList.remove('active');
    
    // Clear previous search
    document.getElementById('internetSearchInput').value = '';
    document.getElementById('searchResults').innerHTML = '';
    
    // Force focus after a short delay
    setTimeout(() => {
        const searchInput = document.getElementById('internetSearchInput');
        searchInput.focus();
        searchInput.click();
    }, 100);
}

        function showLendingModal(bookId) {
                console.log('showManualEntry called');
            document.getElementById('lendBookId').value = bookId;
            document.getElementById('lendingForm').reset();
            closeModal('bookModal');
            openModal('lendingModal');
        }

        function showGoalModal() {
            const currentGoal = library.settings.goal2025;
            if (currentGoal) {
                document.getElementById('goalInput').value = currentGoal;
            }
            openModal('goalModal');
        }

        // Handle cover image upload
function handleCoverUpload(event) {
    const file = event.target.files[0];
    if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const dataUrl = e.target.result;
            document.getElementById('bookCover').value = dataUrl;
            
            // Show preview
            document.getElementById('coverPreviewImg').src = dataUrl;
            document.getElementById('coverPreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        showToast('Invalid File', 'Please select an image file', 'error');
    }
}

        // Modal Controls
function openModal(modalId) {
    console.log('=== openModal called ===');
    console.log('Modal ID:', modalId);
    console.log('Caller:', new Error().stack.split('\n')[2]);
    
    // Close all other modals first
    document.querySelectorAll('.modal.active').forEach(modal => {
        if (modal.id !== modalId) {
            modal.classList.remove('active');
        }
    });
    
    const modal = document.getElementById(modalId);
    if (!modal) {
        console.error('Modal not found:', modalId);
        return;
    }
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // Special handling for search modal
    if (modalId === 'searchModal') {
        setTimeout(() => {
            const searchInput = document.getElementById('internetSearchInput');
            if (searchInput) {
                searchInput.focus();
                searchInput.click();
            }
        }, 100);
    }
}

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = '';
        }

        // Rating Display
        function updateRatingDisplay() {
            document.querySelectorAll('.rating-star').forEach((star, index) => {
                if (index < selectedRating) {
                    star.textContent = '★';
                    star.classList.add('active');
                } else {
                    star.textContent = '☆';
                    star.classList.remove('active');
                }
            });
        }

       // Google Books Search
async function searchGoogleBooks() {
    console.log('searchGoogleBooks called');
    const query = document.getElementById('internetSearchInput').value;
    console.log('Query:', query);
    if (!query) {
        console.log('No query provided');
        return;
    }

    const resultsDiv = document.getElementById('searchResults');
    showLoading('Searching for books...');

    try {
        const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=10`);
        const data = await response.json();

        if (data.items && data.items.length > 0) {
            resultsDiv.innerHTML = '<div class="search-results">' + 
                data.items.map((item, index) => {
                    const info = item.volumeInfo;
                    const title = info.title || 'Unknown Title';
                    const authors = info.authors?.join(', ') || 'Unknown Author';
                    const isbn = info.industryIdentifiers?.find(id => id.type === 'ISBN_13')?.identifier || 
                               info.industryIdentifiers?.find(id => id.type === 'ISBN_10')?.identifier || '';
                    
                    let thumbnail = info.imageLinks?.thumbnail || '';
                    let originalThumbnail = thumbnail; // Keep the original as backup

                    // Force higher resolution by changing zoom parameter
                    if (thumbnail) {
                        // Change zoom=1 to zoom=0 for better quality
                        thumbnail = thumbnail.replace('zoom=1', 'zoom=0');
                        // Also change http to https for security
                        thumbnail = thumbnail.replace('http://', 'https://');
                        // Remove edge=curl for cleaner image
                        thumbnail = thumbnail.replace('&edge=curl', '');
                        // Also fix https on the original
                        originalThumbnail = originalThumbnail.replace('http://', 'https://');
                    }

                    // Store both versions in the book data
                    const bookData = {
                        title: title,
                        author: authors,
                        isbn: isbn,
                        cover: originalThumbnail || thumbnail,  // Use original (more reliable) thumbnail
                        summary: (info.description || '').substring(0, 500),
                        genre: info.categories ? info.categories.join(', ') : '' // ADD THIS LINE
                    };                 
                    // Use index to store data in a global variable to avoid encoding issues
                    window.searchResultsData = window.searchResultsData || {};
                    window.searchResultsData[index] = bookData;
                    
                    return `
                        <div class="search-result-item" onclick="selectGoogleBookByIndex(${index})">
                            <img src="${thumbnail}" 
                                 alt="${title}" 
                                 class="search-result-cover"
                                 onerror="this.onerror=null; if(this.src.includes('zoom=0')) { this.src=this.src.replace('zoom=0','zoom=1'); } else { this.parentElement.innerHTML='<div class=\\'search-result-cover\\' style=\\'display:flex;align-items:center;justify-content:center;\\'>📖</div>'; }">
                            <div class="search-result-info">
                                <div class="search-result-title">${title}</div>
                                <div class="search-result-author">${authors}</div>
                            </div>
                        </div>
                    `;              
                }).join('') + 
                '</div>';
        } else {
            resultsDiv.innerHTML = '<p style="text-align: center; color: var(--text-dim);">No books found. Try a different search term.</p>';
        }
    } catch (error) {
        resultsDiv.innerHTML = '<p style="text-align: center; color: var(--danger);">Search failed. Please try again.</p>';
        console.error('Search error:', error);
        showToast('Search Failed', 'Could not search for books. Please check your internet connection.', 'error');
    } finally {
        hideLoading();
    }
}

function selectGoogleBook(bookData) {
    currentBookId = null;
    selectedRating = 0;
    document.getElementById('addBookTitle').textContent = 'Add Book';
    document.getElementById('bookId').value = '';
    document.getElementById('bookTitle').value = bookData.title;
    document.getElementById('bookAuthor').value = bookData.author;
    document.getElementById('bookISBN').value = bookData.isbn;
    document.getElementById('bookCover').value = bookData.cover;
    document.getElementById('bookGenre').value = bookData.genre || ''; 
    document.getElementById('bookStatus').value = 'want-to-read';
    document.getElementById('bookSummary').value = bookData.summary || '';
    document.getElementById('bookNotes').value = '';
    document.getElementById('bookQuotes').value = '';
    
    updateRatingDisplay();
    document.getElementById('coverPreview').style.display = 'none';
    closeModal('searchModal');
    openModal('addBookModal');
}

// New function to handle clicks using index
function selectGoogleBookByIndex(index) {
    if (window.searchResultsData && window.searchResultsData[index]) {
        selectGoogleBook(window.searchResultsData[index]);
    } else {
        console.error('Book data not found for index:', index);
        alert('Error loading book details. Please try manual entry.');
    }
}
function selectGoogleBookFromElement(element) {
    try {
        const bookData = JSON.parse(element.getAttribute('data-book').replace(/&#39;/g, "'"));
        selectGoogleBook(bookData);
    } catch (error) {
        console.error('Error selecting book:', error);
        alert('Error loading book details. Please try manual entry.');
    }
}

     async function lendBook(e) {
    e.preventDefault();
    
    const bookId = document.getElementById('lendBookId').value;
    const book = library.books.find(b => b.id === bookId);
    
    if (book) {
        book.lentTo = document.getElementById('borrowerName').value;
        book.lentPhone = document.getElementById('borrowerPhone').value || '';
        book.lentEmail = document.getElementById('borrowerEmail').value || '';
        book.lentDate = new Date().toISOString();
        
        // Remove old contact field if it exists
        if (book.lentContact) {
            delete book.lentContact;
        }
        
        await saveLibrary();
        closeModal('lendingModal');
        renderLending();
        showToast('Book Lent', `${book.title} has been lent to ${book.lentTo}`, 'success');
    }
}

// Return Book Function
async function returnBook(bookId) {
    const book = library.books.find(b => b.id === bookId);
    if (book && book.lentTo) {
        const borrowerName = book.lentTo;
        
        // Remove all lending information
        delete book.lentTo;
        delete book.lentContact;  // Remove old field if it exists
        delete book.lentPhone;
        delete book.lentEmail;
        delete book.lentDate;
        
        await saveLibrary();
        renderLending();
        renderLibrary(); // Also update the main library view
        showToast('Book Returned', `${book.title} has been returned from ${borrowerName}`, 'success');
    }
}

// Make it globally accessible
window.returnBook = returnBook;

        // Goal Functions
        async function setGoal(e) {
            e.preventDefault();
            const goal = document.getElementById('goalInput').value;
            library.settings.goal2025 = goal;
            await saveLibrary();
            closeModal('goalModal');
            updateStats();
        }

        // Close modals on background click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.id);
                }
            });
        });

        // Prevent form submission on Enter in search
        document.getElementById('internetSearchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchGoogleBooks();
            }
        });
    </script>
    <!-- Firebase App (the core Firebase SDK) -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<!-- Firebase Auth -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<!-- Firebase Firestore -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

<!-- Initialize Firebase -->
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCG4hFaDegneYjJ8_jvAVAEJIu9NwzxVsw", 
  authDomain: "book-thingy-web.firebaseapp.com",
  projectId: "book-thingy-web",
  storageBucket: "book-thingy-web.firebasestorage.app",
  messagingSenderId: "463721013366",
  appId: "1:463721013366:web:b06f1e034cf276bababf57",
  measurementId: "G-MEASUREMENT_ID"
};
    
    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // Set up auth state listener
    auth.onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            console.log('User is signed in:', user.email);
            legacyAuthHandler(user);
        } else {
            currentUser = null;
            console.log('User is signed out');
            legacyAuthHandler(null);
        }
    });
    
    // Initialize app after DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM loaded, checking auth state...');
        // Let the window.load handler manage auth state
    });

// Loading overlay functions
function showLoading(message = 'Loading...') {
    document.getElementById('loadingText').textContent = message;
    document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
}

// Toast notification functions
function showToast(title, message = '', type = 'success', duration = 4000) {
    const container = document.getElementById('toastContainer');
    const toastId = 'toast-' + Date.now();
    
    const icons = {
        success: '✅',
        error: '❌',
        warning: '⚠️',
        info: 'ℹ️'
    };
    
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.id = toastId;
    toast.innerHTML = `
        <div class="toast-icon">${icons[type]}</div>
        <div class="toast-content">
            <div class="toast-title">${title}</div>
            ${message ? `<div class="toast-message">${message}</div>` : ''}
        </div>
        <button class="toast-close" onclick="closeToast('${toastId}')">×</button>
    `;
    
    container.appendChild(toast);
    
    // Show toast with animation
    setTimeout(() => toast.classList.add('show'), 100);
    
    // Auto remove after duration
    setTimeout(() => closeToast(toastId), duration);
}

function closeToast(toastId) {
    const toast = document.getElementById(toastId);
    if (toast) {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }
}

// Export functions (add after toast functions)
function showExportModal() {
    if (library.books.length === 0) {
        showToast('Nothing to Export', 'Your library is empty. Add some books first!', 'warning');
        return;
    }
    openModal('exportModal');
}

function exportAsCSV() {
    try {
        showLoading('Preparing CSV export...');
        
        // CSV headers
        const headers = ['Title', 'Author', 'ISBN', 'Status', 'Rating', 'Date Added', 'Summary', 'Notes', 'Quotes'];
        
        // Convert books to CSV rows
        const csvRows = [
            headers.join(','), // Header row
            ...library.books.map(book => [
                escapeCSV(book.title || ''),
                escapeCSV(book.author || ''),
                escapeCSV(book.isbn || ''),
                escapeCSV(book.status || ''),
                book.rating || '',
                book.dateAdded ? new Date(book.dateAdded).toLocaleDateString() : '',
                escapeCSV(book.summary || ''),
                escapeCSV(book.notes || ''),
                escapeCSV(book.quotes || '')
            ].join(','))
        ];
        
        const csvContent = csvRows.join('\n');
        downloadFile(csvContent, 'my-book-library.csv', 'text/csv');
        
        closeModal('exportModal');
        showToast('CSV Exported', `Successfully exported ${library.books.length} books to CSV!`, 'success');
        hideLoading();
    } catch (error) {
        console.error('CSV export error:', error);
        showToast('Export Failed', 'Could not export CSV file. Please try again.', 'error');
        hideLoading();
    }
}

function exportAsJSON() {
    try {
        showLoading('Preparing JSON export...');
        
        const exportData = {
            exportDate: new Date().toISOString(),
            totalBooks: library.books.length,
            books: library.books,
            settings: library.settings
        };
        
        const jsonContent = JSON.stringify(exportData, null, 2);
        downloadFile(jsonContent, 'my-book-library.json', 'application/json');
        
        closeModal('exportModal');
        showToast('JSON Exported', `Successfully exported ${library.books.length} books to JSON!`, 'success');
        hideLoading();
    } catch (error) {
        console.error('JSON export error:', error);
        showToast('Export Failed', 'Could not export JSON file. Please try again.', 'error');
        hideLoading();
    }
}

// ============ IMPORT FUNCTIONS START HERE ============

// Import Library function for web
function importLibrary() {
    // Create a hidden file input
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.csv,.json';
    
    fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        showLoading('Importing library...');
        
        try {
            const text = await file.text();
            const extension = file.name.split('.').pop().toLowerCase();
            
            if (extension === 'json') {
                await importJSON(text);
            } else if (extension === 'csv') {
                await importCSV(text);
            } else {
                throw new Error('Please select a CSV or JSON file');
            }
        } catch (error) {
            console.error('Import error:', error);
            showToast('Import Failed', error.message || 'Could not import file', 'error');
        } finally {
            hideLoading();
        }
    };
    
    // Trigger file selection
    fileInput.click();
}

// Import JSON format
async function importJSON(jsonText) {
    try {
        const data = JSON.parse(jsonText);
        let booksToImport = [];
        
        // Handle different JSON formats
        if (data.books && Array.isArray(data.books)) {
            // Our format
            booksToImport = data.books;
        } else if (Array.isArray(data)) {
            // Array of books
            booksToImport = data;
        } else {
            throw new Error('Invalid JSON format');
        }
        
        // Add books to library
        let imported = 0;
        for (const book of booksToImport) {
            // Check if book already exists by ISBN or title+author
            const exists = library.books.some(b => 
                (book.isbn && b.isbn === book.isbn) || 
                (b.title === book.title && b.author === book.author)
            );
            
            if (!exists) {
                library.books.push({
                    ...book,
                    id: book.id || Date.now().toString() + Math.random(),
                    dateAdded: book.dateAdded || new Date().toISOString()
                });
                imported++;
            }
        }
        
        await saveLibrary();
        renderLibrary();
        updateStats();
        
        showToast('Import Complete', `Imported ${imported} new books (${booksToImport.length - imported} duplicates skipped)`, 'success');
    } catch (error) {
        throw new Error('Invalid JSON file: ' + error.message);
    }
}

// Import CSV format (including Goodreads export)
async function importCSV(csvText) {
    try {
        const lines = csvText.split('\n');
        if (lines.length < 2) throw new Error('CSV file is empty');
        
        // Parse CSV header
        const headers = parseCSVLine(lines[0]);
        const titleIndex = headers.findIndex(h => h.toLowerCase().includes('title'));
        const authorIndex = headers.findIndex(h => h.toLowerCase().includes('author'));
        const isbnIndex = headers.findIndex(h => h.toLowerCase().includes('isbn'));
        const ratingIndex = headers.findIndex(h => h.toLowerCase().includes('rating'));
        const statusIndex = headers.findIndex(h => h.toLowerCase().includes('exclusive shelf') || h.toLowerCase().includes('status'));
        
        if (titleIndex === -1) throw new Error('Could not find title column in CSV');
        
        let imported = 0;
        
        // Parse each line
        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            
            const values = parseCSVLine(lines[i]);
            const title = values[titleIndex];
            if (!title) continue;
            
            // Map Goodreads shelf names to our status values
            let status = 'want-to-read';
            if (statusIndex !== -1) {
                const shelfName = values[statusIndex].toLowerCase();
                if (shelfName.includes('read')) status = 'completed';
                else if (shelfName.includes('reading')) status = 'reading';
            }
            
            const book = {
                id: Date.now().toString() + i,
                title: title,
                author: authorIndex !== -1 ? values[authorIndex] : '',
                isbn: isbnIndex !== -1 ? values[isbnIndex] : '',
                rating: ratingIndex !== -1 ? parseInt(values[ratingIndex]) || 0 : 0,
                status: status,
                cover: '',
                summary: '',
                notes: '',
                quotes: '',
                dateAdded: new Date().toISOString()
            };
            
            // Check for duplicates
            const exists = library.books.some(b => 
                (book.isbn && b.isbn === book.isbn) || 
                (b.title === book.title && b.author === book.author)
            );
            
            if (!exists) {
                library.books.push(book);
                imported++;
            }
        }
        
        await saveLibrary();
        renderLibrary();
        updateStats();
        
        showToast('Import Complete', `Imported ${imported} new books from CSV`, 'success');
    } catch (error) {
        throw new Error('Error parsing CSV: ' + error.message);
    }
}

// Helper function to parse CSV line (handles quoted values)
function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    
    result.push(current.trim());
    return result;
}

// ============ IMPORT FUNCTIONS END HERE ============

// Helper functions for export
function escapeCSV(str) {
    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
        return '"' + str.replace(/"/g, '""') + '"';
    }
    return str;
}

function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Settings functions
function showSettingsModal() {
    // Load current user info into the modal
    if (currentUser) {
        document.getElementById('settingsUserEmail').textContent = currentUser.email;
        document.getElementById('settingsUserName').textContent = currentUser.displayName || 'User';
        
        // Load profile picture
        const profilePicDiv = document.getElementById('userProfilePic');
        if (currentUser.photoURL) {
            profilePicDiv.innerHTML = `<img src="${currentUser.photoURL}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover;">`;
        } else {
            profilePicDiv.innerHTML = '👤';
        }
    } else {
        document.getElementById('settingsUserEmail').textContent = 'Not signed in';
        document.getElementById('settingsUserName').textContent = 'Guest';
        document.getElementById('userProfilePic').innerHTML = '👤';
    }
    
    // Load current settings into the modal
    document.getElementById('settingsUserEmail').textContent = currentUser ? currentUser.email : 'Not signed in';
    
    // Load saved preferences
    const settings = library.settings || {};
    document.getElementById('defaultBookStatus').value = settings.defaultBookStatus || 'want-to-read';
    document.getElementById('booksPerPage').value = settings.booksPerPage || '50';
    
    // Load theme
    const savedTheme = localStorage.getItem('bookThingyTheme') || 'dark';
    document.getElementById(savedTheme === 'light' ? 'themeLight' : 'themeDark').checked = true;
    
    // Load reading goal
    const currentYear = new Date().getFullYear();
    const goalKey = `goal${currentYear}`;
    document.getElementById('annualGoal').value = settings[goalKey] || '';
    
    // Update monthly preview
    const annual = parseInt(settings[goalKey]) || 0;
    document.getElementById('monthlyGoalPreview').textContent = Math.round(annual / 12);
    
    // Load other preferences
    document.getElementById('showReadingStreak').checked = settings.showReadingStreak || false;
    
    openModal('settingsModal');
}

function saveSettings() {
    try {
        showLoading('Saving settings...');
        
        // Get current year for goal
        const currentYear = new Date().getFullYear();
        const goalKey = `goal${currentYear}`;
        
        // Get settings from form
        const settings = {
            ...library.settings,
            defaultBookStatus: document.getElementById('defaultBookStatus').value,
            booksPerPage: document.getElementById('booksPerPage').value,
            [goalKey]: document.getElementById('annualGoal').value,
            showReadingStreak: document.getElementById('showReadingStreak').checked,
            lastUpdated: new Date().toISOString()
        };
        
        // Save theme separately to localStorage
        const selectedTheme = document.querySelector('input[name="theme"]:checked').value;
        applyTheme(selectedTheme);
        
        // Save to library
        library.settings = settings;
        saveLibrary();
        
        // Update stats if goal changed
        updateStats();
        
        closeModal('settingsModal');
        showToast('Settings Saved', 'Your preferences have been updated!', 'success');
        hideLoading();
    } catch (error) {
        console.error('Error saving settings:', error);
        showToast('Save Failed', 'Could not save settings. Please try again.', 'error');
        hideLoading();
    }
}

function clearAllData() {
    const confirmText = `Are you absolutely sure you want to delete ALL your books and data? This cannot be undone.

Type "DELETE ALL" to confirm:`;
    
    const userInput = prompt(confirmText);
    
    if (userInput === 'DELETE ALL') {
        try {
            showLoading('Clearing all data...');
            
            // Clear all data
            library = {
                books: [],
                settings: {
                    goal2025: null,
                    defaultBookStatus: 'want-to-read',
                    booksPerPage: '50'
                }
            };
            
            saveLibrary();
            renderLibrary();
            updateStats();
            
            closeModal('settingsModal');
            showToast('Data Cleared', 'All your books and data have been deleted.', 'warning');
            hideLoading();
        } catch (error) {
            console.error('Error clearing data:', error);
            showToast('Clear Failed', 'Could not clear data. Please try again.', 'error');
            hideLoading();
        }
    } else if (userInput !== null) {
        showToast('Cancelled', 'You must type "DELETE ALL" exactly to confirm.', 'info');
    }
}
    // Authentication state
let currentUser = null;

// Email Sign-In/Sign-Up
document.getElementById('emailSignInBtn').addEventListener('click', async () => {
    try {
        const email = document.getElementById('emailInput').value.trim();
        if (!email) {
            showToast('Error', 'Please enter an email address', 'error');
            return;
        }
        
        if (!email.includes('@')) {
            showToast('Error', 'Please enter a valid email address', 'error');
            return;
        }
        
        showLoading('Signing in...');
        
        // Create user object
        currentUser = {
            uid: btoa(email),
            email: email,
            displayName: email.split('@')[0]
        };
        
        console.log('Signed in with email:', currentUser.email);
        
        // Save user to localStorage
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        // Check if this might be a desktop user
        const isDesktopUser = await checkIfDesktopUser(currentUser);
        if (isDesktopUser) {
            closeModal('signInModal');
            openModal('desktopUserSyncModal');
            return;
        }
        
        // Initialize subscription for new user (web-only)
        initializeSubscription(currentUser);
        
        // Close modal and load library
        closeModal('signInModal');
        legacyAuthHandler(currentUser);
        hideLoading();
        
        showToast('Welcome!', `Signed in as ${email}`, 'success');
        
    } catch (error) {
        console.error('Email sign-in error:', error);
        showToast('Sign-in Failed', 'Could not sign in. Please try again.', 'error');
        hideLoading();
    }
});

// Google Sign-In 
document.getElementById('googleSignInBtn').addEventListener('click', async () => {
    try {
        showLoading('Signing in with Google...');
        
        // Check if Firebase is properly configured
        if (firebaseConfig.appId === "1:463721013366:web:abc123def456") {
            // Fallback for development
            showToast('Info', 'Google Sign-In not configured for development. Use email instead.', 'info');
            hideLoading();
            return;
        } else {
            // Real Firebase Auth
            const provider = new firebase.auth.GoogleAuthProvider();
            const result = await firebase.auth().signInWithPopup(provider);
            currentUser = result.user;
            console.log('Signed in with Firebase:', currentUser.email);
            
            // Save user to localStorage
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Check if this might be a desktop user
            const isDesktopUser = await checkIfDesktopUser(currentUser);
            if (isDesktopUser) {
                closeModal('signInModal');
                openModal('desktopUserSyncModal');
                hideLoading();
                return;
            }
            
            closeModal('signInModal');
            showToast('Welcome!', `Signed in with Google`, 'success');
        }
        
        // Show user info in header
        document.getElementById('userEmail').textContent = currentUser.email;
        document.getElementById('subscriptionStatus').textContent = getSubscriptionStatusText();
        document.getElementById('userInfo').style.display = 'flex';
        
        closeModal('signInModal');
        showLoading('Loading your library...');
        await loadLibrary();
        renderLibrary();
        hideLoading();
        
} catch (error) {
        hideLoading();
        console.error('Sign-in error:', error);
        showToast('Sign-in Failed', 'Please try again or check your internet connection.', 'error');
    }
});

// Test Account Sign-In
document.getElementById('testAccountBtn').addEventListener('click', async () => {
    try {
        showLoading('Signing in to test account...');
        
        // Use predefined test account credentials
        const testEmail = 'test@bookthingy.com';
        const testPassword = 'testuser123';
        
        // Sign in with Firebase Auth
        const userCredential = await firebase.auth().signInWithEmailAndPassword(testEmail, testPassword);
        currentUser = userCredential.user;
        
        // Mark as demo user
        currentUser.isDemo = true;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        // Show user info in header with demo badge
        document.getElementById('userEmail').textContent = 'Test User (Demo)';
        document.getElementById('subscriptionStatus').textContent = 'Demo Mode';
        document.getElementById('userInfo').style.display = 'flex';
        
        closeModal('signInModal');
        showToast('Welcome!', 'Signed in to test account with 20 demo books', 'success');
        
        // Load demo library
        await loadDemoLibrary();
        renderLibrary();
        hideLoading();
        
    } catch (error) {
        console.error('Test account sign-in error:', error);
        
        // If account doesn't exist, create it
        if (error.code === 'auth/user-not-found') {
            try {
                showLoading('Creating test account...');
                const testEmail = 'test@bookthingy.com';
                const testPassword = 'testuser123';
                
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(testEmail, testPassword);
                currentUser = userCredential.user;
                
                // Mark as demo user
                currentUser.isDemo = true;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Show user info in header with demo badge
                document.getElementById('userEmail').textContent = 'Test User (Demo)';
                document.getElementById('subscriptionStatus').textContent = 'Demo Mode';
                document.getElementById('userInfo').style.display = 'flex';
                
                closeModal('signInModal');
                showToast('Welcome!', 'Test account created with 20 demo books', 'success');
                
                // Load demo library and save to Firestore
                await loadDemoLibrary();
                await saveLibrary(); // Save demo data to Firestore
                renderLibrary();
                hideLoading();
                
            } catch (createError) {
                console.error('Failed to create test account:', createError);
                showToast('Error', 'Could not access test account. Please try again.', 'error');
                hideLoading();
            }
        } else {
            showToast('Error', 'Could not access test account. Please try again.', 'error');
            hideLoading();
        }
    }
});


// Load demo library with 20 public domain books
async function loadDemoLibrary() {
    library = {
        books: [
            {
                id: 'demo-1',
                title: 'Pride and Prejudice',
                author: 'Jane Austen',
                isbn: '9780141439518',
                status: 'read',
                rating: 5,
                dateAdded: '2024-01-15',
                dateFinished: '2024-02-01',
                pages: 432,
                genre: 'Classic Literature',
                notes: 'Timeless romance with brilliant social commentary.',
                coverUrl: 'https://www.gutenberg.org/files/1342/1342-h/images/cover.jpg'
            },
            {
                id: 'demo-2',
                title: 'The Adventures of Sherlock Holmes',
                author: 'Arthur Conan Doyle',
                isbn: '9780486474915',
                status: 'reading',
                rating: 0,
                dateAdded: '2024-03-10',
                pages: 307,
                currentPage: 156,
                genre: 'Mystery',
                notes: 'Love the deductive reasoning and Victorian atmosphere.',
                coverUrl: 'https://www.gutenberg.org/files/1661/1661-h/images/cover.jpg'
            },
            {
                id: 'demo-3',
                title: 'The Count of Monte Cristo',
                author: 'Alexandre Dumas',
                isbn: '9780140449266',
                status: 'read',
                rating: 5,
                dateAdded: '2023-11-20',
                dateFinished: '2023-12-15',
                pages: 1276,
                genre: 'Adventure',
                notes: 'Epic tale of revenge and redemption. A masterpiece!',
                coverUrl: 'https://www.gutenberg.org/files/1184/1184-h/images/cover.jpg'
            },
            {
                id: 'demo-4',
                title: 'Alice\'s Adventures in Wonderland',
                author: 'Lewis Carroll',
                isbn: '9780486275437',
                status: 'unread',
                rating: 0,
                dateAdded: '2024-01-05',
                pages: 96,
                genre: 'Fantasy',
                coverUrl: 'https://www.gutenberg.org/files/11/11-h/images/cover.jpg'
            },
            {
                id: 'demo-5',
                title: 'The Art of War',
                author: 'Sun Tzu',
                isbn: '9780486425573',
                status: 'read',
                rating: 4,
                dateAdded: '2023-09-10',
                dateFinished: '2023-10-02',
                pages: 273,
                genre: 'Philosophy',
                notes: 'Ancient wisdom still relevant for modern strategy.',
                coverUrl: 'https://www.gutenberg.org/files/132/132-h/images/cover.jpg'
            },
            {
                id: 'demo-6',
                title: 'Frankenstein',
                author: 'Mary Shelley',
                isbn: '9780486282114',
                status: 'read',
                rating: 4,
                dateAdded: '2024-02-20',
                dateFinished: '2024-02-25',
                pages: 280,
                genre: 'Horror',
                notes: 'Pioneering science fiction with deep moral questions.',
                coverUrl: 'https://www.gutenberg.org/files/84/84-h/images/cover.jpg'
            },
            {
                id: 'demo-7',
                title: 'The Odyssey',
                author: 'Homer',
                isbn: '9780140449112',
                status: 'reading',
                rating: 0,
                dateAdded: '2024-03-01',
                pages: 541,
                currentPage: 203,
                genre: 'Epic',
                notes: 'The original adventure story - incredible journey home.',
                coverUrl: 'https://www.gutenberg.org/files/1727/1727-h/images/cover.jpg'
            },
            {
                id: 'demo-8',
                title: 'Jane Eyre',
                author: 'Charlotte Brontë',
                isbn: '9780141441146',
                status: 'read',
                rating: 5,
                dateAdded: '2023-10-15',
                dateFinished: '2023-11-01',
                pages: 624,
                genre: 'Gothic Romance',
                notes: 'Powerful story of independence and love.',
                coverUrl: 'https://www.gutenberg.org/files/1260/1260-h/images/cover.jpg'
            },
            {
                id: 'demo-9',
                title: 'Moby Dick',
                author: 'Herman Melville',
                isbn: '9780486432151',
                status: 'unread',
                rating: 0,
                dateAdded: '2024-01-20',
                pages: 635,
                genre: 'Adventure',
                coverUrl: 'https://www.gutenberg.org/files/2701/2701-h/images/cover.jpg'
            },
            {
                id: 'demo-10',
                title: 'The Picture of Dorian Gray',
                author: 'Oscar Wilde',
                isbn: '9780486278070',
                status: 'read',
                rating: 4,
                dateAdded: '2023-12-01',
                dateFinished: '2023-12-20',
                pages: 254,
                genre: 'Gothic Fiction',
                notes: 'Brilliant exploration of beauty, morality, and corruption.',
                coverUrl: 'https://www.gutenberg.org/files/174/174-h/images/cover.jpg'
            },
            {
                id: 'demo-11',
                title: 'The Strange Case of Dr. Jekyll and Mr. Hyde',
                author: 'Robert Louis Stevenson',
                isbn: '9780486266886',
                status: 'reading',
                rating: 0,
                dateAdded: '2024-02-10',
                pages: 96,
                currentPage: 45,
                genre: 'Horror',
                notes: 'Classic psychological thriller about human nature.',
                coverUrl: 'https://www.gutenberg.org/files/43/43-h/images/cover.jpg'
            },
            {
                id: 'demo-12',
                title: 'Around the World in Eighty Days',
                author: 'Jules Verne',
                isbn: '9780486411118',
                status: 'read',
                rating: 4,
                dateAdded: '2023-08-15',
                dateFinished: '2023-09-05',
                pages: 176,
                genre: 'Adventure',
                notes: 'Fun adventure story with great pacing and humor.',
                coverUrl: 'https://www.gutenberg.org/files/103/103-h/images/cover.jpg'
            },
            {
                id: 'demo-13',
                title: 'The Time Machine',
                author: 'H.G. Wells',
                isbn: '9780486284729',
                status: 'unread',
                rating: 0,
                dateAdded: '2024-03-15',
                pages: 118,
                genre: 'Science Fiction',
                coverUrl: 'https://www.gutenberg.org/files/35/35-h/images/cover.jpg'
            },
            {
                id: 'demo-14',
                title: 'Wuthering Heights',
                author: 'Emily Brontë',
                isbn: '9780141439556',
                status: 'read',
                rating: 3,
                dateAdded: '2023-07-10',
                dateFinished: '2023-08-01',
                pages: 464,
                genre: 'Gothic Romance',
                notes: 'Intense and dark love story. Challenging but rewarding.',
                coverUrl: 'https://www.gutenberg.org/files/768/768-h/images/cover.jpg'
            },
            {
                id: 'demo-15',
                title: 'The Republic',
                author: 'Plato',
                isbn: '9780140455113',
                status: 'reading',
                rating: 0,
                dateAdded: '2024-01-25',
                pages: 407,
                currentPage: 127,
                genre: 'Philosophy',
                notes: 'Foundational work on justice and the ideal state.',
                coverUrl: 'https://www.gutenberg.org/files/1497/1497-h/images/cover.jpg'
            },
            {
                id: 'demo-16',
                title: 'Dracula',
                author: 'Bram Stoker',
                isbn: '9780486411095',
                status: 'read',
                rating: 4,
                dateAdded: '2023-12-20',
                dateFinished: '2024-01-10',
                pages: 418,
                genre: 'Horror',
                notes: 'The definitive vampire novel. Atmospheric and gripping.',
                coverUrl: 'https://www.gutenberg.org/files/345/345-h/images/cover.jpg'
            },
            {
                id: 'demo-17',
                title: 'The War of the Worlds',
                author: 'H.G. Wells',
                isbn: '9780486295060',
                status: 'unread',
                rating: 0,
                dateAdded: '2024-02-28',
                pages: 192,
                genre: 'Science Fiction',
                coverUrl: 'https://www.gutenberg.org/files/36/36-h/images/cover.jpg'
            },
            {
                id: 'demo-18',
                title: 'Little Women',
                author: 'Louisa May Alcott',
                isbn: '9780486420301',
                status: 'read',
                rating: 5,
                dateAdded: '2023-06-01',
                dateFinished: '2023-06-25',
                pages: 759,
                genre: 'Coming of Age',
                notes: 'Beautiful story of sisterhood and growing up.',
                coverUrl: 'https://www.gutenberg.org/files/514/514-h/images/cover.jpg'
            },
            {
                id: 'demo-19',
                title: 'The Jungle Book',
                author: 'Rudyard Kipling',
                isbn: '9780486415826',
                status: 'reading',
                rating: 0,
                dateAdded: '2024-03-20',
                pages: 304,
                currentPage: 89,
                genre: 'Adventure',
                notes: 'Classic tales of Mowgli and the jungle animals.',
                coverUrl: 'https://www.gutenberg.org/files/236/236-h/images/cover.jpg'
            },
            {
                id: 'demo-20',
                title: 'The Wonderful Wizard of Oz',
                author: 'L. Frank Baum',
                isbn: '9780486296906',
                status: 'unread',
                rating: 0,
                dateAdded: '2024-03-25',
                pages: 154,
                genre: 'Fantasy',
                coverUrl: 'https://www.gutenberg.org/files/55/55-h/images/cover.jpg'
            }
        ],
        wishlist: [
            {
                id: 'wish-1',
                title: 'Twenty Thousand Leagues Under the Sea',
                author: 'Jules Verne',
                isbn: '9780486440927',
                notes: 'Classic underwater adventure'
            },
            {
                id: 'wish-2',
                title: 'The Metamorphosis',
                author: 'Franz Kafka',
                isbn: '9780486290300',
                notes: 'Surreal transformation story'
            }
        ],
        settings: {
            goal2025: 24
        }
    };
    
    // Save to localStorage for demo persistence
    localStorage.setItem('demoLibrary', JSON.stringify(library));
    return Promise.resolve();
}




// Allow Enter key in email input
document.getElementById('emailInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('emailSignInBtn').click();
    }
});

// Load user from localStorage on app start
window.addEventListener('load', async () => {
    console.log('=== AUTH CHECK START ===');
    console.log('localStorage currentUser:', localStorage.getItem('currentUser'));
    
    try {
        // Check URL parameters for sign-in request
        const urlParams = new URLSearchParams(window.location.search);
        
        // Clear any sign-in parameters from URL  
        if (urlParams.get('signin') === 'true') {
            console.log('Sign-in explicitly requested - clearing any saved session');
            localStorage.removeItem('currentUser');
            window.history.replaceState({}, document.title, '/app');
        }
        
        // Wait a moment for Firebase Auth to initialize
        setTimeout(() => {
            // Check Firebase auth state
            const user = firebase.auth().currentUser;
            console.log('Firebase currentUser:', user);
            
            if (user) {
                // User is signed in via Firebase
                console.log('Firebase user detected:', user.email);
                currentUser = user;
                legacyAuthHandler(user);
            } else {
                // Check localStorage as fallback
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser && savedUser !== 'null' && savedUser !== 'undefined') {
                    try {
                        const parsedUser = JSON.parse(savedUser);
                        // Validate the saved user object
                        if (parsedUser && parsedUser.email) {
                            console.log('Valid user found in storage:', parsedUser.email);
                            currentUser = parsedUser;
                            
                            // Show user info in header
                            document.getElementById('userEmail').textContent = currentUser.isDemo ? 'Test User (Demo)' : currentUser.email;
                            document.getElementById('subscriptionStatus').textContent = currentUser.isDemo ? 'Demo Mode' : getSubscriptionStatusText();
                            document.getElementById('userInfo').style.display = 'flex';
                            
                            // Load appropriate library
                            showLoading(currentUser.isDemo ? 'Loading demo library...' : 'Loading your library...');
                            const loadPromise = currentUser.isDemo ? loadDemoLibrary() : loadLibrary();
                            loadPromise.then(() => {
                                // Update the current view
                                const activeView = document.querySelector('.view.active').id;
                                if (activeView === 'libraryView') {
                                    renderLibrary();
                                } else if (activeView === 'statsView') {
                                    updateStats();
                                    setTimeout(() => {
                                        handleStatClick('total');
                                    }, 100);
                                } else if (activeView === 'lendingView') {
                                    renderLending();
                                }
                                hideLoading();
                            });
                        } else {
                            console.log('Invalid user object in storage, showing sign-in modal');
                            localStorage.removeItem('currentUser');
                            openModal('signInModal');
                        }
                    } catch (parseError) {
                        console.error('Error parsing saved user:', parseError);
                        localStorage.removeItem('currentUser');
                        openModal('signInModal');
                    }
                } else {
                    // No user, show sign in modal
                    console.log('No saved user found, showing sign-in modal');
                    openModal('signInModal');
                }
            }
        }, 500); // Give Firebase time to initialize
    } catch (error) {
        console.error('Load error:', error);
        openModal('signInModal');
    }
});

// Legacy auth state handler (keeping for compatibility)
const legacyAuthHandler = async (user) => {
    if (user) {
        currentUser = user;
        console.log('User signed in:', user.email);
        
        // Show user info in header
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('subscriptionStatus').textContent = getSubscriptionStatusText();
        document.getElementById('userInfo').style.display = 'flex';
        
// Load user's data and render
showLoading('Loading your library...');
await loadLibrary();

// Update the current view
const activeView = document.querySelector('.view.active').id;
if (activeView === 'libraryView') {
    renderLibrary();
} else if (activeView === 'statsView') {
    updateStats();
    
    // Show total books by default if on stats view
    setTimeout(() => {
        handleStatClick('total');
    }, 100);
} else if (activeView === 'lendingView') {
    renderLending();
}
hideLoading();
    } else {
        console.log('User signed out');
        
        // Check if we're in demo mode - if so, don't interfere
        if (currentUser && currentUser.isDemo) {
            console.log('In demo mode - ignoring auth sign out');
            return;
        }
        
        currentUser = null;
        
        // Hide user info in header
        document.getElementById('userInfo').style.display = 'none';
        
        // Clear local data and show sign-in modal
        library = { books: [], wishlist: [], settings: { goal2025: null } };
        renderLibrary();
        openModal('signInModal');
        hideLoading(); // Ensure loading is hidden
    }
};

// Sign-out function
async function signOut() {
    if (confirm('Are you sure you want to sign out?')) {
        try {
            // Always use Firebase signout
            await firebase.auth().signOut();
            localStorage.removeItem('currentUser');
            console.log('User signed out successfully');
            showToast('Signed Out', 'You have been signed out successfully.', 'info');
        } catch (error) {
            console.error('Sign-out error:', error);
            showToast('Sign-out Failed', 'Could not sign out. Please try again.', 'error');
        }
    }
}

function showNotesModal(currentNotes, callback) {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(10px);
    `;
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Reading Notes</h2>
            </div>
            <div class="modal-body">
                <label class="form-label">Notes:</label>
                <textarea id="notesTextarea" class="form-input" rows="5" placeholder="Add your reading notes here..." style="resize: vertical; margin-bottom: 1rem;">${currentNotes}</textarea>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between; padding: 1rem;">
                <button class="btn btn-primary" onclick="submitNotes()">Save Notes</button>
                <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
            </div>
        </div>
    `;
    
    window.notesCallback = callback;
    
    document.body.appendChild(modal);
    document.getElementById('notesTextarea').focus();
}

function submitNotes() {
    const notes = document.getElementById('notesTextarea').value;
    document.querySelector('.modal-overlay').remove();
    if (window.notesCallback) {
        window.notesCallback(notes);
    }
}

window.submitNotes = submitNotes;

</script>
</body>
</html>