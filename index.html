<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Thingy - Desktop</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #22d3ee;
            --background: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --text: #f1f5f9;
            --text-dim: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.3);
        }

        /* Light theme variables */
:root.light-theme {
    --primary: #5b21b6;
    --primary-dark: #4c1d95;
    --secondary: #0891b2;
    --background: #f8fafc;
    --surface: #ffffff;
    --surface-light: #e2e8f0;
    --text: #1e293b;
    --text-dim: #64748b;
    --success: #059669;
    --warning: #d97706;
    --danger: #dc2626;
}

/* Light theme specific adjustments */
.light-theme .header {
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.98) 0%, 
        rgba(248, 250, 252, 0.95) 50%,
        rgba(241, 245, 249, 0.9) 100%);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.light-theme .bottom-nav {
    background: linear-gradient(180deg, 
        rgba(255, 255, 255, 0.95) 0%, 
        rgba(248, 250, 252, 0.98) 100%);
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
}

.light-theme .book-card {
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.light-theme .modal-content {
    background: white;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
}

.light-theme .book-status {
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.light-theme .toast {
    background: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* Light theme text fixes */
.light-theme .btn {
    color: white; /* Keep white text for primary buttons */
}

.light-theme .btn-secondary {
    color: var(--text); /* Dark text for secondary buttons */
    background: var(--surface-light);
}

.light-theme .form-label {
    color: var(--text);
}

.light-theme .form-input,
.light-theme .form-select,
.light-theme .form-textarea {
    color: var(--text);
    background: var(--surface-light);
    border-color: #cbd5e1;
}

.light-theme .modal-header {
    color: var(--text);
}

.light-theme .modal-title {
    color: var(--text);
}

.light-theme h3 {
    color: var(--primary);
}

.light-theme span,
.light-theme p,
.light-theme label {
    color: var(--text);
}

.light-theme .empty-state .empty-text {
    color: var(--text-dim);
}

.light-theme .sort-chip {
    color: var(--text);
    background: var(--surface-light);
    border-color: #cbd5e1;
}

.light-theme .sort-chip.active {
    color: white; /* Keep white text on active purple chips */
}

.light-theme input[type="radio"],
.light-theme input[type="checkbox"] {
    accent-color: var(--primary);
}

/* Fix the specific buttons in settings modal */
.light-theme .btn[style*="background: var(--danger)"] {
    color: white !important;
}

/* Ensure header text is visible */
.light-theme #userEmail {
    color: var(--text-dim) !important;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--background);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -webkit-user-select: none;
    user-select: none;
    line-height: 1.6;
}

        /* App Container */
        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 70px;
        }

        /* Header */
        .header {
            background: var(--surface);
            padding: 1rem;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            -webkit-app-region: drag;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

.logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: -0.02em;
}

.logo span:last-child {
    color: var(--text);
    text-shadow: 0 2px 10px rgba(167, 139, 250, 0.3);
}

.logo span:first-child {
    font-size: 1.75rem;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
}

        .storage-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-dim);
            -webkit-app-region: no-drag;
        }

        .storage-badge {
            background: var(--surface-light);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* Views */
        .view {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Search Bar */
        .search-section {
            margin-bottom: 1.5rem;
        }

        .search-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .search-input {
            flex: 1;
            background: var(--surface);
            border: 2px solid var(--surface-light);
            color: var(--text);
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            font-size: 1rem;
            transition: all 0.3s;
            -webkit-user-select: text;
            user-select: text;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
.search-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

/* Fix for modal search input */
#searchModal .search-input {
    position: relative;
    z-index: 1001;
}

#searchModal .modal-content {
    z-index: 1002;
}

/* Ensure modal inputs are always interactive */
.modal.active input,
.modal.active button,
.modal.active textarea {
    pointer-events: auto !important;
}
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--surface-light);
        }

        .btn-secondary:hover {
            background: var(--surface);
        }

        /* Sort Options */
        .sort-section {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            -webkit-overflow-scrolling: touch;
        }

        .sort-chip {
            background: var(--surface);
            color: var(--text-dim);
            border: 2px solid var(--surface-light);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .sort-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Book Grid */
.book-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); /* Changed from 150px to 180px */
    gap: 1rem;
    margin-bottom: 2rem;
}

        .book-card {
            background: var(--surface);
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

.book-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.4);
}

.book-card:hover .book-cover {
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
}

.book-cover {
    width: 100%;
    aspect-ratio: 2/3;
    object-fit: cover;
    background: var(--surface-light);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.book-info {
    padding: 1rem; /* Increased from 0.75rem */
}

.book-title {
    font-size: 0.9375rem; /* Slightly larger from 0.875rem */
    font-weight: 600;
    margin-bottom: 0.25rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    line-height: 1.4;
}

.book-author {
    font-size: 0.8125rem; /* Slightly larger from 0.75rem */
    color: var(--text-dim);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-bottom: 0.25rem; /* Add margin */
}

.book-genre {
    font-size: 0.75rem;
    color: var(--primary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-bottom: 0.25rem;
}

        .book-status {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
            backdrop-filter: blur(10px);
        }

        .status-reading { background: rgba(34, 211, 238, 0.9); }
        .status-completed { background: rgba(16, 185, 129, 0.9); }
        .status-want-to-read { background: rgba(245, 158, 11, 0.9); }
        .status-abandoned { background: rgba(239, 68, 68, 0.9); }

        .rating-display {
            display: flex;
            gap: 0.25rem;
            font-size: 1rem;
        }

  /* Bulk Selection Styles */
.selection-mode .book-card {
    position: relative;
}

.book-checkbox {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    width: 24px;
    height: 24px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 4px;
    display: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.selection-mode .book-checkbox {
    display: flex;
}

.book-checkbox input {
    width: 18px;
    height: 18px;
    margin: 0;
    cursor: pointer;
}

.book-card.selected {
    outline: 3px solid var(--primary);
    outline-offset: -3px;
}

.bulk-actions-toolbar {
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}      

        /* Book Details Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 2rem 1rem;
        }

        .modal-content {
            background: var(--surface);
            border-radius: var(--radius);
            width: 100%;
            max-width: 600px;
            margin: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: 1px solid var(--surface-light);
        }

.modal-title {
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1.2;
}

        .modal-close {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .modal-close:hover {
            background: var(--surface-light);
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-dim);
        }

        .form-input, .form-select, .form-textarea {
        
            width: 100%;
            background: var(--background);
            border: 2px solid var(--surface-light);
            color: var(--text);
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            font-size: 1rem;
            transition: all 0.3s;
            -webkit-user-select: text;
            user-select: text;
        }

  /* Fix select dropdown arrow position */
.form-select {
    padding-right: 2.5rem; /* Increase right padding */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center; /* Move arrow 1rem from right edge */
    background-size: 12px;
    appearance: none; /* Remove default arrow */
    -webkit-appearance: none;
    -moz-appearance: none;
}

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Rating Stars */
        .rating {
            display: flex;
            gap: 0.25rem;
            font-size: 1.5rem;
        }

        .rating-star {
            cursor: pointer;
            color: var(--surface-light);
            transition: color 0.2s;
        }

        .rating-star.active {
            color: #fbbf24;
        }

        .rating-star:hover {
            color: #fbbf24;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: var(--radius);
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-dim);
            font-size: 0.875rem;
        }

        /* Progress Bar */
        .progress-container {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: var(--radius);
            margin-bottom: 2rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .progress-bar {
            background: var(--surface-light);
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.5rem;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Lending List */
        .lending-list {
            background: var(--surface);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .lending-item {
            padding: 1rem;
            border-bottom: 1px solid var(--surface-light);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .lending-item:last-child {
            border-bottom: none;
        }

        .lending-book-cover {
            width: 50px;
            height: 75px;
            object-fit: cover;
            border-radius: 6px;
            background: var(--surface-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .lending-info {
            flex: 1;
        }

        .lending-borrower {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .lending-date {
            font-size: 0.875rem;
            color: var(--text-dim);
        }

        .return-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .return-btn:hover {
            background: #059669;
        }

        /* Bottom Navigation */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(180deg, 
        rgba(30, 41, 59, 0.95) 0%, 
        rgba(30, 41, 59, 0.98) 100%);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255, 255, 255, 0.05);
    padding: 0.5rem 0;
    display: flex;
    justify-content: space-around;
    align-items: center;
    z-index: 99;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
}

.nav-item {
    flex: 1;
    text-align: center;
    padding: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.nav-item:hover {
    transform: translateY(-2px);
}

.nav-item.active {
    color: var(--primary);
}

.nav-item.active::before {
    content: '';
    position: absolute;
    top: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 3px;
    background: var(--primary);
    border-radius: 2px;
    box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
}

.nav-icon {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
    transition: all 0.3s ease;
}

.nav-item:hover .nav-icon {
    transform: scale(1.1);
}

.nav-item.active .nav-icon {
    filter: drop-shadow(0 2px 8px rgba(99, 102, 241, 0.4));
}

.nav-label {
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.02em;
}

        /* Floating Action Button */
.fab {
    position: fixed;
    bottom: 100px;
    right: 1.5rem;
            background: var(--primary);
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 99;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
        }

        /* Add Options Menu */
.add-options {
    position: fixed;
    bottom: 170px;
    right: 1.5rem;
            background: var(--surface);
            border-radius: var(--radius);
            padding: 0.5rem;
            box-shadow: var(--shadow);
            display: none;
            z-index: 98;
        }

        .add-options.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

/* Fix button styling for add-option buttons */
.add-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: var(--radius);
    cursor: pointer;
    transition: background 0.3s;
    white-space: nowrap;
    /* Add these to override button defaults */
    border: none;
    background: transparent;
    color: var(--text);
    font-family: inherit;
    font-size: inherit;
    width: 100%;
    text-align: left;
}

        .add-option:hover {
            background: var(--surface-light);
        }

        /* Search Results */
        .search-results {
            max-height: 400px;
            overflow-y: auto;
            background: var(--background);
            border-radius: var(--radius);
            margin-top: 1rem;
        }

        .search-result-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid var(--surface-light);
            cursor: pointer;
            transition: background 0.3s;
        }

        .search-result-item:hover {
            background: var(--surface);
        }

        .search-result-cover {
            width: 60px;
            height: 90px;
            object-fit: cover;
            border-radius: 6px;
            background: var(--surface-light);
        }

        .search-result-info {
            flex: 1;
        }

        .search-result-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .search-result-author {
            font-size: 0.875rem;
            color: var(--text-dim);
        }

/* Empty State */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    max-width: 400px;
    margin: 0 auto;
}

.empty-icon {
    font-size: 5rem;
    margin-bottom: 1.5rem;
    opacity: 0.3;
    filter: grayscale(0.5);
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.empty-text {
    color: var(--text-dim);
    margin-bottom: 1rem;
    font-size: 1.125rem;
    line-height: 1.6;
}

.empty-tips {
    margin-top: 2rem;
    padding: 1.5rem;
    background: var(--surface);
    border-radius: var(--radius);
    text-align: left;
    border: 1px solid var(--surface-light);
}

.empty-tips h4 {
    color: var(--primary);
    margin-bottom: 0.75rem;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.empty-tips ul {
    list-style: none;
    padding: 0;
}

.empty-tips li {
    padding: 0.5rem 0;
    padding-left: 1.5rem;
    position: relative;
    font-size: 0.875rem;
    color: var(--text-dim);
}

.empty-tips li:before {
    content: "‚Üí";
    position: absolute;
    left: 0;
    color: var(--primary);
}

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--surface-light);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        /* Loading Overlay */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(15, 23, 42, 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
}

.loading-overlay.active {
    display: flex;
}

.loading-content {
    text-align: center;
    background: var(--surface);
    padding: 2rem;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
}

.loading-spinner {
    border: 4px solid var(--surface-light);
    border-top: 4px solid var(--primary);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem auto;
}

.loading-text {
    color: var(--text);
    font-size: 1rem;
    margin: 0;
}

/* Toast Notifications */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10001;
    pointer-events: none;
}

.toast {
    background: var(--surface);
    border: 2px solid var(--surface-light);
    border-radius: var(--radius);
    padding: 1rem 1.5rem;
    margin-bottom: 0.5rem;
    box-shadow: var(--shadow);
    transform: translateX(400px);
    opacity: 0;
    transition: all 0.3s ease;
    max-width: 400px;
    pointer-events: auto;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.toast.show {
    transform: translateX(0);
    opacity: 1;
}

.toast-icon {
    font-size: 1.25rem;
    flex-shrink: 0;
}

.toast-content {
    flex: 1;
}

.toast-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.toast-message {
    font-size: 0.875rem;
    color: var(--text-dim);
}

.toast-success {
    border-color: var(--success);
}

.toast-success .toast-icon {
    color: var(--success);
}

.toast-error {
    border-color: var(--danger);
}

.toast-error .toast-icon {
    color: var(--danger);
}

.toast-warning {
    border-color: var(--warning);
}

.toast-warning .toast-icon {
    color: var(--warning);
}

.toast-close {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 1.25rem;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.2s;
    flex-shrink: 0;
}

.toast-close:hover {
    background: var(--surface-light);
}

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Save indicator */
.save-indicator {
    position: fixed;
    bottom: 120px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--success);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.875rem;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    z-index: 101;
}

        .save-indicator.show {
            opacity: 1;
        }

        /* Premium Effects */
.book-card {
    background: linear-gradient(145deg, var(--surface) 0%, rgba(30, 41, 59, 0.8) 100%);
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.stat-card {
    background: linear-gradient(145deg, var(--surface) 0%, rgba(30, 41, 59, 0.8) 100%);
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.modal-content {
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.btn {
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
}

.btn:hover {
    box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
}

/* Glassmorphism for modals */
.modal {
    backdrop-filter: blur(10px);
    background: rgba(0,0,0,0.85);
}

/* Better header */
.header {
    background: linear-gradient(135deg, 
        rgba(30, 41, 59, 0.98) 0%, 
        rgba(30, 41, 59, 0.95) 50%,
        rgba(51, 65, 85, 0.9) 100%);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    box-shadow: 0 2px 20px rgba(0, 0, 0, 0.4);
    position: sticky;
    top: 0;
    z-index: 100;
}

/* Loading spinner improvements */
.loading-content {
    background: linear-gradient(145deg, var(--surface) 0%, rgba(30, 41, 59, 0.95) 100%);
    border: 1px solid rgba(255, 255, 255, 0.05);
}

/* Add smooth transitions to all interactive elements */
* {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* Book info text improvements */
.book-info {
    padding: 1rem;
}

.book-title {
    color: var(--text);
}

.book-author {
    font-size: 0.8125rem;
    line-height: 1.4;
}

/* Better focus states */
.form-input:focus, .form-select:focus, .form-textarea:focus {
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
}

/* Subtle animation for book cards on page load */
.book-card {
    animation: fadeInUp 0.4s ease backwards;
}

.book-card:nth-child(n) {
    animation-delay: calc(0.05s * var(--index));
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Search result improvements */
.search-result-item {
    background: linear-gradient(145deg, var(--background) 0%, rgba(15, 23, 42, 0.8) 100%);
    border: 1px solid rgba(255, 255, 255, 0.03);
}

.search-result-item:hover {
    background: linear-gradient(145deg, var(--surface) 0%, rgba(30, 41, 59, 0.8) 100%);
    transform: translateX(4px);
}

.search-result-cover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

/* Better sort chips */
.sort-chip {
    font-weight: 500;
    letter-spacing: 0.02em;
}

.sort-chip:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

/* Enhanced FAB */
.fab {
    background: linear-gradient(145deg, var(--primary) 0%, var(--primary-dark) 100%);
    box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
}

/* Add options menu polish */
.add-options {
    background: linear-gradient(145deg, var(--surface) 0%, rgba(30, 41, 59, 0.95) 100%);
    border: 1px solid rgba(255, 255, 255, 0.05);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
}

/* Better progress bar */
.progress-fill {
    background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
}

/* Enhanced status badges */
.book-status {
    font-weight: 600;
    letter-spacing: 0.05em;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* Better lending book covers */
.lending-book-cover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

/* Premium scrollbar */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--background);
}

::-webkit-scrollbar-thumb {
    background: var(--surface-light);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--primary);
}

        /* Responsive */
        @media (min-width: 768px) {
            .book-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
<div class="header-content">
    <div class="logo">
        <span>üìö</span>
        <span>Book Thingy</span>
    </div>
<div class="user-info" id="userInfo" style="display: none;">
    <span id="userEmail" style="color: var(--text-dim); font-size: 0.875rem; margin-right: 1rem;"></span>
    <button class="btn btn-secondary" onclick="showSettingsModal()" style="padding: 0.5rem 1rem; font-size: 0.875rem; margin-right: 0.5rem;">
        Settings
    </button>
    <button class="btn btn-secondary" onclick="showExportModal()" style="padding: 0.5rem 1rem; font-size: 0.875rem; margin-right: 0.5rem;">
        Export
    </button>
    <button class="btn btn-secondary" onclick="signOut()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
        Sign Out
    </button>
</div>
</div>
</header>

     <!-- Main Content -->
<main class="main-content">
    <!-- Library View -->
    <div class="view active" id="libraryView">
        <div class="search-section">
            <div class="search-bar">
                <input type="text" class="search-input" id="searchInput" placeholder="Search your library...">
                   <button class="btn btn-secondary" id="selectionModeBtn" onclick="toggleSelectionMode()">
                <span>‚úì</span>
                <span>Select</span>
            </button>
        </div>

 <!-- BULK ACTIONS TOOLBAR -->
    <div class="bulk-actions-toolbar" id="bulkActionsToolbar" style="display: none;">
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--surface); border-radius: var(--radius); margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span id="selectedCount">0</span> books selected
                <button class="btn btn-secondary" onclick="selectAll()" style="margin-left: 1rem; padding: 0.5rem 1rem; font-size: 0.875rem;">
                    Select All
                </button>
                <button class="btn btn-secondary" onclick="deselectAll()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                    Clear Selection
                </button>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary" onclick="bulkChangeStatus()" style="padding: 0.5rem 1rem;">
                    <span>üìö</span>
                    <span>Change Status</span>
                </button>
                <button class="btn" onclick="bulkDelete()" style="background: var(--danger); padding: 0.5rem 1rem;">
                    <span>üóëÔ∏è</span>
                    <span>Delete Selected</span>
                </button>
            </div>
        </div>
    </div>

            <div class="sort-section">
                <button class="sort-chip active" data-sort="recent">Recent</button>
                <button class="sort-chip" data-sort="title">Title</button>
                <button class="sort-chip" data-sort="author">Author</button>
                <button class="sort-chip" data-sort="status">Status</button>
                <button class="sort-chip" data-sort="rating">Rating</button>
                <button class="sort-chip" data-sort="genre">Genre</button>
            </div>
        </div>

        <div class="book-grid" id="bookGrid">
            <!-- Books will be rendered here -->
        </div>

        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-icon">üìö</div>
            <p class="empty-text">Your library is waiting for its first book!</p>
            <p class="empty-text" style="font-size: 0.875rem; margin-top: 0.5rem;">Click the + button to add a book</p>
            <div class="empty-tips">
                <h4>Quick Tips</h4>
                <ul>
                    <li>Search for books by title, author, or ISBN</li>
                    <li>Track your reading progress and set goals</li>
                    <li>Your library syncs across all devices</li>
                </ul>
            </div>
        </div>
    </div> <!-- This closing div was missing! -->

    <!-- Stats View -->
    <div class="view" id="statsView">
        <h2 style="margin-bottom: 1.5rem;">Reading Statistics</h2>
        
        <div class="progress-container">
            <div class="progress-header">
                <h3>2025 Reading Goal</h3>
                <button class="btn btn-secondary" onclick="showGoalModal()">Set Goal</button>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="goalProgress" style="width: 0%">0%</div>
            </div>
            <p style="margin-top: 0.5rem; color: var(--text-dim);" id="goalText">No goal set</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalBooks">0</div>
                <div class="stat-label">Total Books</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="currentlyReading">0</div>
                <div class="stat-label">Currently Reading</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completedBooks">0</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="averageRating">0</div>
                <div class="stat-label">Average Rating</div>
            </div>
        </div>

        <h3 style="margin-bottom: 1rem;">Top Rated Books</h3>
        <div class="book-grid" id="topRatedGrid">
            <!-- Top rated books will be rendered here -->
        </div>
    </div>

    <!-- Lending View -->
    <div class="view" id="lendingView">
        <h2 style="margin-bottom: 1.5rem;">Books On Loan</h2>
        
        <div class="lending-list" id="lendingList">
            <!-- Lending items will be rendered here -->
        </div>

        <div class="empty-state" id="lendingEmpty" style="display: none;">
            <div class="empty-icon">ü§ù</div>
            <p class="empty-text">No books currently on loan</p>
        </div>
    </div>
</main>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchView('libraryView')">
        <div class="nav-icon">üìö</div>
        <div class="nav-label">Library</div>
    </div>
    <div class="nav-item" onclick="switchView('statsView')">
        <div class="nav-icon">üìä</div>
        <div class="nav-label">Stats</div>
    </div>
    <div class="nav-item" onclick="switchView('lendingView')">
        <div class="nav-icon">ü§ù</div>
        <div class="nav-label">Lending</div>
    </div>
</nav>

<!-- Floating Action Button -->
<div class="fab" id="fab">+</div>

<!-- Add Options Menu -->
<div class="add-options" id="addOptions">
    <button type="button" class="add-option" id="barcodeBtn">
        <span>üì∑</span>
        <span>Scan Barcode</span>
    </button>
    <button type="button" class="add-option" id="searchBtn">
        <span>üîç</span>
        <span>Search Internet</span>
    </button>
    <button type="button" class="add-option" id="manualBtn">
        <span>‚úèÔ∏è</span>
        <span>Manual Entry</span>
    </button>
</div>

            <!-- Book Details Modal -->
        <div class="modal" id="bookModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="modalBookTitle">Book Details</h2>
                    <button class="modal-close" onclick="closeModal('bookModal')">√ó</button>
                </div>
                <div class="modal-body" id="bookModalBody">
                    <!-- Book details will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Add/Edit Book Modal -->
        <div class="modal" id="addBookModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="addBookTitle">Add Book</h2>
                    <button class="modal-close" onclick="closeModal('addBookModal')">√ó</button>
                </div>
                <div class="modal-body">
                    <form id="bookForm">
                        <input type="hidden" id="bookId">
                        
                        <div class="form-group">
                            <label class="form-label">Title *</label>
                            <input type="text" class="form-input" id="bookTitle" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Author *</label>
                            <input type="text" class="form-input" id="bookAuthor" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ISBN</label>
                            <input type="text" class="form-input" id="bookISBN">
                        </div>

                        <div class="form-group">
                           <label class="form-label">Location</label>
                           <input type="text" class="form-input" id="bookLocation" placeholder="e.g., Living room shelf, Bedroom, Library">
                       </div>

                        <div class="form-group">
                           <label class="form-label">Genre</label>
                           <input type="text" class="form-input" id="bookGenre" placeholder="e.g., Fiction, Mystery, Biography...">
                        </div>

                        <div class="form-group">
    <label class="form-label">Book Format (check all that apply)</label>
    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="bookFormat" value="hardcover" style="width: auto; margin: 0;">
            <span>Hardcover</span>
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="bookFormat" value="paperback" style="width: auto; margin: 0;">
            <span>Paperback</span>
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="bookFormat" value="ebook" style="width: auto; margin: 0;">
            <span>E-book</span>
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="bookFormat" value="audiobook" style="width: auto; margin: 0;">
            <span>Audiobook</span>
        </label>
        <!-- ADD THIS NEW CHECKBOX -->
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--surface-light);">
            <input type="checkbox" name="bookFormat" value="no-copy" style="width: auto; margin: 0;">
            <span>No Personal Copy</span>
        </label>
    </div>
</div>

<div class="form-group">
    <label class="form-label">Cover Image</label>
    <div style="display: flex; gap: 0.5rem; align-items: center;">
        <input type="url" class="form-input" id="bookCover" placeholder="Paste image URL..." style="flex: 1;">
        <span style="color: var(--text-dim); font-size: 0.875rem;">or</span>
        <label class="btn btn-secondary" style="margin: 0; cursor: pointer;">
            <span>üì∑</span>
            <span>Upload</span>
            <input type="file" id="bookCoverUpload" accept="image/*" style="display: none;" onchange="handleCoverUpload(event)">
        </label>
    </div>
    <div id="coverPreview" style="margin-top: 1rem; display: none;">
        <img id="coverPreviewImg" style="width: 100px; height: 150px; object-fit: cover; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
    </div>
</div>

                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="bookStatus">
                                <option value="want-to-read">Want to Read</option>
                                <option value="reading">Currently Reading</option>
                                <option value="completed">Completed</option>
                                <option value="abandoned">Abandoned</option>
                            </select>
                        </div>

<!-- ADD THIS NEW FIELD -->
<div class="form-group" id="pastReadGroup" style="display: none;">
    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
        <input type="checkbox" id="bookPastRead" style="width: auto; margin: 0;">
        <span>This is a past read (won't count toward current goals)</span>
    </label>
</div>

<div class="form-group">
                            <label class="form-label">Rating</label>
                            <div class="rating" id="bookRating">
                                <span class="rating-star" data-rating="1">‚òÜ</span>
                                <span class="rating-star" data-rating="2">‚òÜ</span>
                                <span class="rating-star" data-rating="3">‚òÜ</span>
                                <span class="rating-star" data-rating="4">‚òÜ</span>
                                <span class="rating-star" data-rating="5">‚òÜ</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Summary</label>
                            <textarea class="form-textarea" id="bookSummary" placeholder="What's this book about?"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-textarea" id="bookNotes" placeholder="Your thoughts..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Favorite Quotes</label>
                            <textarea class="form-textarea" id="bookQuotes" placeholder="Memorable quotes from the book..."></textarea>
                        </div>

                        <button type="submit" class="btn" style="width: 100%;">Save Book</button>
                    </form>
                </div>
            </div>
        </div>
</div>

        <!-- Internet Search Modal -->
        <div class="modal" id="searchModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Search Books</h2>
                    <button class="modal-close" onclick="closeModal('searchModal')">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="search-bar">
                        <input type="text" class="search-input" id="internetSearchInput" placeholder="Search by title, author, or ISBN...">
                        <button class="btn" onclick="searchGoogleBooks()">Search</button>
                    </div>
                    <div id="searchResults"></div>
                </div>
            </div>
        </div>

        <!-- Lending Modal -->
        <div class="modal" id="lendingModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Lend Book</h2>
                    <button class="modal-close" onclick="closeModal('lendingModal')">√ó</button>
                </div>
                <div class="modal-body">
                    <form id="lendingForm">
                        <input type="hidden" id="lendBookId">
                        
                     <div class="form-group">
    <label class="form-label">Borrower's Name *</label>
    <input type="text" class="form-input" id="borrowerName" required>
</div>

<div class="form-group">
    <label class="form-label">Phone Number</label>
    <input type="tel" class="form-input" id="borrowerPhone" placeholder="(555) 123-4567">
</div>

<div class="form-group">
    <label class="form-label">Email Address</label>
    <input type="email" class="form-input" id="borrowerEmail" placeholder="email@example.com">
</div>

                        <button type="submit" class="btn" style="width: 100%;">Lend Book</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Goal Modal -->
        <div class="modal" id="goalModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Set Reading Goal</h2>
                    <button class="modal-close" onclick="closeModal('goalModal')">√ó</button>
                </div>
                <div class="modal-body">
                    <form id="goalForm">
                        <div class="form-group">
                            <label class="form-label">Books to read in 2025</label>
                            <input type="number" class="form-input" id="goalInput" min="1" max="365" placeholder="e.g., 24" required>
                        </div>
                        <button type="submit" class="btn" style="width: 100%;">Set Goal</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="modal" id="settingsModal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">Settings</h2>
                    <button class="modal-close" onclick="closeModal('settingsModal')">√ó</button>
                </div>
                <div class="modal-body">
<!-- Account Section -->
<div style="margin-bottom: 2rem;">
    <h3 style="margin-bottom: 1rem; color: var(--primary);">Account</h3>
    <div style="background: var(--surface); padding: 1.5rem; border-radius: var(--radius);">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <div id="userProfilePic" style="width: 60px; height: 60px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; overflow: hidden;">
                üë§
            </div>
            <div>
                <div style="font-weight: 600;" id="settingsUserName">Loading...</div>
                <div style="font-size: 0.875rem; color: var(--text-dim);" id="settingsUserEmail">Loading...</div>
                <div style="font-size: 0.875rem; color: var(--text-dim);">Google Account</div>
            </div>
        </div>
    </div>
</div>
                    
<!-- Reading Preferences -->
<div style="margin-bottom: 2rem;">
    <h3 style="margin-bottom: 1rem; color: var(--primary);">Reading Preferences</h3>
    <div style="background: var(--surface); padding: 1.5rem; border-radius: var(--radius);">
        <!-- ADD THIS NEW THEME TOGGLE -->
        <div class="form-group">
            <label class="form-label">Theme</label>
            <div style="display: flex; gap: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="radio" name="theme" value="dark" id="themeDark" checked style="width: auto; margin: 0;">
                    <span>üåô Dark Mode</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="radio" name="theme" value="light" id="themeLight" style="width: auto; margin: 0;">
                    <span>‚òÄÔ∏è Light Mode</span>
                </label>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Default Book Status</label>
            <select class="form-select" id="defaultBookStatus">
                <option value="want-to-read">Want to Read</option>
                <option value="reading">Currently Reading</option>
                <option value="completed">Completed</option>
                <option value="abandoned">Abandoned</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Books Per Page</label>
            <select class="form-select" id="booksPerPage">
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="all">All</option>
            </select>
        </div>
        
        <!-- ADD READING GOAL SETTINGS -->
        <div class="form-group">
            <label class="form-label">Annual Reading Goal</label>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="number" class="form-input" id="annualGoal" min="0" max="365" style="width: 100px;">
                <span style="color: var(--text-dim);">books per year</span>
            </div>
            <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.5rem;">
                That's about <span id="monthlyGoalPreview">0</span> books per month
            </p>
        </div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="showReadingStreak" style="width: auto; margin: 0;">
                <span>Show reading streak on stats page</span>
            </label>
        </div>
    </div>
</div>

                    <!-- Data Management -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; color: var(--primary);">Data Management</h3>
                        <div style="background: var(--surface); padding: 1.5rem; border-radius: var(--radius);">
                            <div style="display: grid; gap: 1rem;">
                                <button class="btn btn-secondary" onclick="showExportModal(); closeModal('settingsModal');" style="justify-content: center;">
                                    <span>üì§</span>
                                    <span>Export Library</span>
                                </button>
                                
<button class="btn btn-secondary" onclick="importLibrary()" style="justify-content: center;">
    <span>üì•</span>
    <span>Import Library</span>
</button>
                                
                                <button class="btn" onclick="clearAllData()" style="background: var(--danger); justify-content: center;">
                                    <span>üóëÔ∏è</span>
                                    <span>Clear All Data</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Save Settings Button -->
                    <button class="btn" onclick="saveSettings()" style="width: 100%; justify-content: center;">
                        Save Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Export Modal -->
        <div class="modal" id="exportModal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2 class="modal-title">Export Your Library</h2>
                    <button class="modal-close" onclick="closeModal('exportModal')">√ó</button>
                </div>
                <div class="modal-body">
                    <p style="color: var(--text-dim); margin-bottom: 2rem;">
                        Download your book library for backup or to use in other applications.
                    </p>
                    
                    <div style="display: grid; gap: 1rem;">
                        <button class="btn" onclick="exportAsCSV()" style="justify-content: center;">
                            <span>üìÑ</span>
                            <span>Download as CSV</span>
                        </button>
                        
                        <button class="btn btn-secondary" onclick="exportAsJSON()" style="justify-content: center;">
                            <span>üìã</span>
                            <span>Download as JSON</span>
                        </button>
                    </div>
                    
                    <p style="font-size: 0.875rem; color: var(--text-dim); text-align: center; margin-top: 1.5rem;">
                        CSV works with Excel and Google Sheets<br>
                        JSON preserves all data including notes and quotes
                    </p>
                </div>
            </div>
        </div>

                <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <p class="loading-text" id="loadingText">Loading...</p>
            </div>
        </div>

          <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>

                <!-- ADD THE SIGN-IN MODAL HERE -->
        <!-- Sign In Modal -->
        <div class="modal" id="signInModal">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h2 class="modal-title">Welcome to Book Thingy</h2>
                </div>
                <div class="modal-body" style="text-align: center;">
                    <div style="margin-bottom: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üìö</div>
                        <p style="color: var(--text-dim); margin-bottom: 2rem;">Sign in to sync your library across all devices</p>
                    </div>
                    <button class="btn" id="googleSignInBtn" style="width: 100%; justify-content: center;">
                        <span>Sign in with Google</span>
                    </button>
                    <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-dim);">
                        Your data is private and secure
                    </p>
                </div>
            </div>
        </div>

        <!-- Save Indicator -->
        <div class="save-indicator" id="saveIndicator">Saved!</div>
    </div>

    <script>
        // App State
        let library = {
            books: [],
            settings: {
                goal2025: null
            }
        };
        let currentSort = 'recent';
        let currentBookId = null;
        let selectedRating = 0;
        let selectionMode = false;
        let selectedBooks = new Set();

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
    setupEventListeners();
    
    // Initialize theme
    initializeTheme();
    
    // Theme radio buttons
    document.getElementById('themeDark').addEventListener('change', function() {
        if (this.checked) applyTheme('dark');
    });
    
    document.getElementById('themeLight').addEventListener('change', function() {
        if (this.checked) applyTheme('light');
    });
    
    // Annual goal preview
    document.getElementById('annualGoal').addEventListener('input', function() {
        const annual = parseInt(this.value) || 0;
        const monthly = Math.round(annual / 12);
        document.getElementById('monthlyGoalPreview').textContent = monthly;
    });
    
    // FAB menu handler - MUST be here, not inside setupEventListeners
    document.getElementById('fab').addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('addOptions').classList.toggle('active');
    });

    // Direct button handlers (add after FAB handler)
    document.getElementById('barcodeBtn').addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('addOptions').classList.remove('active');
        showBarcodeScanner();
    });

    document.getElementById('searchBtn').addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('addOptions').classList.remove('active');
        showInternetSearch();
    });

    document.getElementById('manualBtn').addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('addOptions').classList.remove('active');
        showManualEntry();
    });

    // Close FAB menu when clicking elsewhere
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#fab') && !e.target.closest('#addOptions')) {
            document.getElementById('addOptions').classList.remove('active');
        }
    });
});

// Theme Management Functions
function initializeTheme() {
    const savedTheme = localStorage.getItem('bookThingyTheme') || 'dark';
    applyTheme(savedTheme);
}

function applyTheme(theme) {
    if (theme === 'light') {
        document.documentElement.classList.add('light-theme');
        if (document.getElementById('themeLight')) {
            document.getElementById('themeLight').checked = true;
        }
    } else {
        document.documentElement.classList.remove('light-theme');
        if (document.getElementById('themeDark')) {
            document.getElementById('themeDark').checked = true;
        }
    }
    localStorage.setItem('bookThingyTheme', theme);
}

        // Event Listeners
        function setupEventListeners() {
 
            // Sort chips
            document.querySelectorAll('.sort-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.sort-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentSort = chip.dataset.sort;
                    renderLibrary();
                });
            });

            // Search
            document.getElementById('searchInput').addEventListener('input', renderLibrary);

            // Forms
            document.getElementById('bookForm').addEventListener('submit', saveBook);
            document.getElementById('lendingForm').addEventListener('submit', lendBook);
            document.getElementById('goalForm').addEventListener('submit', setGoal);

            // Rating stars
            document.querySelectorAll('.rating-star').forEach(star => {
                star.addEventListener('click', () => {
                    selectedRating = parseInt(star.dataset.rating);
                    updateRatingDisplay();
                });
            });

// Status change listener
document.getElementById('bookStatus').addEventListener('change', function() {
    const pastReadGroup = document.getElementById('pastReadGroup');
    if (this.value === 'completed') {
        pastReadGroup.style.display = 'block';
    } else {
        pastReadGroup.style.display = 'none';
        document.getElementById('bookPastRead').checked = false;
    }
});

// ADD THIS NEW EVENT LISTENER HERE
    // Handle format checkbox mutual exclusivity
    document.addEventListener('change', function(e) {
        if (e.target.name === 'bookFormat') {
            const noCopyCheckbox = document.querySelector('input[name="bookFormat"][value="no-copy"]');
            const otherCheckboxes = document.querySelectorAll('input[name="bookFormat"]:not([value="no-copy"])');
            
            if (e.target.value === 'no-copy' && e.target.checked) {
                // If "No Personal Copy" is checked, uncheck all others
                otherCheckboxes.forEach(cb => cb.checked = false);
            } else if (e.target.value !== 'no-copy' && e.target.checked) {
                // If any other format is checked, uncheck "No Personal Copy"
                noCopyCheckbox.checked = false;
            }
        }
    });

 // Export/Import listeners - only for Electron
if (window.electronAPI) {
    window.electronAPI.onExportLibrary((event, filePath) => {
        exportLibrary(filePath);
    });

    window.electronAPI.onImportLibrary((event, filePath) => {
        importLibrary(filePath);
    });
}
}

// View Management
function switchView(viewName) {
    console.log('=== SWITCHING VIEW ===');
    console.log('Target view name:', viewName);
    
    // Remove active from all views
    document.querySelectorAll('.view').forEach(view => {
        console.log('Removing active from:', view.id);
        view.classList.remove('active');
    });
    
    // Find and activate target view
    const targetView = document.getElementById(viewName);
    console.log('Target view element found:', targetView);
    console.log('Target view exists:', !!targetView);
    
    if (targetView) {
        targetView.classList.add('active');
        console.log('Added active class to:', viewName);
        console.log('View has active class:', targetView.classList.contains('active'));
    } else {
        console.error('ERROR: View not found:', viewName);
        return;
    }

    // Render appropriate content
    console.log('Rendering content for:', viewName);
    if (viewName === 'libraryView') {
        console.log('Calling renderLibrary()');
        renderLibrary();
    } else if (viewName === 'statsView') {
        console.log('Calling updateStats()');
        console.log('Current books in library:', library.books.length);
        updateStats();
    } else if (viewName === 'lendingView') {
        console.log('Calling renderLending()');
        renderLending();
    }

    // Update active nav item
    console.log('Updating navigation indicators...');
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });

    // Find and activate the correct nav item
    const navItems = document.querySelectorAll('.nav-item');
    console.log('Number of nav items found:', navItems.length);
    
    if (viewName === 'libraryView' && navItems[0]) {
        navItems[0].classList.add('active');
        console.log('Activated nav item 0 (Library)');
    } else if (viewName === 'statsView' && navItems[1]) {
        navItems[1].classList.add('active');
        console.log('Activated nav item 1 (Stats)');
    } else if (viewName === 'lendingView' && navItems[2]) {
        navItems[2].classList.add('active');
        console.log('Activated nav item 2 (Lending)');
    }
    
    console.log('=== VIEW SWITCH COMPLETE ===');
}

        // Data Management
async function loadLibrary() {
    try {
        // Check if user is authenticated and use Firebase
        if (currentUser) {
            const doc = await db.collection('users').doc(currentUser.uid).get();
            if (doc.exists) {
                library = doc.data();
            } else {
                // First time user - create default library
                library = { books: [], settings: { goal2025: null } };
                await saveLibrary(); // Save the default structure
            }
        } else {
            // Not signed in - use localStorage
            const saved = localStorage.getItem('bookThingyLibrary');
            library = saved ? JSON.parse(saved) : { books: [], settings: { goal2025: null } };
        }
        
        if (!library.books) library.books = [];
        if (!library.settings) library.settings = { goal2025: null };
    } catch (error) {
        console.error('Error loading library:', error);
        library = { books: [], settings: { goal2025: null } };
    }
}

async function saveLibrary() {
    try {
        if (currentUser) {
            // User is signed in - save to Firebase
            await db.collection('users').doc(currentUser.uid).set(library);
            console.log('Data saved to Firebase for user:', currentUser.email);
        } else {
            // Not signed in - save to localStorage
            localStorage.setItem('bookThingyLibrary', JSON.stringify(library));
        }
        showSaveIndicator();
} catch (error) {
        console.error('Error saving library:', error);
        showToast('Save Failed', 'Could not save your library. Please try again.', 'error');
    }
}

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 2000);
        }

        // ADD THE NEW FUNCTION HERE
function getFormatIcon(format) {
    const icons = {
        'hardcover': 'üìï',
        'paperback': 'üìó',
        'ebook': 'üì±',
        'audiobook': 'üéß',
        'no-copy': 'üö´'
    };
    return icons[format] || '';
}

// Book Management
async function saveBook(e) {
    e.preventDefault();
    
    showLoading('Saving book...');
    
    function getCheckedFormats() {
    const checkboxes = document.querySelectorAll('input[name="bookFormat"]:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}
    try {
        const book = {
    id: document.getElementById('bookId').value || Date.now().toString(),
    title: document.getElementById('bookTitle').value,
    author: document.getElementById('bookAuthor').value,
    isbn: document.getElementById('bookISBN').value,
    location: document.getElementById('bookLocation').value,
    genre: document.getElementById('bookGenre').value,
    formats: getCheckedFormats(), // CHANGED from format to formats (plural)
    cover: document.getElementById('bookCover').value,
    status: document.getElementById('bookStatus').value,
    rating: selectedRating,
    summary: document.getElementById('bookSummary').value,
    notes: document.getElementById('bookNotes').value,
    quotes: document.getElementById('bookQuotes').value,
    pastRead: document.getElementById('bookPastRead').checked,
    dateAdded: new Date().toISOString(),
    dateModified: new Date().toISOString()
};

        const existingIndex = library.books.findIndex(b => b.id === book.id);
        if (existingIndex >= 0) {
            library.books[existingIndex] = { ...library.books[existingIndex], ...book };
        } else {
            library.books.push(book);
        }

        await saveLibrary();
        closeModal('addBookModal');
        renderLibrary();
        updateStats();
        showToast('Book Saved', 'Your book has been added to your library!', 'success');
    } catch (error) {
        console.error('Error saving book:', error);
        showToast('Save Failed', 'Could not save your book. Please try again.', 'error');
    } finally {
        hideLoading();
    }
}

async function deleteBook(bookId) {
    if (confirm('Are you sure you want to delete this book?')) {
        try {
            showLoading('Deleting book...');
            library.books = library.books.filter(b => b.id !== bookId);
            await saveLibrary();
            closeModal('bookModal');
            renderLibrary();
            updateStats();
            showToast('Book Deleted', 'The book has been removed from your library.', 'warning');
        } catch (error) {
            console.error('Error deleting book:', error);
            showToast('Delete Failed', 'Could not delete the book. Please try again.', 'error');
        } finally {
            hideLoading();
        }
    }
}

        // Rendering Functions
        function renderLibrary() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            let filteredBooks = library.books.filter(book => 
                book.title.toLowerCase().includes(searchTerm) ||
                book.author.toLowerCase().includes(searchTerm)
            );

            // Sort books
            filteredBooks.sort((a, b) => {
                switch (currentSort) {
                    case 'recent':
                        return new Date(b.dateAdded) - new Date(a.dateAdded);
                    case 'title':
                        return a.title.localeCompare(b.title);
                    case 'author':
                        return a.author.localeCompare(b.author);
                    case 'status':
                        return a.status.localeCompare(b.status);
                    case 'rating':
                        return (b.rating || 0) - (a.rating || 0);
                    case 'genre':  
                        return (a.genre || '').localeCompare(b.genre || '');
                    default:
                        return 0;
                }
            });

            const grid = document.getElementById('bookGrid');
            const emptyState = document.getElementById('emptyState');

            if (filteredBooks.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
grid.innerHTML = filteredBooks.map(book => `
    <div class="book-card ${selectedBooks.has(book.id) ? 'selected' : ''}" 
         data-book-id="${book.id}"
         onclick="${selectionMode ? `toggleBookSelection('${book.id}', event)` : `showBookDetails('${book.id}')`}">
        ${selectionMode ? `
            <div class="book-checkbox" onclick="toggleBookSelection('${book.id}', event)">
                <input type="checkbox" ${selectedBooks.has(book.id) ? 'checked' : ''}>
            </div>
        ` : ''}
        ${book.cover ? 
            `<img src="${book.cover}" alt="${book.title}" class="book-cover" onerror="this.outerHTML='<div class=\\'book-cover\\'>üìñ</div>'">` :
            `<div class="book-cover">üìñ</div>`
        }
        <div class="book-info">
            <div class="book-title">${book.title}</div>
            <div class="book-author">${book.author}</div>
            ${book.genre ? `<div class="book-genre">${book.genre}</div>` : ''}
            ${book.rating ? `<div class="rating-display">${'‚òÖ'.repeat(book.rating)}${'‚òÜ'.repeat(5-book.rating)}</div>` : ''}
        </div>
        <div class="book-status status-${book.status}">${book.status.replace('-', ' ')}</div>
    </div>
`).join('');
            }
        }

// Bulk Selection Functions
function toggleSelectionMode() {
    selectionMode = !selectionMode;
    const libraryView = document.getElementById('libraryView');
    const btn = document.getElementById('selectionModeBtn');
    const toolbar = document.getElementById('bulkActionsToolbar');
    
    if (selectionMode) {
        libraryView.classList.add('selection-mode');
        btn.innerHTML = '<span>‚úï</span><span>Cancel</span>';
        btn.style.background = 'var(--danger)';
        toolbar.style.display = 'block';
        selectedBooks.clear();
        updateSelectedCount();
    } else {
        libraryView.classList.remove('selection-mode');
        btn.innerHTML = '<span>‚úì</span><span>Select</span>';
        btn.style.background = '';
        toolbar.style.display = 'none';
        selectedBooks.clear();
        // Remove selected class from all books
        document.querySelectorAll('.book-card').forEach(card => {
            card.classList.remove('selected');
        });
    }
    renderLibrary();
}

function toggleBookSelection(bookId, event) {
    if (event) {
        event.stopPropagation();
    }
    
    if (selectedBooks.has(bookId)) {
        selectedBooks.delete(bookId);
        document.querySelector(`[data-book-id="${bookId}"]`).classList.remove('selected');
    } else {
        selectedBooks.add(bookId);
        document.querySelector(`[data-book-id="${bookId}"]`).classList.add('selected');
    }
    
    updateSelectedCount();
}

function updateSelectedCount() {
    document.getElementById('selectedCount').textContent = selectedBooks.size;
}

function selectAll() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    let filteredBooks = library.books.filter(book => 
        book.title.toLowerCase().includes(searchTerm) ||
        book.author.toLowerCase().includes(searchTerm)
    );
    
    filteredBooks.forEach(book => {
        selectedBooks.add(book.id);
    });
    
    // Update UI
    document.querySelectorAll('.book-card').forEach(card => {
        card.classList.add('selected');
        const checkbox = card.querySelector('.book-checkbox input');
        if (checkbox) checkbox.checked = true;
    });
    
    updateSelectedCount();
}

function deselectAll() {
    selectedBooks.clear();
    document.querySelectorAll('.book-card').forEach(card => {
        card.classList.remove('selected');
        const checkbox = card.querySelector('.book-checkbox input');
        if (checkbox) checkbox.checked = false;
    });
    updateSelectedCount();
}

async function bulkDelete() {
    if (selectedBooks.size === 0) {
        showToast('No Selection', 'Please select books to delete', 'warning');
        return;
    }
    
    const confirmText = `Are you sure you want to delete ${selectedBooks.size} book${selectedBooks.size > 1 ? 's' : ''}? This cannot be undone.`;
    
    if (confirm(confirmText)) {
        try {
            showLoading('Deleting books...');
            
            // Remove selected books from library
            library.books = library.books.filter(book => !selectedBooks.has(book.id));
            
            await saveLibrary();
            
            // Exit selection mode
            toggleSelectionMode();
            
            renderLibrary();
            updateStats();
            
            showToast('Books Deleted', `Successfully deleted ${selectedBooks.size} book${selectedBooks.size > 1 ? 's' : ''}`, 'success');
        } catch (error) {
            console.error('Error deleting books:', error);
            showToast('Delete Failed', 'Could not delete books. Please try again.', 'error');
        } finally {
            hideLoading();
        }
    }
}

async function bulkChangeStatus() {
    if (selectedBooks.size === 0) {
        showToast('No Selection', 'Please select books to update', 'warning');
        return;
    }
    
    // Create a simple modal for status selection
    const newStatus = prompt(`Change status for ${selectedBooks.size} book${selectedBooks.size > 1 ? 's' : ''}:\n\n1 = Want to Read\n2 = Currently Reading\n3 = Completed\n4 = Abandoned\n\nEnter number (1-4):`);
    
    const statusMap = {
        '1': 'want-to-read',
        '2': 'reading',
        '3': 'completed',
        '4': 'abandoned'
    };
    
    if (newStatus && statusMap[newStatus]) {
        try {
            showLoading('Updating books...');
            
            // Update status for selected books
            library.books.forEach(book => {
                if (selectedBooks.has(book.id)) {
                    book.status = statusMap[newStatus];
                    book.dateModified = new Date().toISOString();
                }
            });
            
            await saveLibrary();
            
            // Exit selection mode
            toggleSelectionMode();
            
            renderLibrary();
            updateStats();
            
            showToast('Books Updated', `Changed status for ${selectedBooks.size} book${selectedBooks.size > 1 ? 's' : ''}`, 'success');
        } catch (error) {
            console.error('Error updating books:', error);
            showToast('Update Failed', 'Could not update books. Please try again.', 'error');
        } finally {
            hideLoading();
        }
    }
}

  function updateStats() {
    console.log('Updating stats, total books:', library.books.length);

    const total = library.books.length;
    const reading = library.books.filter(b => b.status === 'reading').length;
    
    // Only count completed books that aren't marked as past reads
    const completed = library.books.filter(b => b.status === 'completed' && !b.pastRead).length;
    
    const ratings = library.books.filter(b => b.rating > 0).map(b => b.rating);
    const avgRating = ratings.length > 0 ? 
        (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1) : 
        '0.0';

    // Rest of the function remains the same...

            document.getElementById('totalBooks').textContent = total;
            document.getElementById('currentlyReading').textContent = reading;
            document.getElementById('completedBooks').textContent = completed;
            document.getElementById('averageRating').textContent = avgRating;

            // Update goal progress
            const goal = library.settings.goal2025;
            if (goal) {
                const goalNum = parseInt(goal);
                const progress = Math.min((completed / goalNum) * 100, 100);
                document.getElementById('goalProgress').style.width = progress + '%';
                document.getElementById('goalProgress').textContent = Math.round(progress) + '%';
                document.getElementById('goalText').textContent = `${completed} of ${goalNum} books (${Math.round(goalNum/12)} per month)`;
            }

            // Top rated books
            const topRated = library.books
                .filter(b => b.rating >= 4)
                .sort((a, b) => (b.rating || 0) - (a.rating || 0))
                .slice(0, 4);

            document.getElementById('topRatedGrid').innerHTML = topRated.map(book => `
                <div class="book-card" onclick="showBookDetails('${book.id}')">
                    ${book.cover ? 
                        `<img src="${book.cover}" alt="${book.title}" class="book-cover" onerror="this.outerHTML='<div class=\\'book-cover\\'>üìñ</div>'">` :
                        `<div class="book-cover">üìñ</div>`
                    }
                    <div class="book-info">
                        <div class="book-title">${book.title}</div>
                        <div class="book-author">${'‚≠ê'.repeat(book.rating)}</div>
                    </div>
                </div>
            `).join('');
        }

  function renderLending() {
    const lentBooks = library.books.filter(b => b.lentTo);
    const list = document.getElementById('lendingList');
    const empty = document.getElementById('lendingEmpty');

    if (lentBooks.length === 0) {
        list.innerHTML = '';
        empty.style.display = 'block';
    } else {
        empty.style.display = 'none';
        list.innerHTML = lentBooks.map(book => {
            const daysSince = Math.floor((new Date() - new Date(book.lentDate)) / (1000 * 60 * 60 * 24));
            return `
                <div class="lending-item" onclick="showBookDetails('${book.id}')" style="cursor: pointer;">
                    ${book.cover ? 
                        `<img src="${book.cover}" alt="${book.title}" class="lending-book-cover">` :
                        `<div class="lending-book-cover">üìñ</div>`
                    }
                    <div class="lending-info">
                        <div class="lending-borrower">${book.lentTo}</div>
                        <div class="lending-date">${book.title} ‚Ä¢ ${daysSince} days ago</div>
                        ${book.lentContact ? `<div class="lending-contact" style="font-size: 0.875rem; color: var(--primary); margin-top: 0.25rem;">${book.lentContact}</div>` : ''}
                    </div>
                    <button class="return-btn" onclick="event.stopPropagation(); returnBook('${book.id}')">Return</button>
                </div>
            `;
        }).join('');
        
        // Add event listeners after rendering
        list.querySelectorAll('.lending-item').forEach(item => {
            item.addEventListener('click', function(e) {
                if (!e.target.classList.contains('return-btn')) {
                    const bookId = this.getAttribute('data-book-id');
                    showBookDetails(bookId);
                }
            });
        });
        
        list.querySelectorAll('.return-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const bookId = this.getAttribute('data-book-id');
                returnBook(bookId);
            });
        });
    }
}

        // Modal Functions
        function showBookDetails(bookId) {
            const book = library.books.find(b => b.id === bookId);
            if (!book) return;

            currentBookId = bookId;
            document.getElementById('modalBookTitle').textContent = book.title;
            
            document.getElementById('bookModalBody').innerHTML = `
                <div style="display: flex; gap: 1.5rem; margin-bottom: 1.5rem;">
                    ${book.cover ? 
                        `<img src="${book.cover}" alt="${book.title}" style="width: 120px; height: 180px; object-fit: cover; border-radius: var(--radius);" onerror="this.outerHTML='<div style=\\'width: 120px; height: 180px; background: var(--surface-light); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; font-size: 3rem;\\'>üìñ</div>'">` :
                        `<div style="width: 120px; height: 180px; background: var(--surface-light); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; font-size: 3rem;">üìñ</div>`
                    }
<div style="flex: 1;">
    <p style="margin-bottom: 0.5rem;"><strong>Author:</strong> ${book.author}</p>
    ${book.isbn ? `<p style="margin-bottom: 0.5rem;"><strong>ISBN:</strong> ${book.isbn}</p>` : ''}
    ${book.location ? `<p style="margin-bottom: 0.5rem;"><strong>Location:</strong> ${book.location}</p>` : ''}
    <p style="margin-bottom: 0.5rem;"><strong>Status:</strong> <span class="book-status status-${book.status}" style="position: static; font-size: 0.75rem;">${book.status.replace('-', ' ')}</span></p>
    ${book.rating ? `<p style="margin-bottom: 0.5rem;"><strong>Rating:</strong> ${'‚òÖ'.repeat(book.rating)}${'‚òÜ'.repeat(5-book.rating)}</p>` : ''}
   ${book.formats && book.formats.length > 0 ? 
    book.formats.includes('no-copy') ? 
        `<p style="margin-bottom: 0.5rem;"><strong>Format:</strong> <span style="color: var(--text-dim);">No Personal Copy</span></p>` :
        `<p style="margin-bottom: 0.5rem;"><strong>Formats:</strong> ${book.formats.map(f => f.charAt(0).toUpperCase() + f.slice(1)).join(', ')}</p>` : 
    book.format ? `<p style="margin-bottom: 0.5rem;"><strong>Format:</strong> ${book.format.charAt(0).toUpperCase() + book.format.slice(1)}</p>` : ''
}
</div>
                </div>

                ${book.summary ? `
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 0.5rem;">Summary</h3>
                        <p style="color: var(--text-dim);">${book.summary}</p>
                    </div>
                ` : ''}

                ${book.notes ? `
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 0.5rem;">Notes</h3>
                        <p style="color: var(--text-dim);">${book.notes}</p>
                    </div>
                ` : ''}

                ${book.quotes ? `
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 0.5rem;">Favorite Quotes</h3>
                        <p style="color: var(--text-dim); white-space: pre-wrap;">${book.quotes}</p>
                    </div>
                ` : ''}

                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn" onclick="editBook('${book.id}')">Edit</button>
                    ${!book.lentTo ? 
                        `<button class="btn btn-secondary" onclick="showLendingModal('${book.id}')">Lend</button>` : 
                        ''
                    }
                    <button class="btn btn-secondary" style="background: var(--danger);" onclick="deleteBook('${book.id}')">Delete</button>
                </div>
            `;

            openModal('bookModal');
        }

        function showAddOptions() {
            document.getElementById('addOptions').classList.add('active');
        }

function showManualEntry() {
    console.log('showManualEntry called');
    currentBookId = null;
    selectedRating = 0;
    document.getElementById('addBookTitle').textContent = 'Add Book';
    document.getElementById('bookForm').reset();
    updateRatingDisplay();
    document.getElementById('coverPreview').style.display = 'none';
    openModal('addBookModal');
    document.getElementById('addOptions').classList.remove('active');
}

function editBook(bookId) {
    const book = library.books.find(b => b.id === bookId);
    if (!book) return;

    currentBookId = bookId;
    selectedRating = book.rating || 0;
    
    document.getElementById('addBookTitle').textContent = 'Edit Book';
    document.getElementById('bookId').value = book.id;
    document.getElementById('bookTitle').value = book.title;
    document.getElementById('bookAuthor').value = book.author;
    document.getElementById('bookISBN').value = book.isbn || '';
    document.getElementById('bookLocation').value = book.location || '';
    document.getElementById('bookCover').value = book.cover || '';
    document.getElementById('bookStatus').value = book.status;
    document.getElementById('bookSummary').value = book.summary || '';
    document.getElementById('bookNotes').value = book.notes || '';
    document.getElementById('bookQuotes').value = book.quotes || '';
    
    // Safe check for genre field
    if (document.getElementById('bookGenre')) {
        document.getElementById('bookGenre').value = book.genre || '';
    }
    
    // Handle format checkboxes
    // First, uncheck all format checkboxes
    document.querySelectorAll('input[name="bookFormat"]').forEach(cb => cb.checked = false);
    
    // Then check the ones that match the book's formats
    if (book.formats && Array.isArray(book.formats)) {
        book.formats.forEach(format => {
            const checkbox = document.querySelector(`input[name="bookFormat"][value="${format}"]`);
            if (checkbox) checkbox.checked = true;
        });
    } else if (book.format) {
        // Handle old single format data
        const checkbox = document.querySelector(`input[name="bookFormat"][value="${book.format}"]`);
        if (checkbox) checkbox.checked = true;
    }
    
    // Handle past read checkbox
    if (book.status === 'completed') {
        document.getElementById('pastReadGroup').style.display = 'block';
        document.getElementById('bookPastRead').checked = book.pastRead || false;
    } else {
        document.getElementById('pastReadGroup').style.display = 'none';
        document.getElementById('bookPastRead').checked = false;
    }
    
    updateRatingDisplay();
    closeModal('bookModal');
    openModal('addBookModal');
}

function showBarcodeScanner() {
    console.log('showBarcodeScanner called');
    showToast('Coming Soon', 'Barcode scanner feature will be available in a future update!', 'info');
    document.getElementById('addOptions').classList.remove('active');
}

function showInternetSearch() {
    console.log('showInternetSearch called');
    openModal('searchModal');
    document.getElementById('addOptions').classList.remove('active');
    
    // Clear previous search
    document.getElementById('internetSearchInput').value = '';
    document.getElementById('searchResults').innerHTML = '';
    
    // Force focus after a short delay
    setTimeout(() => {
        const searchInput = document.getElementById('internetSearchInput');
        searchInput.focus();
        searchInput.click();
    }, 100);
}

        function showLendingModal(bookId) {
                console.log('showManualEntry called');
            document.getElementById('lendBookId').value = bookId;
            document.getElementById('lendingForm').reset();
            closeModal('bookModal');
            openModal('lendingModal');
        }

        function showGoalModal() {
            const currentGoal = library.settings.goal2025;
            if (currentGoal) {
                document.getElementById('goalInput').value = currentGoal;
            }
            openModal('goalModal');
        }

        // Handle cover image upload
function handleCoverUpload(event) {
    const file = event.target.files[0];
    if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const dataUrl = e.target.result;
            document.getElementById('bookCover').value = dataUrl;
            
            // Show preview
            document.getElementById('coverPreviewImg').src = dataUrl;
            document.getElementById('coverPreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        showToast('Invalid File', 'Please select an image file', 'error');
    }
}

        // Modal Controls
function openModal(modalId) {
    console.log('=== openModal called ===');
    console.log('Modal ID:', modalId);
    console.log('Caller:', new Error().stack.split('\n')[2]);
    
    // Close all other modals first
    document.querySelectorAll('.modal.active').forEach(modal => {
        if (modal.id !== modalId) {
            modal.classList.remove('active');
        }
    });
    
    const modal = document.getElementById(modalId);
    if (!modal) {
        console.error('Modal not found:', modalId);
        return;
    }
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // Special handling for search modal
    if (modalId === 'searchModal') {
        setTimeout(() => {
            const searchInput = document.getElementById('internetSearchInput');
            if (searchInput) {
                searchInput.focus();
                searchInput.click();
            }
        }, 100);
    }
}

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = '';
        }

        // Rating Display
        function updateRatingDisplay() {
            document.querySelectorAll('.rating-star').forEach((star, index) => {
                if (index < selectedRating) {
                    star.textContent = '‚òÖ';
                    star.classList.add('active');
                } else {
                    star.textContent = '‚òÜ';
                    star.classList.remove('active');
                }
            });
        }

       // Google Books Search
async function searchGoogleBooks() {
    const query = document.getElementById('internetSearchInput').value;
    if (!query) return;

    const resultsDiv = document.getElementById('searchResults');
    showLoading('Searching for books...');

    try {
        const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=10`);
        const data = await response.json();

if (data.items && data.items.length > 0) {
    resultsDiv.innerHTML = '<div class="search-results">' + 
        data.items.map((item, index) => {
            const info = item.volumeInfo;
            const title = info.title || 'Unknown Title';
            const authors = info.authors?.join(', ') || 'Unknown Author';
            const isbn = info.industryIdentifiers?.find(id => id.type === 'ISBN_13')?.identifier || 
                       info.industryIdentifiers?.find(id => id.type === 'ISBN_10')?.identifier || '';
            
      let thumbnail = info.imageLinks?.thumbnail || '';
let originalThumbnail = thumbnail; // Keep the original as backup

// Force higher resolution by changing zoom parameter
if (thumbnail) {
    // Change zoom=1 to zoom=0 for better quality
    thumbnail = thumbnail.replace('zoom=1', 'zoom=0');
    // Also change http to https for security
    thumbnail = thumbnail.replace('http://', 'https://');
    // Remove edge=curl for cleaner image
    thumbnail = thumbnail.replace('&edge=curl', '');
    // Also fix https on the original
    originalThumbnail = originalThumbnail.replace('http://', 'https://');
}

// Store both versions in the book data
const bookData = {
    title: title,
    author: authors,
    isbn: isbn,
    cover: originalThumbnail || thumbnail,  // Use original (more reliable) thumbnail
    summary: (info.description || '').substring(0, 500),
    genre: info.categories ? info.categories.join(', ') : '' // ADD THIS LINE
};                 
// Use index to store data in a global variable to avoid encoding issues
                    window.searchResultsData = window.searchResultsData || {};
                    window.searchResultsData[index] = bookData;
                    
return `
    <div class="search-result-item" onclick="selectGoogleBookByIndex(${index})">
        <img src="${thumbnail}" 
             alt="${title}" 
             class="search-result-cover"
             onerror="this.onerror=null; if(this.src.includes('zoom=0')) { this.src=this.src.replace('zoom=0','zoom=1'); } else { this.parentElement.innerHTML='<div class=\\'search-result-cover\\' style=\\'display:flex;align-items:center;justify-content:center;\\'>üìñ</div>'; }">
        <div class="search-result-info">
            <div class="search-result-title">${title}</div>
            <div class="search-result-author">${authors}</div>
        </div>
    </div>
`;              }).join('') + 
            '</div>';
        } else {
            resultsDiv.innerHTML = '<p style="text-align: center; color: var(--text-dim);">No books found. Try a different search term.</p>';
        }
    } catch (error) {
        resultsDiv.innerHTML = '<p style="text-align: center; color: var(--danger);">Search failed. Please try again.</p>';
        console.error('Search error:', error);
        showToast('Search Failed', 'Could not search for books. Please check your internet connection.', 'error');
    } finally {
        hideLoading();
    }
}

function selectGoogleBook(bookData) {
    currentBookId = null;
    selectedRating = 0;
    document.getElementById('addBookTitle').textContent = 'Add Book';
    document.getElementById('bookId').value = '';
    document.getElementById('bookTitle').value = bookData.title;
    document.getElementById('bookAuthor').value = bookData.author;
    document.getElementById('bookISBN').value = bookData.isbn;
    document.getElementById('bookCover').value = bookData.cover;
    document.getElementById('bookGenre').value = bookData.genre || ''; 
    document.getElementById('bookStatus').value = 'want-to-read';
    document.getElementById('bookSummary').value = bookData.summary || '';
    document.getElementById('bookNotes').value = '';
    document.getElementById('bookQuotes').value = '';
    
    updateRatingDisplay();
    document.getElementById('coverPreview').style.display = 'none';
    closeModal('searchModal');
    openModal('addBookModal');
}

// New function to handle clicks using index
function selectGoogleBookByIndex(index) {
    if (window.searchResultsData && window.searchResultsData[index]) {
        selectGoogleBook(window.searchResultsData[index]);
    } else {
        console.error('Book data not found for index:', index);
        alert('Error loading book details. Please try manual entry.');
    }
}
function selectGoogleBookFromElement(element) {
    try {
        const bookData = JSON.parse(element.getAttribute('data-book').replace(/&#39;/g, "'"));
        selectGoogleBook(bookData);
    } catch (error) {
        console.error('Error selecting book:', error);
        alert('Error loading book details. Please try manual entry.');
    }
}
        // Lending Functions
        async function lendBook(e) {
            e.preventDefault();
            
            const bookId = document.getElementById('lendBookId').value;
            const book = library.books.find(b => b.id === bookId);
            
            if (book) {
                book.lentTo = document.getElementById('borrowerName').value;
                book.lentContact = document.getElementById('borrowerContact').value;
                book.lentDate = new Date().toISOString();
                
                await saveLibrary();
                closeModal('lendingModal');
                renderLending();
            }
        }

        async function returnBook(bookId) {
            const book = library.books.find(b => b.id === bookId);
            if (book) {
                delete book.lentTo;
                delete book.lentContact;
                delete book.lentDate;
                
                await saveLibrary();
                renderLending();
            }
        }

        // Goal Functions
        async function setGoal(e) {
            e.preventDefault();
            const goal = document.getElementById('goalInput').value;
            library.settings.goal2025 = goal;
            await saveLibrary();
            closeModal('goalModal');
            updateStats();
        }

        // Close modals on background click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.id);
                }
            });
        });

        // Prevent form submission on Enter in search
        document.getElementById('internetSearchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchGoogleBooks();
            }
        });
    </script>
    <!-- Firebase App (the core Firebase SDK) -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<!-- Firebase Auth -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<!-- Firebase Firestore -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

<!-- Initialize Firebase -->
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCG4hFaDegneYjJ8_jvAVAEJIu9NwzxVsw",
  authDomain: "book-thingy-app.firebaseapp.com",
  projectId: "book-thingy-app",
  storageBucket: "book-thingy-app.firebasestorage.app",
  messagingSenderId: "284502577988",
  appId: "1:284502577988:web:5c50de859e0870a09efd11",
  measurementId: "G-TZ2VTER0YV"
};
    
    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

// Loading overlay functions
function showLoading(message = 'Loading...') {
    document.getElementById('loadingText').textContent = message;
    document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
}

// Toast notification functions
function showToast(title, message = '', type = 'success', duration = 4000) {
    const container = document.getElementById('toastContainer');
    const toastId = 'toast-' + Date.now();
    
    const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
    };
    
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.id = toastId;
    toast.innerHTML = `
        <div class="toast-icon">${icons[type]}</div>
        <div class="toast-content">
            <div class="toast-title">${title}</div>
            ${message ? `<div class="toast-message">${message}</div>` : ''}
        </div>
        <button class="toast-close" onclick="closeToast('${toastId}')">√ó</button>
    `;
    
    container.appendChild(toast);
    
    // Show toast with animation
    setTimeout(() => toast.classList.add('show'), 100);
    
    // Auto remove after duration
    setTimeout(() => closeToast(toastId), duration);
}

function closeToast(toastId) {
    const toast = document.getElementById(toastId);
    if (toast) {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }
}

// Export functions (add after toast functions)
function showExportModal() {
    if (library.books.length === 0) {
        showToast('Nothing to Export', 'Your library is empty. Add some books first!', 'warning');
        return;
    }
    openModal('exportModal');
}

function exportAsCSV() {
    try {
        showLoading('Preparing CSV export...');
        
        // CSV headers
        const headers = ['Title', 'Author', 'ISBN', 'Status', 'Rating', 'Date Added', 'Summary', 'Notes', 'Quotes'];
        
        // Convert books to CSV rows
        const csvRows = [
            headers.join(','), // Header row
            ...library.books.map(book => [
                escapeCSV(book.title || ''),
                escapeCSV(book.author || ''),
                escapeCSV(book.isbn || ''),
                escapeCSV(book.status || ''),
                book.rating || '',
                book.dateAdded ? new Date(book.dateAdded).toLocaleDateString() : '',
                escapeCSV(book.summary || ''),
                escapeCSV(book.notes || ''),
                escapeCSV(book.quotes || '')
            ].join(','))
        ];
        
        const csvContent = csvRows.join('\n');
        downloadFile(csvContent, 'my-book-library.csv', 'text/csv');
        
        closeModal('exportModal');
        showToast('CSV Exported', `Successfully exported ${library.books.length} books to CSV!`, 'success');
        hideLoading();
    } catch (error) {
        console.error('CSV export error:', error);
        showToast('Export Failed', 'Could not export CSV file. Please try again.', 'error');
        hideLoading();
    }
}

function exportAsJSON() {
    try {
        showLoading('Preparing JSON export...');
        
        const exportData = {
            exportDate: new Date().toISOString(),
            totalBooks: library.books.length,
            books: library.books,
            settings: library.settings
        };
        
        const jsonContent = JSON.stringify(exportData, null, 2);
        downloadFile(jsonContent, 'my-book-library.json', 'application/json');
        
        closeModal('exportModal');
        showToast('JSON Exported', `Successfully exported ${library.books.length} books to JSON!`, 'success');
        hideLoading();
    } catch (error) {
        console.error('JSON export error:', error);
        showToast('Export Failed', 'Could not export JSON file. Please try again.', 'error');
        hideLoading();
    }
}

// ============ IMPORT FUNCTIONS START HERE ============

// Import Library function for web
function importLibrary() {
    // Create a hidden file input
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.csv,.json';
    
    fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        showLoading('Importing library...');
        
        try {
            const text = await file.text();
            const extension = file.name.split('.').pop().toLowerCase();
            
            if (extension === 'json') {
                await importJSON(text);
            } else if (extension === 'csv') {
                await importCSV(text);
            } else {
                throw new Error('Please select a CSV or JSON file');
            }
        } catch (error) {
            console.error('Import error:', error);
            showToast('Import Failed', error.message || 'Could not import file', 'error');
        } finally {
            hideLoading();
        }
    };
    
    // Trigger file selection
    fileInput.click();
}

// Import JSON format
async function importJSON(jsonText) {
    try {
        const data = JSON.parse(jsonText);
        let booksToImport = [];
        
        // Handle different JSON formats
        if (data.books && Array.isArray(data.books)) {
            // Our format
            booksToImport = data.books;
        } else if (Array.isArray(data)) {
            // Array of books
            booksToImport = data;
        } else {
            throw new Error('Invalid JSON format');
        }
        
        // Add books to library
        let imported = 0;
        for (const book of booksToImport) {
            // Check if book already exists by ISBN or title+author
            const exists = library.books.some(b => 
                (book.isbn && b.isbn === book.isbn) || 
                (b.title === book.title && b.author === book.author)
            );
            
            if (!exists) {
                library.books.push({
                    ...book,
                    id: book.id || Date.now().toString() + Math.random(),
                    dateAdded: book.dateAdded || new Date().toISOString()
                });
                imported++;
            }
        }
        
        await saveLibrary();
        renderLibrary();
        updateStats();
        
        showToast('Import Complete', `Imported ${imported} new books (${booksToImport.length - imported} duplicates skipped)`, 'success');
    } catch (error) {
        throw new Error('Invalid JSON file: ' + error.message);
    }
}

// Import CSV format (including Goodreads export)
async function importCSV(csvText) {
    try {
        const lines = csvText.split('\n');
        if (lines.length < 2) throw new Error('CSV file is empty');
        
        // Parse CSV header
        const headers = parseCSVLine(lines[0]);
        const titleIndex = headers.findIndex(h => h.toLowerCase().includes('title'));
        const authorIndex = headers.findIndex(h => h.toLowerCase().includes('author'));
        const isbnIndex = headers.findIndex(h => h.toLowerCase().includes('isbn'));
        const ratingIndex = headers.findIndex(h => h.toLowerCase().includes('rating'));
        const statusIndex = headers.findIndex(h => h.toLowerCase().includes('exclusive shelf') || h.toLowerCase().includes('status'));
        
        if (titleIndex === -1) throw new Error('Could not find title column in CSV');
        
        let imported = 0;
        
        // Parse each line
        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            
            const values = parseCSVLine(lines[i]);
            const title = values[titleIndex];
            if (!title) continue;
            
            // Map Goodreads shelf names to our status values
            let status = 'want-to-read';
            if (statusIndex !== -1) {
                const shelfName = values[statusIndex].toLowerCase();
                if (shelfName.includes('read')) status = 'completed';
                else if (shelfName.includes('reading')) status = 'reading';
            }
            
            const book = {
                id: Date.now().toString() + i,
                title: title,
                author: authorIndex !== -1 ? values[authorIndex] : '',
                isbn: isbnIndex !== -1 ? values[isbnIndex] : '',
                rating: ratingIndex !== -1 ? parseInt(values[ratingIndex]) || 0 : 0,
                status: status,
                cover: '',
                summary: '',
                notes: '',
                quotes: '',
                dateAdded: new Date().toISOString()
            };
            
            // Check for duplicates
            const exists = library.books.some(b => 
                (book.isbn && b.isbn === book.isbn) || 
                (b.title === book.title && b.author === book.author)
            );
            
            if (!exists) {
                library.books.push(book);
                imported++;
            }
        }
        
        await saveLibrary();
        renderLibrary();
        updateStats();
        
        showToast('Import Complete', `Imported ${imported} new books from CSV`, 'success');
    } catch (error) {
        throw new Error('Error parsing CSV: ' + error.message);
    }
}

// Helper function to parse CSV line (handles quoted values)
function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    
    result.push(current.trim());
    return result;
}

// ============ IMPORT FUNCTIONS END HERE ============

// Helper functions for export
function escapeCSV(str) {
    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
        return '"' + str.replace(/"/g, '""') + '"';
    }
    return str;
}

function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Settings functions
function showSettingsModal() {
    // Load current user info into the modal
    if (currentUser) {
        document.getElementById('settingsUserEmail').textContent = currentUser.email;
        document.getElementById('settingsUserName').textContent = currentUser.displayName || 'User';
        
        // Load profile picture
        const profilePicDiv = document.getElementById('userProfilePic');
        if (currentUser.photoURL) {
            profilePicDiv.innerHTML = `<img src="${currentUser.photoURL}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover;">`;
        } else {
            profilePicDiv.innerHTML = 'üë§';
        }
    } else {
        document.getElementById('settingsUserEmail').textContent = 'Not signed in';
        document.getElementById('settingsUserName').textContent = 'Guest';
        document.getElementById('userProfilePic').innerHTML = 'üë§';
    }
    
    // Load current settings into the modal
    document.getElementById('settingsUserEmail').textContent = currentUser ? currentUser.email : 'Not signed in';
    
    // Load saved preferences
    const settings = library.settings || {};
    document.getElementById('defaultBookStatus').value = settings.defaultBookStatus || 'want-to-read';
    document.getElementById('booksPerPage').value = settings.booksPerPage || '50';
    
    // Load theme
    const savedTheme = localStorage.getItem('bookThingyTheme') || 'dark';
    document.getElementById(savedTheme === 'light' ? 'themeLight' : 'themeDark').checked = true;
    
    // Load reading goal
    const currentYear = new Date().getFullYear();
    const goalKey = `goal${currentYear}`;
    document.getElementById('annualGoal').value = settings[goalKey] || '';
    
    // Update monthly preview
    const annual = parseInt(settings[goalKey]) || 0;
    document.getElementById('monthlyGoalPreview').textContent = Math.round(annual / 12);
    
    // Load other preferences
    document.getElementById('showReadingStreak').checked = settings.showReadingStreak || false;
    
    openModal('settingsModal');
}

function saveSettings() {
    try {
        showLoading('Saving settings...');
        
        // Get current year for goal
        const currentYear = new Date().getFullYear();
        const goalKey = `goal${currentYear}`;
        
        // Get settings from form
        const settings = {
            ...library.settings,
            defaultBookStatus: document.getElementById('defaultBookStatus').value,
            booksPerPage: document.getElementById('booksPerPage').value,
            [goalKey]: document.getElementById('annualGoal').value,
            showReadingStreak: document.getElementById('showReadingStreak').checked,
            lastUpdated: new Date().toISOString()
        };
        
        // Save theme separately to localStorage
        const selectedTheme = document.querySelector('input[name="theme"]:checked').value;
        applyTheme(selectedTheme);
        
        // Save to library
        library.settings = settings;
        saveLibrary();
        
        // Update stats if goal changed
        updateStats();
        
        closeModal('settingsModal');
        showToast('Settings Saved', 'Your preferences have been updated!', 'success');
        hideLoading();
    } catch (error) {
        console.error('Error saving settings:', error);
        showToast('Save Failed', 'Could not save settings. Please try again.', 'error');
        hideLoading();
    }
}

function clearAllData() {
    const confirmText = `Are you absolutely sure you want to delete ALL your books and data? This cannot be undone.

Type "DELETE ALL" to confirm:`;
    
    const userInput = prompt(confirmText);
    
    if (userInput === 'DELETE ALL') {
        try {
            showLoading('Clearing all data...');
            
            // Clear all data
            library = {
                books: [],
                settings: {
                    goal2025: null,
                    defaultBookStatus: 'want-to-read',
                    booksPerPage: '50'
                }
            };
            
            saveLibrary();
            renderLibrary();
            updateStats();
            
            closeModal('settingsModal');
            showToast('Data Cleared', 'All your books and data have been deleted.', 'warning');
            hideLoading();
        } catch (error) {
            console.error('Error clearing data:', error);
            showToast('Clear Failed', 'Could not clear data. Please try again.', 'error');
            hideLoading();
        }
    } else if (userInput !== null) {
        showToast('Cancelled', 'You must type "DELETE ALL" exactly to confirm.', 'info');
    }
}
    // Authentication state
let currentUser = null;

// Google Sign-In
document.getElementById('googleSignInBtn').addEventListener('click', async () => {
    try {
        showLoading('Signing in...');
        const provider = new firebase.auth.GoogleAuthProvider();
provider.setCustomParameters({
    prompt: 'select_account'
});
        const result = await auth.signInWithPopup(provider);
        currentUser = result.user;
        console.log('Signed in:', currentUser.email);
        closeModal('signInModal');
        showLoading('Loading your library...');
        await loadLibrary();
        renderLibrary();
        hideLoading();
} catch (error) {
        hideLoading();
        console.error('Sign-in error:', error);
        showToast('Sign-in Failed', 'Please try again or check your internet connection.', 'error');
    }
});

// Listen for authentication state changes
auth.onAuthStateChanged(async (user) => {
    if (user) {
        currentUser = user;
        console.log('User signed in:', user.email);
        
        // Show user info in header
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userInfo').style.display = 'flex';
        
// Load user's data and render
showLoading('Loading your library...');
await loadLibrary();

// Update the current view
const activeView = document.querySelector('.view.active').id;
if (activeView === 'libraryView') {
    renderLibrary();
} else if (activeView === 'statsView') {
    updateStats();
} else if (activeView === 'lendingView') {
    renderLending();
}
hideLoading();
    } else {
        currentUser = null;
        console.log('User signed out');
        
        // Hide user info in header
        document.getElementById('userInfo').style.display = 'none';
        
        // Clear local data and show sign-in modal
        library = { books: [], settings: { goal2025: null } };
        renderLibrary();
        openModal('signInModal');
        hideLoading(); // Ensure loading is hidden
    }
});

// Sign-out function
function signOut() {
    if (confirm('Are you sure you want to sign out?')) {
        auth.signOut().then(() => {
            console.log('User signed out successfully');
            showToast('Signed Out', 'You have been signed out successfully.', 'info');
        }).catch((error) => {
            console.error('Sign-out error:', error);
            showToast('Sign-out Failed', 'Could not sign out. Please try again.', 'error');
        });
    }
}

</script>
</body>
</html>